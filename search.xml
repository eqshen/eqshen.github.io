<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>å…³äºæˆ‘</title>
    <url>/2020/03/22/sys-aboutMe/</url>
    <content><![CDATA[<p><code>The more you know,the more you don&#39;t know.</code></p>
<h1 id="Hello-this-is-EQShen"><a href="#Hello-this-is-EQShen" class="headerlink" title="Hello, this is EQShen"></a>Hello, this is EQShen</h1><br/>

<h3 id="ä¸€ä¸ªåœ¨äº’è”ç½‘è‹Ÿä¸”å·ç”Ÿçš„ç¨‹åºå‘˜ï¼ŒThatâ€™s-all"><a href="#ä¸€ä¸ªåœ¨äº’è”ç½‘è‹Ÿä¸”å·ç”Ÿçš„ç¨‹åºå‘˜ï¼ŒThatâ€™s-all" class="headerlink" title="ä¸€ä¸ªåœ¨äº’è”ç½‘è‹Ÿä¸”å·ç”Ÿçš„ç¨‹åºå‘˜ï¼ŒThatâ€™s all -_-"></a>ä¸€ä¸ªåœ¨äº’è”ç½‘è‹Ÿä¸”å·ç”Ÿçš„ç¨‹åºå‘˜ï¼ŒThatâ€™s all -_-</h3><hr>
<h4 id="æ„å¿—äº§ç”Ÿå¸Œæœ›ï¼Œå¸Œæœ›å­•è‚²æ¢¦æƒ³ï¼Œæ¢¦æƒ³æ”¹å˜ä¸–ç•Œ"><a href="#æ„å¿—äº§ç”Ÿå¸Œæœ›ï¼Œå¸Œæœ›å­•è‚²æ¢¦æƒ³ï¼Œæ¢¦æƒ³æ”¹å˜ä¸–ç•Œ" class="headerlink" title="æ„å¿—äº§ç”Ÿå¸Œæœ›ï¼Œå¸Œæœ›å­•è‚²æ¢¦æƒ³ï¼Œæ¢¦æƒ³æ”¹å˜ä¸–ç•Œ"></a>æ„å¿—äº§ç”Ÿå¸Œæœ›ï¼Œå¸Œæœ›å­•è‚²æ¢¦æƒ³ï¼Œæ¢¦æƒ³æ”¹å˜ä¸–ç•Œ</h4><br/>

<h3 id="è”ç³»æˆ‘-x65-x71-115-104-x65-110-64-111-x75-116-108-111-x6f-107-46-99-111-x6d"><a href="#è”ç³»æˆ‘-x65-x71-115-104-x65-110-64-111-x75-116-108-111-x6f-107-46-99-111-x6d" class="headerlink" title="è”ç³»æˆ‘: &#x65;&#x71;&#115;&#104;&#x65;&#110;&#64;&#111;&#x75;&#116;&#108;&#111;&#x6f;&#107;&#46;&#99;&#111;&#x6d;"></a>è”ç³»æˆ‘: <a href="mailto:&#x65;&#x71;&#115;&#104;&#x65;&#110;&#64;&#111;&#x75;&#116;&#108;&#111;&#x6f;&#107;&#46;&#99;&#111;&#x6d;">&#x65;&#x71;&#115;&#104;&#x65;&#110;&#64;&#111;&#x75;&#116;&#108;&#111;&#x6f;&#107;&#46;&#99;&#111;&#x6d;</a></h3><br/>
<br/>
<br/>
<br/>
<br/>
<br/>]]></content>
      <categories>
        <category>ç³»ç»Ÿ</category>
        <category>ç³»ç»Ÿ-å…³äº</category>
        <category>äºŒçº§åˆ†ç±»demo</category>
        <category>å…³äº</category>
        <category>about</category>
      </categories>
      <tags>
        <tag>å…³äº</tag>
      </tags>
  </entry>
  <entry>
    <title>æœ¬åšå®¢æ„å»ºæŒ‡å—</title>
    <url>/2020/03/22/construction-guide/</url>
    <content><![CDATA[<h1 id="hexoåšå®¢æ­å»º"><a href="#hexoåšå®¢æ­å»º" class="headerlink" title="hexoåšå®¢æ­å»º"></a>hexoåšå®¢æ­å»º</h1><h3 id="1-ç¯å¢ƒæ­å»º"><a href="#1-ç¯å¢ƒæ­å»º" class="headerlink" title="1 ç¯å¢ƒæ­å»º"></a>1 ç¯å¢ƒæ­å»º</h3><ul>
<li><p>node.js å»å®˜ç½‘ä¸‹è½½å®‰è£…å³å¯</p>
</li>
<li><p>é»˜è®¤å…¨å±€å®‰è£…</p>
<p><code> npm install -g hexo-cli</code></p>
</li>
<li><p>Git å®‰è£…</p>
</li>
</ul>
<h3 id="2-åˆ›å»ºé¡¹ç›®-eqshen-github-io"><a href="#2-åˆ›å»ºé¡¹ç›®-eqshen-github-io" class="headerlink" title="2 åˆ›å»ºé¡¹ç›®  eqshen.github.io"></a>2 åˆ›å»ºé¡¹ç›®  eqshen.github.io</h3><p>åˆ›å»ºå‘½ä»¤å¹¶å®‰è£…ä¾èµ–</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo init eqshen.github.io</span><br><span class="line">cd eqshen.github.io</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>

<h3 id="3-ä¸‹è½½ä¸»é¢˜"><a href="#3-ä¸‹è½½ä¸»é¢˜" class="headerlink" title="3 ä¸‹è½½ä¸»é¢˜"></a>3 ä¸‹è½½ä¸»é¢˜</h3><p>è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ¨¡æ¿æ˜¯ <a href="https://github.com/Shen-Yu/hexo-theme-ayer%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%E8%BF%99%E9%87%8C%E9%9D%A2%E7%9A%84%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B%E3%80%82">https://github.com/Shen-Yu/hexo-theme-ayerï¼Œä¹Ÿå¯ä»¥å‚è€ƒè¿™é‡Œé¢çš„å®‰è£…æ•™ç¨‹ã€‚</a></p>
<p>åœ¨ eqshen.github.ioç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤,æŠŠä¸»é¢˜ä¸‹è½½ä¸‹æ¥</p>
<p><code>git clone https://github.com/Shen-Yu/hexo-theme-ayer.git themes/ayer</code></p>
<p>ç„¶åæ›´æ–°ä¸»é¢˜(åˆšä¸‹è½½ä¸‹æ¥åº”è¯¥æ˜¯æœ€æ–°çš„ï¼Œæ„Ÿè§‰è¿™æ­¥å¯æœ‰å¯æ— )</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd themes&#x2F;ayer</span><br><span class="line">git pull</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¿®æ”¹é…ç½®ï¼Œeqshen.github.io/_config.yml</p>
<p><code>theme: ayer</code></p>
<h3 id="4-å®‰è£…å¿…é¡»æ’ä»¶"><a href="#4-å®‰è£…å¿…é¡»æ’ä»¶" class="headerlink" title="4 å®‰è£…å¿…é¡»æ’ä»¶"></a>4 å®‰è£…å¿…é¡»æ’ä»¶</h3><ul>
<li>æœç´¢æ’ä»¶</li>
</ul>
<p><code>npm install hexo-generator-searchdb --save</code></p>
<p>ç„¶ååœ¨æ ¹ç›®å½•ä¸‹ _config.ymlä¸­æ·»åŠ ä»¥ä¸‹é…ç½®</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># hexo-generator-searchdb</span><br><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br><span class="line">  format: html</span><br></pre></td></tr></table></figure>

<ul>
<li>RSSæ’ä»¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-feed --save</span><br></pre></td></tr></table></figure>

<p>åŒæ ·å°†ä¸‹é¢ä»£ç å¤åˆ¶åˆ°ä½ é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ _config.ymlä¸­</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">feed:</span><br><span class="line">    type: atom</span><br><span class="line">    path: atom.xml</span><br><span class="line">    limit: 20</span><br><span class="line">    hub:</span><br><span class="line">    content:</span><br><span class="line">    content_limit: 140</span><br><span class="line">    content_limit_delim: &#39; &#39;</span><br><span class="line">    order_by: -date</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·é¡¹ç›®çš„åŸºæœ¬æ’ä»¶å°±å®‰è£…å®Œæ¯•ï¼Œè€Œä¸”ä¾èµ–ä¿¡æ¯éƒ½ä¼šè‡ªåŠ¨åŠ å…¥åˆ°ä½ é¡¹ç›®æ ¹ç›®ä¸‹çš„package.jsonä¸­ï¼Œä¸‹æ¬¡ç›´æ¥npm installå°±å¯ä»¥äº†ï¼ˆnodejsåŒ…ç®¡ç†~~ï¼‰</p>
<h3 id="5-æ·»åŠ èœå•"><a href="#5-æ·»åŠ èœå•" class="headerlink" title="5 æ·»åŠ èœå•"></a>5 æ·»åŠ èœå•</h3><p>ç”±äºä½¿ç”¨äº†ä¸»é¢˜theme,æ‰€ä»¥ä¿®æ”¹èœå•åº”è¯¥åœ¨ theme/ayer/_config.ymlä¸­ä¿®æ”¹ï¼Œä¸»é¡µçš„æ ‡é¢˜å‰¯æ ‡é¢˜ç­‰éƒ½æ˜¯æ”¹è¿™é‡Œ</p>
<p>ä¿®æ”¹ä¸‹é¢è¿™æ®µä»£ç å¯¹åº”çš„å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">menu:</span><br><span class="line">  ä¸»é¡µ: &#x2F;</span><br><span class="line">  å½’æ¡£: &#x2F;archives</span><br><span class="line">  åˆ†ç±»: &#x2F;categories</span><br><span class="line">  æ ‡ç­¾: &#x2F;tags</span><br><span class="line">  å…³äºæˆ‘: &#x2F;sys&#x2F;aboutMe</span><br></pre></td></tr></table></figure>

<p>/archivesæ˜¯é»˜è®¤çš„ä¸éœ€è¦æ”¹ï¼Œ/categoriesåº”è¯¥å¯¹åº”ä½ é¡¹ç›®ä¸‹<code>/source/categories/</code> ç›®å½•ï¼Œè¿™æ—¶ä½ ä¼šå‘ç°ç›®å½•æ ¹æœ¬ä¸å­˜åœ¨ï¼Œå’‹æ•´ï¼Ÿç›˜å®ƒã€‚</p>
<p>æ‰§è¡Œå‘½ä»¤åˆ›å»ºç›®å½•,å‘½ä»¤è¡Œæ‰§è¡Œå‰åº”è¯¥è¦åˆ‡æ¢åˆ°ä½ é¡¹ç›®çš„ï¼ˆæ ¹ï¼‰ç›®å½•ï¼Œæˆ‘è¿™é‡Œæ˜¯ <code>cd ~/workspace/eqshen.github.io/</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo new page categories</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¿®æ”¹é…ç½®  source/categories/index.mdä¸­çš„å†…å®¹ï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">type: &quot;categories&quot;</span><br><span class="line">layout: &quot;categories&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>



<p>ç„¶åå†åŒæ ·ç”Ÿæˆtagç›®å½•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo new page tags</span><br></pre></td></tr></table></figure>

<p>åŒæ ·ä¿®æ”¹é…ç½®  source/tags/index.mdå†…å®¹ï¼Œæ›¿æ¢ä¸ºä¸‹é¢å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">layout: &quot;tags&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>



<p>è¿™æ ·å°±å¤§åŠŸå‘Šæˆï¼Œè¿™é‡Œä½ å¯èƒ½ä¼šç–‘é—®ï¼Œä¸Šé¢çš„å‘½ä»¤æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿhexoåˆ›å»ºæ–‡ç« ã€ç›®å½•ã€tagç­‰æ˜¯ä¸ç”¨ä½  â€˜å³é”®-&gt;æ–°å»ºæ–‡ä»¶â€™è¿™ç§æ“ä½œçš„ï¼Œåªéœ€è¦æ‰§è¡Œå…·ä½“çš„å‘½ä»¤ï¼Œå°±å¯ä»¥æ›¿ä»£ä¸Šè¿°æ“ä½œï¼Œå…·ä½“æœ‰å“ªäº›å‘½ä»¤å¯ä»¥çœ‹è¿™é‡Œ ï¼š<a href="https://hexo.io/zh-cn/docs/commands">æŒ‡ä»¤</a></p>
<h3 id="6-æœ¬åœ°å¯åŠ¨"><a href="#6-æœ¬åœ°å¯åŠ¨" class="headerlink" title="6 æœ¬åœ°å¯åŠ¨"></a>6 æœ¬åœ°å¯åŠ¨</h3><p>å‘½ä»¤<code>hexo server</code></p>
<p>ç„¶åå°±å¯ä»¥åˆ° localhost:4000 æŸ¥çœ‹äº†</p>
<h3 id="7-éƒ¨ç½²"><a href="#7-éƒ¨ç½²" class="headerlink" title="7 éƒ¨ç½²"></a>7 éƒ¨ç½²</h3><p>æœ¬æ¬¡çš„åšå®¢åŒ…æ‹¬è¯„è®ºï¼ˆgitalkï¼‰éƒ½ä¸Šæ”¾åœ¨githubä»“åº“é‡Œçš„ï¼ˆå…è´¹çš„ï¼‰ï¼Œéƒ¨ç½²æ–¹å¼å¯ä»¥é‡‡ç”¨hexoå®˜æ–¹æ¨èçš„travisã€‚ä¸è¿‡æˆ‘é‡‡ç”¨äº† GitHub Actionçš„æ–¹å¼ï¼Œåšå®¢æºç æ”¾åœ¨ä»“åº“<a href="https://github.com/eqshen/eqshen.github.io">eqshen.github.io</a>çš„developåˆ†æ”¯ä¸Šï¼Œç¼–è¯‘åçš„å‰ç«¯ä»£ç æ”¾åœ¨è¯¥ä»“åº“çš„masteråˆ†æ”¯ã€‚Github Actionçš„è„šæœ¬ç›‘å¬çš„æ˜¯depåˆ†æ”¯ï¼Œå³æ¯æ¬¡æ›´æ–°å®Œåšå®¢ï¼ŒæŠŠæºç æ¨é€åˆ°depåˆ†æ”¯ï¼Œåšå®¢å°±ä¼šè‡ªåŠ¨ç¼–è¯‘å¹¶éƒ¨ç½²ã€‚é…ç½®æ­¥éª¤å¦‚ä¸‹</p>
<ol>
<li><p>å‰æè¦åˆ›å»ºå¥½è‡ªå·±çš„ä»“åº“ xxx.github.ioï¼Œå…¶ä¸­xxxå°±æ˜¯githubç”¨æˆ·åï¼Œå¦‚æœè¿˜æ²¡äº†è§£è¿‡ï¼Œå…ˆå»ç™¾åº¦å§ï¼Œå…³é”®å­—ï¼šGithub Pageã€‚</p>
</li>
<li><p>åœ¨ä»“åº“çš„Actionsæ ‡ç­¾é¡µä¸‹ç‚¹å‡»<code>New workflow</code>åˆ›å»ºè‡ªåŠ¨éƒ¨ç½²è„šæœ¬ï¼Œç„¶åç‚¹å‡»å³ä¸Šè§’ <code>skip this:Set up a workflow yourself</code>ï¼Œç„¶åå°±ä¸Šå†™è„šæœ¬äº†ï¼Œå†™å¥½è„šæœ¬ç‚¹å³ä¸Šè§’ <code>Start Commit</code>æŒ‰é’®å°±ä¼šåœ¨ä½ é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ç”Ÿæˆ.githubæ–‡ä»¶å¤¹å’Œç›¸å…³æ–‡ä»¶ã€‚</p>
</li>
<li><p>ä¸Šé¢çš„è„šæœ¬å½“ç„¶ä¸ç”¨è‡ªå·±å†™ï¼Œç«™åœ¨å·¨äººè‚©è†€ä¸Šï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨çš„æ˜¯  <a href="renzhaosy/hexo-deploy-action">renzhaosy/hexo-deploy-action</a>ã€‚å½“ç„¶ï¼Œå¦‚æœä½ çœ‹äº†è¿˜æ˜¯ä¸æ‡‚ï¼Œä½ å¯ä»¥ç›´æ¥å¤åˆ¶æˆ‘çš„è„šæœ¬ï¼ˆæˆ‘å‹‰å¼ºè®©ä½ è¸©ä¸€ä¸‹æˆ‘çš„è‚©è†€~~ï¼‰, å¦‚æœä½ æœ‰æƒ³æ³•ï¼Œæ¯”å¦‚ç›‘å¬çš„åˆ†æ”¯ä¸æ˜¯<code>dep</code>ä½ å¯ä»¥è‡ªå·±æ”¹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name: Build and Deploy</span><br><span class="line">on:</span><br><span class="line">  push:</span><br><span class="line">    branches:</span><br><span class="line">      - dep</span><br><span class="line">jobs:</span><br><span class="line">  build-and-deploy:</span><br><span class="line">    runs-on: ubuntu-latest</span><br><span class="line">    steps:</span><br><span class="line">    - name: Checkout</span><br><span class="line">      uses: actions&#x2F;checkout@master</span><br><span class="line"></span><br><span class="line">    - name: Build and Deploy</span><br><span class="line">      uses: renzhaosy&#x2F;hexo-deploy-action@master</span><br><span class="line">      env:</span><br><span class="line">        PERSONAL_TOKEN: $&#123;&#123; secrets.ACCESS_TOKEN &#125;&#125;</span><br><span class="line">        PUBLISH_REPOSITORY: eqshen&#x2F;eqshen.github.io # The repository the action should deploy to.</span><br><span class="line">        BRANCH: master  # The branch the action should deploy to.</span><br><span class="line">        PUBLISH_DIR: .&#x2F;public # The folder the action should deploy.</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ°è¿™ä½ å°±å¿«æˆåŠŸäº†ï¼Œæ¥ä¸‹æ¥ç»™ä¸Šé¢è„šæœ¬ åˆ›å»º access_tokenï¼ˆä¸ç„¶ä½ çš„è„šæœ¬å¯æ²¡æœ‰æƒé™åŠ¨ä½ ä»“åº“çš„ä»£ç ï¼‰ï¼Œçœ‹åˆ°ä¸Šé¢è„šæœ¬é‡Œçš„ <code>$&#123;&#123; secrets.ACCESS_TOKEN &#125;&#125;</code>äº†å—ï¼Ÿåƒä¸åƒå ä½ç¬¦ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™ç­‰å¾…è¢«æ›¿æ¢å‘¢ï¼</p>
<ul>
<li>ç‚¹å‡»ä½ githubä¸»é¡µå³ä¸Šè§’çš„å¤´åƒï¼Œå†ç‚¹å‡»Settingï¼Œè¿›å…¥è®¾ç½®ã€‚</li>
<li>ç‚¹å‡»å·¦ä¾§èœå•æ æœ€åä¸€é¡¹ <code>Develop Settings</code></li>
<li>ç„¶åç‚¹å‡» <code>Personal access token</code></li>
<li>å†ç‚¹å‡» <code>Generate new token</code>ï¼Œç„¶åæŒ‰éœ€æ±‚å‹¾é€‰èµ‹äºˆæƒé™ï¼ˆç†è®ºä¸Šåªè¦å‹¾repoå°±è¡Œäº†ï¼Œåæ­£æˆ‘é™¤äº†deleteçš„éƒ½å‹¾äº†ï¼‰</li>
<li>æœ€ååº”è¯¥æ˜¯ç‚¹å‡»æœ€ä¸‹é¢çš„<code>Generate Token</code>, ç„¶åä½ å°±ä¼šæ‹¿åˆ°ä¸€ä¸ª access_tokenï¼Œå¤åˆ¶è¿™ä¸ªtoken,é¡µé¢å…ˆåˆ«å…³ï¼Œå…³äº†è¿™ä¸ªtokenå°±æ‰¾ä¸åˆ°äº†,æ‹¿åˆ°è¿™ä¸ªtokenä¹‹åå¹¶ä¸æ˜¯å»æ›¿æ¢ä¸Šé¢è„šæœ¬é‡Œçš„<code>secrets.ACCESS_TOKEN</code></li>
<li>æµè§ˆå™¨æ–°æ‰“å¼€ä¸€ä¸ªæ ‡ç­¾é¡µï¼Œè¿›å…¥ä½ ä»“åº“çš„ä¸»é¡µ  xxx.github.ioã€‚ç‚¹å‡»ä»“åº“çš„çš„Settingsï¼Œç„¶åå†ç‚¹å‡»<code>Secrets</code> -&gt; <code>Add a new secret</code>, Nameå¡« <code>ACCESS_TOKEN</code>ï¼ˆè·Ÿè„šæœ¬é‡Œçš„è¦ä¸€è‡´ï¼Œæ‡‚äº†å§ï¼Ÿä½ ä»”ç»†å“ï¼‰ï¼ŒValueå¡«ä¸Šé¢ç”Ÿæˆçš„è®©ä½ å¤åˆ¶çš„é‚£ä¸ª <code>access_token</code>ï¼Œç„¶åç‚¹å‡»ç¡®å®šã€‚</li>
<li>æœ€åä½ å¾€ä½ è„šæœ¬ç›‘å¬çš„åˆ†æ”¯æ¨é€æºä»£ç ï¼Œç„¶åç‚¹å‡» <code>Actions</code> æŸ¥çœ‹æ„å»ºæ—¥å¿—å§ï¼Œå¯èƒ½è¦ä¸€åˆ†é’Ÿæ‰èƒ½æ„å»ºå¥½ã€‚</li>
</ul>
</li>
<li><p>åˆ°æ­¤éƒ¨ç½²ç»“æŸï¼Œè¿˜æ²¡å¼„å›¾åºŠï¼Œæœ‰ç©ºæŠŠä¸Šé¢å‡ ä¸ªå…³é”®æ­¥éª¤çš„å›¾é…äº†~~ï¼Œæœ‰é—®é¢˜æ¬¢è¿ä¸‹æ–¹ç•™è¨€äº¤æµã€‚</p>
</li>
</ol>
]]></content>
      <categories>
        <category>ç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>hexoåšå®¢</tag>
        <tag>æ„å»ºæŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸€æ¬¡Httpæœªè®¾ç½®è¶…æ—¶å¯¼è‡´çš„çº¿ç¨‹å‡æ­»é˜»å¡</title>
    <url>/2020/04/11/http-thread-block-problem/</url>
    <content><![CDATA[<h2 id="æ•…äº‹å¼€å§‹"><a href="#æ•…äº‹å¼€å§‹" class="headerlink" title="æ•…äº‹å¼€å§‹"></a>æ•…äº‹å¼€å§‹</h2><p>æŸä¸€å¤©ï¼Œæˆ‘æ­£åœ¨å¼€å¼€å¿ƒå¿ƒçš„å†™BUGï¼Œçªç„¶å·¥ä½œç¾¤é‡Œ @è‹Ÿä¸”å·ç”Ÿçš„BUGçŒ¿â€¦.æˆ‘ä¸€çœ‹ï¼Œè¿™ä¸æ˜¯æˆ‘å˜›ï¼Œå†ä¸€çœ‹é—®é¢˜ï¼šxxxè¿™ç¬”è®¢å•æ€ä¹ˆæµç¨‹èµ°åˆ°ä¸€åŠå°±ç»ˆæ­¢äº†ï¼Ÿå¿«çœ‹çœ‹æ˜¯å•¥é—®é¢˜ã€‚</p>
<h2 id="åˆæ­¥æ’æŸ¥"><a href="#åˆæ­¥æ’æŸ¥" class="headerlink" title="åˆæ­¥æ’æŸ¥"></a>åˆæ­¥æ’æŸ¥</h2><p>æˆ‘ä¸€çœ‹è¿™é—®é¢˜ï¼Œéš¾é“æŠ¥é”™äº†ï¼Ÿæ²¡æ”¶åˆ°é¢„è­¦å•Šâ€¦è¿…é€Ÿæ‰“å¼€ç”Ÿäº§æ—¥å¿—ï¼Œä¸€é¡¿æ“ä½œ<code>cd ,ls,less,?,ctrl+c,ctrl+v,n</code>,ç»ˆäºæ‰¾åˆ°è¿™ç¬”è®¢å•çš„é—è¨€ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Order-xxxxx007 å¼€å§‹å¤„ç†</span><br><span class="line"> ...</span><br><span class="line">Order-xxxxx007 é£é™©è¯„ä¼° ....</span><br><span class="line">...</span><br><span class="line">Order-xxxxx007 è°ƒç”¨Third-Api-Xæ¥å£</span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰<code>Exception</code> ï¼ŒæƒŠå–œä¸ï¼Ÿæ„å¤–ä¸ï¼Ÿæœæ–­æ‰“å¼€åƒé¥­å·¥å…·IDEA,å®šä½åˆ°ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ExecutorService executorService = Executors.newCachedThreadPool();      </span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * ...æ­¤å¤„ç•¥å»nè¡Œbug</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">executorService.submit(() -&gt; &#123;</span><br><span class="line">	<span class="comment">//è°ƒç”¨ä¸‰æ–¹api X</span></span><br><span class="line">	invokeThirdApi();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//....</span></span><br></pre></td></tr></table></figure>

<p>è¿™ï¼Ÿé»‘äººæŠ¬æ£ºçš„èŠ‚å¥ï¼Œè¿™ä»€ä¹ˆé¬¼ï¼Ÿçº¿ç¨‹è·‘åˆ°ä¸€åŠæ­»äº†ï¼Ÿæ‰€æœ‰æµç¨‹ä¸­æ–­äº†ï¼Ÿæ€ä¹ˆä¼šè¿™æ ·ã€‚ã€‚ä¸€å¹…åŠ¨å›¾æ¸æ¸æ¸—é€åˆ°æˆ‘çš„è„‘æµ·é‡Œâ€¦</p>
<img src="https://i.loli.net/2020/04/11/1APBuLXqSk49Ggh.gif" alt="é»‘äºº" style="zoom:67%;" />

<p>å†çœ‹ä¸‹invokeThirdAPiï¼Œå‘ç°é‡Œé¢å°±postJsonå‘é€äº†ä¸€ä¸ªhttpè¯·æ±‚ï¼Œä¸åº”è¯¥å•Šï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">postJson</span><span class="params">(String url,String data)</span></span>&#123;</span><br><span class="line">        HttpRequest httpRequest = cn.hutool.http.HttpUtil.createPost(url);</span><br><span class="line">        httpRequest.header(Header.CONTENT_TYPE,<span class="string">&quot;application/json;charset=UTF-8&quot;</span>).body(data);</span><br><span class="line">        HttpResponse response = httpRequest.execute();</span><br><span class="line">        <span class="keyword">return</span> response.body();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å’¦ï¼Ÿæ€ä¹ˆhttpè°ƒç”¨æ²¡æœ‰è¿”å›ç»“æœï¼Ÿhttpè¯·æ±‚æ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œç¬¬ä¸‰æ–¹æ¥å£å› ä¸ºæŸäº›å¼‚å¸¸åŸå› ä¸€ç›´æ²¡æœ‰è¿”å›ç»“æœï¼çº¿ç¨‹ä¸€ç›´è¢«å ç”¨é˜»å¡ï¼</p>
<h2 id="åˆæ­¥å¾—å‡ºçš„é”™è¯¯ç»“è®º"><a href="#åˆæ­¥å¾—å‡ºçš„é”™è¯¯ç»“è®º" class="headerlink" title="åˆæ­¥å¾—å‡ºçš„é”™è¯¯ç»“è®º"></a>åˆæ­¥å¾—å‡ºçš„é”™è¯¯ç»“è®º</h2><p>ä»”ç»†çœ‹äº†ä¸€ä¸‹ä¸­çš„çº¿ç¨‹idï¼š <code>[04-09 18:40:15,477] INFO [Thread-4-pool-1329] ...</code></p>
<p>å†çœ‹çœ‹ ä¸€å°æ—¶å‰çš„ï¼ˆä¸€å°æ—¶å‰å‘ç‰ˆæœåŠ¡é‡å¯è¿‡ï¼‰<code>[04-09 17:00:15,472] INFO [Thread-4-pool-10] ...</code></p>
<p>ä¸€ä¸ªå°æ—¶çº¿ç¨‹idä»10åˆ°1300+ï¼ŒæŒ‰ç…§ç°åœ¨çš„qpsï¼Œ50ä¸ªçº¿ç¨‹éƒ½åƒä¸å®Œå•Šï¼Œé˜»å¡è¿™ä¹ˆå¤šçº¿ç¨‹ï¼Ÿææ…Œï¼Œæ‹…å¿§ğŸ˜Ÿï¼Œä¸çŸ¥é“é»‘äººæŠ¬æ£ºè´¹ç”¨é«˜ä¸é«˜ï¼Œç»™è‡ªå·±ä¹Ÿé¢„çº¦ä¸€ä¸ªå§â€¦.</p>
<p>##çœŸæ­£çš„åŸå› </p>
<p><code>.......few minutes later........</code></p>
<p>æ­£åœ¨æ”¶æ‹¾è¡Œæçš„æˆ‘ï¼ˆåˆ«é—®ï¼Œé—®å°±æ˜¯è·‘è·¯ï¼‰ï¼Œä¸å¯¹å•Šï¼Œæˆ‘ç”¨çš„æ˜¯ <code>Executors.newCachedThreadPool()</code>,é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ç©ºé—²äº†ä¼šé”€æ¯çš„å§ï¼Ÿæ­£å¸¸é”€æ¯äº†å†newå‡ºæ¥ï¼Œçº¿ç¨‹idæ˜¯ä¼šè‡ªå¢çš„å§ï¼Ÿï¼Ÿï¼Ÿä¸Šæºç ï¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                      <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">             Executors.defaultThreadFactory(), defaultHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                              RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">            maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">            maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">            keepAliveTime &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">if</span> (workQueue == <span class="keyword">null</span> || threadFactory == <span class="keyword">null</span> || handler == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">        <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">        <span class="keyword">this</span>.workQueue = workQueue;</span><br><span class="line">        <span class="keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">        <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">        <span class="keyword">this</span>.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ï¼Ÿè¿™äº›å‚æ•°å¥½ç†Ÿæ‚‰åˆå¥½é™Œç”Ÿå•Šã€‚ã€‚ã€‚å¥½å§ï¼Œæ‹¿èµ·çš„æˆ‘å°æœ¬æœ¬æ‰¾æ‰¾â€¦å—¯ï¼Œæœ‰äº†ã€‚</p>
<ul>
<li><p>int corePoolSize  è¯¥çº¿ç¨‹æ± ä¸­<strong>æ ¸å¿ƒçº¿ç¨‹æ•°æœ€å¤§å€¼</strong></p>
<blockquote>
<p>æ ¸å¿ƒçº¿ç¨‹ï¼Œæ— è®ºæœ‰æ²¡æœ‰ä»»åŠ¡ï¼Œéƒ½ä¸ä¼šè¢«é”€æ¯ï¼ˆå›½ä¼å¾…é‡å•Šï¼‰ï¼Œå½“ç„¶ï¼Œè®¾ç½®äº†allowCoreThreadTimeOut(true)ä¹‹åï¼Œä¹Ÿæ˜¯å¯ä»¥è¢«é”€æ¯çš„ã€‚</p>
</blockquote>
</li>
<li><p>int maximumPoolSize è¯¥çº¿ç¨‹æ± ä¸­<strong>çº¿ç¨‹æ€»æ•°æœ€å¤§å€¼</strong> </p>
<blockquote>
<p>è¯¥å€¼ç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°é‡ + éæ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€‚</p>
</blockquote>
</li>
<li><p>long keepAliveTime <strong>éæ ¸å¿ƒçº¿ç¨‹é—²ç½®è¶…æ—¶æ—¶é•¿</strong></p>
</li>
<li><p>TimeUnit unit  keepAliveTimeçš„å•ä½</p>
</li>
<li><p>BlockingQueue workQueue é˜»å¡é˜Ÿåˆ—ï¼Œç»´æŠ¤ç€<strong>ç­‰å¾…æ‰§è¡Œçš„Runnableä»»åŠ¡å¯¹è±¡</strong>,ä¹Ÿå°±æ˜¯ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<p>æœ‰ä»¥ä¸‹å‡ ç§å®ç°</p>
<ul>
<li>LinkedBlockingQueue</li>
<li>ArrayBlockingQueue</li>
<li>SynchronousQueue  åŒæ­¥é˜Ÿåˆ—ï¼Œå†…éƒ¨å®¹é‡ä¸º0ï¼Œæ¯ä¸ªputæ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œåä¹‹äº¦ç„¶</li>
<li>DelayQueue å»¶è¿Ÿé˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ä¸­çš„å…ƒç´ åªæœ‰å½“å…¶æŒ‡å®šçš„å»¶è¿Ÿæ—¶é—´åˆ°äº†ï¼Œæ‰èƒ½å¤Ÿä»é˜Ÿåˆ—ä¸­è·å–åˆ°è¯¥å…ƒç´  </li>
</ul>
</li>
<li><p>ThreadFactory threadFactory åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ ï¼Œç”¨äºæ‰¹é‡åˆ›å»ºçº¿ç¨‹ã€‚</p>
</li>
<li><p>RejectedExecutionHandler handler æ‹’ç»ç­–ç•¥ï¼Œæ­¤å¤„ä¸å±•å¼€</p>
</li>
</ul>
<p>æ›´å¤šå…³äºçº¿ç¨‹æ± çš„èµ„æ–™ çœ‹è¿™é‡Œ <a href="https://redspider.gitbook.io/concurrent/di-san-pian-jdk-gong-ju-pian/12">gitbook-çº¿ç¨‹æ± </a></p>
<p>ç„¶åï¼Œå’±ä»¬å†å›å¤´çœ‹çœ‹ newCachedThreadPoolï¼Œè¿™æ˜¯äººå¹²çš„äº‹å—ï¼Ÿ</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 0</li>
<li>éæ ¸å¿ƒçº¿ç¨‹æ•°ä¸é™ï¼Œä½†å­˜æ´»æ—¶é—´  60 ç§’</li>
</ul>
<p>é‚£ä¹ˆä¸Šé¢è¿™äº›å‚æ•°åˆ°åº•æ˜¯æ€ä¹ˆè¿è½¬çš„å‘¢ï¼Ÿçœ‹å›¾</p>
<img src="https://i.loli.net/2020/04/11/e3y69UpSxah1nu4.jpg" alt="æµç¨‹å›¾" style="zoom:80%;" />



<p>å†çœ‹ä¸‹ ThreadFactory <code>Executors.defaultThreadFactory()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger poolNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ThreadGroup group;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger threadNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</span><br><span class="line"></span><br><span class="line">        DefaultThreadFactory() &#123;</span><br><span class="line">            SecurityManager s = System.getSecurityManager();</span><br><span class="line">            group = (s != <span class="keyword">null</span>) ? s.getThreadGroup() :</span><br><span class="line">                                  Thread.currentThread().getThreadGroup();</span><br><span class="line">            namePrefix = <span class="string">&quot;pool-&quot;</span> +</span><br><span class="line">                          poolNumber.getAndIncrement() +</span><br><span class="line">                         <span class="string">&quot;-thread-&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">            Thread t = <span class="keyword">new</span> Thread(group, r,</span><br><span class="line">                                  namePrefix + threadNumber.getAndIncrement(),</span><br><span class="line">                                  <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (t.isDaemon())</span><br><span class="line">                t.setDaemon(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY)</span><br><span class="line">                t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>Thread t = new Thread(group, r,namePrefix + threadNumber.getAndIncrement(),0);</code></p>
<p>æ‰€ä»¥ï¼šæ­£å¸¸çš„é”€æ¯åˆ›å»ºä¹Ÿä¼šidè‡ªå¢ï¼Œè¿™æˆ‘å°±æ”¾å¿ƒäº†ã€‚ã€‚ã€‚</p>
<h3 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><ul>
<li><p>è®¾ç½®httpè¶…æ—¶</p>
</li>
<li><p>æ›´æ¢è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼ˆå®šåˆ¶åŒ–çš„æ‰æ˜¯æœ€å¥½çš„ï¼‰</p>
<p>ThreadPoolTaskExecutor æ˜¯springæä¾›çš„ï¼Œæ˜¯å¯¹ ThreadPoolExecutorçš„å°è£…ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean(&quot;thirdApiExecutor&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">thirdApiExecutor</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ThreadPoolTaskExecutor taskExecutor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">    taskExecutor.setCorePoolSize(<span class="number">20</span>);</span><br><span class="line">    taskExecutor.setMaxPoolSize(<span class="number">40</span>);</span><br><span class="line">    taskExecutor.setKeepAliveSeconds(<span class="number">300</span>);</span><br><span class="line">    taskExecutor.setAllowCoreThreadTimeOut(<span class="keyword">true</span>);</span><br><span class="line">    taskExecutor.setWaitForTasksToCompleteOnShutdown(<span class="keyword">true</span>);</span><br><span class="line">    taskExecutor.setAwaitTerminationSeconds(<span class="number">10</span>);</span><br><span class="line">    taskExecutor.setQueueCapacity(<span class="number">200</span>);</span><br><span class="line">    taskExecutor.setThreadNamePrefix(<span class="string">&quot;ThirdApi-Executor-&quot;</span>);</span><br><span class="line">    taskExecutor.setRejectedExecutionHandler(<span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">    <span class="keyword">return</span> taskExecutor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><ul>
<li>çº¿ç¨‹å†…çš„ httpç­‰IOé˜»å¡è¡Œä¸ºä¸€å®šè¦è®¾ç½®timeoutã€‚</li>
<li>è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œæ ¹æ®ä¸šåŠ¡åœºæ™¯å’Œç‰¹ç‚¹è®¾ç½®å‚æ•°ã€‚</li>
<li>å¹³æ—¶åŸºæœ¬åŠŸè¦æ‰å®ï¼Œä¸ç„¶ç¿»å°æœ¬æœ¬ä¹ŸæŒºæµªè´¹æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯ç”Ÿäº§ç¯å¢ƒå‡ºé—®é¢˜äº†ï¼Œéƒ½æ˜¯æ¯”è¾ƒæ€¥çš„ï¼Œæ²¡æœ‰å¤šå°‘æ—¶é—´ç»™ä½ å»å­¦ä¹ å’ŒæŸ¥æ‰¾èµ„æ–™ï¼Œæ‰€ä»¥å¹³æ—¶è¦å¤šç§¯ç´¯ã€‚</li>
</ul>
<h2 id="åˆ°è¿™å°±å®Œäº†ï¼Ÿå°±è¿™ï¼Ÿ"><a href="#åˆ°è¿™å°±å®Œäº†ï¼Ÿå°±è¿™ï¼Ÿ" class="headerlink" title="åˆ°è¿™å°±å®Œäº†ï¼Ÿå°±è¿™ï¼Ÿ"></a>åˆ°è¿™å°±å®Œäº†ï¼Ÿå°±è¿™ï¼Ÿ</h2><p><strong>åˆ°ç°åœ¨ï¼Œæˆ‘è¿˜æœ‰ä¸€ä¸ªæœ€å¤§çš„ç–‘é—®ï¼šå¦‚ä½•ç¡®å®šç›®å‰ç”Ÿäº§ç¯å¢ƒæ˜¯å¦å­˜åœ¨è¢«æ°¸ä¹…é˜»å¡åœ¨IOä¸Šçš„çº¿ç¨‹ï¼Ÿ</strong></p>
<h2 id="Javaçº¿ç¨‹çŠ¶æ€"><a href="#Javaçº¿ç¨‹çŠ¶æ€" class="headerlink" title="Javaçº¿ç¨‹çŠ¶æ€"></a>Javaçº¿ç¨‹çŠ¶æ€</h2><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦çŸ¥é“ Javaçº¿ç¨‹åœ¨ç”Ÿå‘½å‘¨æœŸä¸­å­˜åœ¨å“ªäº›çŠ¶æ€äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Thread.State æºç </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    NEW,</span><br><span class="line">    RUNNABLE,</span><br><span class="line">    BLOCKED,</span><br><span class="line">    WAITING,</span><br><span class="line">    TIMED_WAITING,</span><br><span class="line">    TERMINATED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“æ¯ä¸ªçŠ¶æ€çš„æ„ä¹‰ä»¥åŠçŠ¶æ€çš„è½¬æ¢åœºæ™¯çœ‹è¿™é‡Œ <a href="https://redspider.gitbook.io/concurrent/di-yi-pian-ji-chu-pian/4">Javaçº¿ç¨‹çŠ¶æ€åŠä¸»è¦è½¬åŒ–æ–¹æ³•</a></p>
<h2 id="å¤ç°äº‹æ•…ç°åœº"><a href="#å¤ç°äº‹æ•…ç°åœº" class="headerlink" title="å¤ç°äº‹æ•…ç°åœº"></a>å¤ç°äº‹æ•…ç°åœº</h2><h3 id="å†æ¬¡åˆ†æ"><a href="#å†æ¬¡åˆ†æ" class="headerlink" title="å†æ¬¡åˆ†æ"></a>å†æ¬¡åˆ†æ</h3><p>æ–‡ä¸­ä¹Ÿå¤šæ¬¡æåˆ°â€é˜»å¡â€œå…³é”®å­—ï¼Œé‚£æ°¸ä¹…ç­‰å¾…Http å“åº”çš„é‚£ä¸ªçº¿ç¨‹åº”è¯¥æ˜¯ä»€ä¹ˆçŠ¶æ€å‘¢ï¼Ÿï¼Ÿé¦–å…ˆçŒœæƒ³æ˜¯<code>Blocked</code>,ä½†æŒ‰ç…§ç†è®ºæ¥è®²ï¼Œåªæœ‰ç­‰å¾…é”çš„çº¿ç¨‹æ‰ä¼šæ˜¯BlockedçŠ¶æ€ï¼Œä½¿ç”¨æ’é™¤æ³•ï¼Œæˆ‘æœ€ç»ˆçŒœæƒ³å®ƒæ˜¯<code>Runnable</code>çŠ¶æ€ï¼Œä¸‹é¢å°±æ¥è¯å®ä¸€ä¸‹ã€‚</p>
<h3 id="ä»£ç å¤ç°"><a href="#ä»£ç å¤ç°" class="headerlink" title="ä»£ç å¤ç°"></a>ä»£ç å¤ç°</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testThreadBlock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//æ¨¡æ‹Ÿè°ƒç”¨ä¸‰æ–¹api</span></span><br><span class="line">            invokeThirdApi();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ·»åŠ ä¸€ä¸ªå…¶ä»–ä»»åŠ¡</span></span><br><span class="line">        executorService.submit(()-&gt;&#123;</span><br><span class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">               log.info(<span class="string">&quot;çº¿ç¨‹ &#123;&#125; æ­£åœ¨å¹²æ´»&quot;</span>,Thread.currentThread().getName());</span><br><span class="line">               Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">				<span class="comment">//è®©ä¸»çº¿ç¨‹åœ¨æ­¤ä¼‘æ¯</span></span><br><span class="line">        Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">invokeThirdApi</span><span class="params">()</span></span>&#123;</span><br><span class="line">        InputStream is = System.in;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(is);</span><br><span class="line">        String threadName = Thread.currentThread().getName();</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125; IOè¾“å…¥å¼€å§‹&quot;</span>,threadName);</span><br><span class="line">        String input =  scanner.next();</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125; IOè¾“å…¥ç»“æŸï¼š&#123;&#125;&quot;</span>,threadName,input);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ç®€å•è§£é‡Šä¸€ä¸‹ä¸Šé¢ç¨‹åºï¼š</p>
<ul>
<li><p>åŸºäºjunitæµ‹è¯•çš„æ–¹å¼</p>
</li>
<li><p>testThreadBlockæ–¹æ³•ä¸­å®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ± <code>newCachedThreadPool</code>,ç„¶åå‘çº¿ç¨‹æ± æäº¤äº†ä¸¤ä¸ªä»»åŠ¡</p>
<ul>
<li>ç¬¬ä¸€ä¸ªæ˜¯ä¸€æ¬¡æ€§è°ƒç”¨ä¸‰æ–¹æ¥å£çš„ä»»åŠ¡</li>
<li>ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªé‡å¤æ‰§è¡Œçš„ä»»åŠ¡</li>
</ul>
</li>
<li><p>è°ƒç”¨ä¸‰æ–¹æ¥å£ï¼Œè¿™é‡Œä½¿ç”¨<code>Scanner</code>ç›‘å¬ç»ˆç«¯è¾“å…¥æ¥æ¨¡æ‹Ÿï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±æœ¬åœ°å¯ä¸€ä¸ªæµ‹è¯•é¡¹ç›®ï¼Œæš´éœ²ä¸€ä¸ªæ¥å£ï¼Œç„¶åæ¥å£é€»è¾‘ä¸­æ‰“ä¸ªæ–­ç‚¹ï¼Œè¿™æ ·åœ¨httpè¯·æ±‚çš„æ—¶å€™è¢«æ–­ç‚¹å¡ä½å°±è¡Œäº†ï¼‰</p>
</li>
</ul>
<p>çœ‹ä¸€ä¸‹ç¨‹åºè¿è¡Œçš„æ—¥å¿—ï¼š</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">14</span>:<span class="number">56</span><span class="variable">.852</span>  INFO <span class="number">27281</span> --- [pool-<span class="number">1</span>-thread-<span class="number">1</span>] com<span class="variable">.eqshen</span><span class="variable">.springdemo</span><span class="variable">.ThreadPoolTest</span>     : pool-<span class="number">1</span>-thread-<span class="number">1</span> IOè¾“å…¥å¼€å§‹</span><br><span class="line"><span class="number">2020</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">14</span>:<span class="number">56</span><span class="variable">.850</span>  INFO <span class="number">27281</span> --- [pool-<span class="number">1</span>-thread-<span class="number">2</span>] com<span class="variable">.eqshen</span><span class="variable">.springdemo</span><span class="variable">.ThreadPoolTest</span>     : çº¿ç¨‹ pool-<span class="number">1</span>-thread-<span class="number">2</span> æ­£åœ¨å¹²æ´»</span><br><span class="line"><span class="number">2020</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">14</span>:<span class="number">59</span><span class="variable">.858</span>  INFO <span class="number">27281</span> --- [pool-<span class="number">1</span>-thread-<span class="number">2</span>] com<span class="variable">.eqshen</span><span class="variable">.springdemo</span><span class="variable">.ThreadPoolTest</span>     : çº¿ç¨‹ pool-<span class="number">1</span>-thread-<span class="number">2</span> æ­£åœ¨å¹²æ´»</span><br><span class="line"><span class="number">2020</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">15</span>:<span class="number">02</span><span class="variable">.861</span>  INFO <span class="number">27281</span> --- [pool-<span class="number">1</span>-thread-<span class="number">2</span>] com<span class="variable">.eqshen</span><span class="variable">.springdemo</span><span class="variable">.ThreadPoolTest</span>     : çº¿ç¨‹ pool-<span class="number">1</span>-thread-<span class="number">2</span> æ­£åœ¨å¹²æ´»</span><br><span class="line"><span class="number">2020</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">15</span>:<span class="number">05</span><span class="variable">.865</span>  INFO <span class="number">27281</span> --- [pool-<span class="number">1</span>-thread-<span class="number">2</span>] com<span class="variable">.eqshen</span><span class="variable">.springdemo</span><span class="variable">.ThreadPoolTest</span>     : çº¿ç¨‹ pool-<span class="number">1</span>-thread-<span class="number">2</span> æ­£åœ¨å¹²æ´»</span><br><span class="line"><span class="number">2020</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">15</span>:<span class="number">08</span><span class="variable">.867</span>  INFO <span class="number">27281</span> --- [pool-<span class="number">1</span>-thread-<span class="number">2</span>] com<span class="variable">.eqshen</span><span class="variable">.springdemo</span><span class="variable">.ThreadPoolTest</span>     : çº¿ç¨‹ pool-<span class="number">1</span>-thread-<span class="number">2</span> æ­£åœ¨å¹²æ´»</span><br><span class="line"><span class="number">2020</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">15</span>:<span class="number">11</span><span class="variable">.870</span>  INFO <span class="number">27281</span> --- [pool-<span class="number">1</span>-thread-<span class="number">2</span>] com<span class="variable">.eqshen</span><span class="variable">.springdemo</span><span class="variable">.ThreadPoolTest</span>     : çº¿ç¨‹ pool-<span class="number">1</span>-thread-<span class="number">2</span> æ­£åœ¨å¹²æ´»</span><br><span class="line"><span class="number">2020</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">15</span>:<span class="number">14</span><span class="variable">.875</span>  INFO <span class="number">27281</span> --- [pool-<span class="number">1</span>-thread-<span class="number">2</span>] com<span class="variable">.eqshen</span><span class="variable">.springdemo</span><span class="variable">.ThreadPoolTest</span>     : çº¿ç¨‹ pool-<span class="number">1</span>-thread-<span class="number">2</span> æ­£åœ¨å¹²æ´»</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°thread-1å¯åŠ¨ä¹‹åç›´æ¥å°±è¢«é˜»å¡äº†</p>
<h3 id="ä½¿ç”¨jstack"><a href="#ä½¿ç”¨jstack" class="headerlink" title="ä½¿ç”¨jstack"></a>ä½¿ç”¨jstack</h3><p>ä¸‹é¢å°±ä½¿ç”¨jstackæŸ¥çœ‹ä¸€ä¸‹çº¿ç¨‹çš„çœŸæ­£çŠ¶æ€</p>
<p>ä½¿ç”¨<code>jps</code>å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹id</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">27281 JUnitStarter</span><br><span class="line">20500</span><br><span class="line">27285 Jps</span><br><span class="line">26586 RemoteMavenServer</span><br><span class="line">27279 Launcher</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰§è¡Œå‘½ä»¤ <code>jstack 27281 &gt; test.jstack</code></p>
<p>åˆ° test.jstackä¸­é—´ä¸­æŒ‰ç…§å…³é”®å­—æœç´¢ <code>pool-1-thread-1</code>ä¼šæ‰¾åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&quot;pool-1-thread-1&quot; #19 prio=5 os_prio=31 cpu=2.46ms elapsed=215.35s tid=0x00007fddfabf0000 nid=0x6703 runnable  [0x0000700007286000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">        at java.io.FileInputStream.readBytes(java.base@<span class="number">11.0</span>.<span class="number">2</span>/Native Method)</span><br><span class="line">        at java.io.FileInputStream.read(java.base@<span class="number">11.0</span>.<span class="number">2</span>/FileInputStream.java:<span class="number">279</span>)</span><br><span class="line">        at java.io.BufferedInputStream.read1(java.base@<span class="number">11.0</span>.<span class="number">2</span>/BufferedInputStream.java:<span class="number">290</span>)</span><br><span class="line">        at java.io.BufferedInputStream.read(java.base@<span class="number">11.0</span>.<span class="number">2</span>/BufferedInputStream.java:<span class="number">351</span>)</span><br><span class="line">        - locked &lt;<span class="number">0x0000000700133178</span>&gt; (a java.io.BufferedInputStream)</span><br><span class="line">        at sun.nio.cs.StreamDecoder.readBytes(java.base@<span class="number">11.0</span>.<span class="number">2</span>/StreamDecoder.java:<span class="number">284</span>)</span><br><span class="line">        at sun.nio.cs.StreamDecoder.implRead(java.base@<span class="number">11.0</span>.<span class="number">2</span>/StreamDecoder.java:<span class="number">326</span>)</span><br><span class="line">        at sun.nio.cs.StreamDecoder.read(java.base@<span class="number">11.0</span>.<span class="number">2</span>/StreamDecoder.java:<span class="number">178</span>)</span><br><span class="line">        - locked &lt;<span class="number">0x000000070aa0fef0</span>&gt; (a java.io.InputStreamReader)</span><br><span class="line">        at java.io.InputStreamReader.read(java.base@<span class="number">11.0</span>.<span class="number">2</span>/InputStreamReader.java:<span class="number">185</span>)</span><br><span class="line">        at java.io.Reader.read(java.base@<span class="number">11.0</span>.<span class="number">2</span>/Reader.java:<span class="number">189</span>)</span><br><span class="line">        at java.util.Scanner.readInput(java.base@<span class="number">11.0</span>.<span class="number">2</span>/Scanner.java:<span class="number">882</span>)</span><br><span class="line">        at java.util.Scanner.next(java.base@<span class="number">11.0</span>.<span class="number">2</span>/Scanner.java:<span class="number">1476</span>)</span><br><span class="line">        at com.eqshen.springdemo.ThreadPoolTest.invokeThirdApi(ThreadPoolTest.java:<span class="number">44</span>)</span><br><span class="line">        at com.eqshen.springdemo.ThreadPoolTest.lambda$testThreadBlock$<span class="number">0</span>(ThreadPoolTest.java:<span class="number">25</span>)</span><br><span class="line">        at com.eqshen.springdemo.ThreadPoolTest$$Lambda$<span class="number">767</span>/<span class="number">0x0000000800568440.</span>run(Unknown Source)</span><br><span class="line">        at java.util.concurrent.Executors$RunnableAdapter.call(java.base@<span class="number">11.0</span>.<span class="number">2</span>/Executors.java:<span class="number">515</span>)</span><br><span class="line">        at java.util.concurrent.FutureTask.run$$$capture(java.base@<span class="number">11.0</span>.<span class="number">2</span>/FutureTask.java:<span class="number">264</span>)</span><br><span class="line">        at java.util.concurrent.FutureTask.run(java.base@<span class="number">11.0</span>.<span class="number">2</span>/FutureTask.java)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@<span class="number">11.0</span>.<span class="number">2</span>/ThreadPoolExecutor.java:<span class="number">1128</span>)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@<span class="number">11.0</span>.<span class="number">2</span>/ThreadPoolExecutor.java:<span class="number">628</span>)</span><br><span class="line">        at java.lang.Thread.run(java.base@<span class="number">11.0</span>.<span class="number">2</span>/Thread.java:<span class="number">834</span>)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºçº¿ç¨‹çŠ¶æ€å’Œæˆ‘ä»¬çŒœæƒ³çš„æ˜¯ä¸€è‡´çš„ï¼šRUNNABLE</p>
<h3 id="é€’å½’æ‡µé€¼"><a href="#é€’å½’æ‡µé€¼" class="headerlink" title="é€’å½’æ‡µé€¼"></a>é€’å½’æ‡µé€¼</h3><p>é‚£ç°åœ¨å¦‚ä½•åœ¨èŒ«èŒ«ç¨‹æµ·ä¸­å®šä½åˆ°è¿™ç§é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿ</p>
<blockquote>
<p>â€œpool-1-thread-1â€ #19 prio=5 os_prio=31 cpu=2.46ms elapsed=215.35s tid=0x00007fddfabf0000 nid=0x6703 runnable  [0x0000700007286000]</p>
</blockquote>
<p>å¦‚æœå¤šæ¬¡æ‰§è¡Œjstackï¼Œå‘ç° <code>cpu=2.46ms</code> å€¼æ˜¯ä¸å˜çš„ï¼ˆIOé˜»å¡äº†ï¼Œæ°¸è¿œä¸ä¼šå†è¢«åˆ†é…åˆ°cpuæ—¶é—´ç‰‡ï¼Œå½“ç„¶ä¸å˜äº†ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ç›®å‰èƒ½æƒ³åˆ°çš„åŠæ³•â˜¹ï¸</p>
]]></content>
      <categories>
        <category>BUG</category>
        <category>çº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>çº¿ç¨‹</tag>
        <tag>HTTP</tag>
        <tag>BUG</tag>
      </tags>
  </entry>
  <entry>
    <title>å¸¸è§çš„ç¼“å­˜ç®—æ³•åŠåŠ¨æ‰‹å®ç°</title>
    <url>/2020/04/06/lru-lfu-cache/</url>
    <content><![CDATA[<h1 id="å¸¸è§çš„ç¼“å­˜ç®—æ³•åŠåŠ¨æ‰‹å®ç°"><a href="#å¸¸è§çš„ç¼“å­˜ç®—æ³•åŠåŠ¨æ‰‹å®ç°" class="headerlink" title="å¸¸è§çš„ç¼“å­˜ç®—æ³•åŠåŠ¨æ‰‹å®ç°"></a>å¸¸è§çš„ç¼“å­˜ç®—æ³•åŠåŠ¨æ‰‹å®ç°</h1><ul>
<li>FIFO å…ˆè¿›å…ˆå‡º - First In First Out.</li>
<li>LRU æœ€è¿‘æœ€å°‘ä½¿ç”¨ - Least Recently Used.</li>
<li>LFU æœ€ä¸ç»å¸¸ä½¿ç”¨ - Least Frequently Used.</li>
</ul>
<h3 id="FIFO"><a href="#FIFO" class="headerlink" title="FIFO"></a>FIFO</h3><ul>
<li>ä½¿ç”¨é˜Ÿåˆ—å®ç°ï¼Œæ–°å¢æ•°æ®ä»é˜Ÿå°¾æ’å…¥ï¼Œæ·˜æ±°æ•°æ®ä»é˜Ÿå¤´å‡ºé˜Ÿã€‚</li>
</ul>
<h3 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h3><h4 id="æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜â€"><a href="#æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜â€" class="headerlink" title="æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜â€"></a>æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜â€</h4><h4 id="ä¸€ä¸ªæ“ä½œdemo"><a href="#ä¸€ä¸ªæ“ä½œdemo" class="headerlink" title="ä¸€ä¸ªæ“ä½œdemo"></a>ä¸€ä¸ªæ“ä½œdemo</h4><ol>
<li><p>LRUCache cache = new LRUCache( 2 /* ç¼“å­˜å®¹é‡ */ );</p>
</li>
<li><p>cache.put(1, 1);</p>
</li>
<li><p>cache.put(2, 2);</p>
</li>
<li><p>cache.get(1);       // è¿”å›  1</p>
</li>
<li><p>cache.put(3, 3);    // è¯¥æ“ä½œä¼šä½¿å¾—key=2 ä½œåºŸ</p>
</li>
<li><p>cache.get(2);       // è¿”å› -1 (æœªæ‰¾åˆ°)</p>
</li>
<li><p>cache.put(4, 4);    // è¯¥æ“ä½œä¼šä½¿å¾—key=1 ä½œåºŸ</p>
</li>
<li><p>cache.get(1);       // è¿”å› -1 (æœªæ‰¾åˆ°)</p>
</li>
<li><p>cache.get(3);       // è¿”å›  3</p>
</li>
<li><p>cache.get(4);       // è¿”å›  4</p>
</li>
</ol>
<h4 id="å¦‚ä½•å®ç°è¿™æ ·ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Ÿä¸€ä¸ªé«˜æ•ˆçš„ç¼“å­˜åº”è¯¥å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹"><a href="#å¦‚ä½•å®ç°è¿™æ ·ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Ÿä¸€ä¸ªé«˜æ•ˆçš„ç¼“å­˜åº”è¯¥å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹" class="headerlink" title="å¦‚ä½•å®ç°è¿™æ ·ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Ÿä¸€ä¸ªé«˜æ•ˆçš„ç¼“å­˜åº”è¯¥å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹"></a>å¦‚ä½•å®ç°è¿™æ ·ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Ÿä¸€ä¸ªé«˜æ•ˆçš„ç¼“å­˜åº”è¯¥å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹</h4><ul>
<li><p>ä¸¤ä¸ªæ–¹æ³•put(k,v)å’Œget(k)</p>
</li>
<li><p>æ—¶é—´å¤æ‚åº¦ï¼Œç©ºé—´å¤æ‚åº¦è¶Šä½è¶Šå¥½ï¼Œæœ€å¥½æ˜¯O(1)</p>
</li>
<li><p>éœ€è¦ä¿å­˜æ¯ä¸ªå…ƒç´ çš„è®¿é—®é¡ºåºï¼Œæ¯æ¬¡è¢«è®¿é—®åˆ°ï¼Œå°±æŠŠå…ƒç´ ç§»åŠ¨åˆ°æœ«å°¾ï¼Œè¿™é‡Œéœ€è¦é“¾è¡¨ç»“æ„</p>
</li>
<li><p>åŒæ—¶è¿˜éœ€è¦hashç»“æ„è¿˜ä¿è¯æ¯æ¬¡æŸ¥æ‰¾çš„O(1)å¤æ‚åº¦</p>
</li>
<li><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦çš„æ˜¯  HashMap + é“¾è¡¨çš„ç»“åˆä½“ï¼Œåœ¨JAVAæ°å¥½æœ‰LinkedHashMapè¿™ç§æ•°æ®ç»“æ„</p>
</li>
</ul>
<h4 id="LinkedHashMapæºç åˆ†æ"><a href="#LinkedHashMapæºç åˆ†æ" class="headerlink" title="LinkedHashMapæºç åˆ†æ"></a>LinkedHashMapæºç åˆ†æ</h4><p>åœ¨çœŸæ­£åŠ¨æ‰‹å®ç°ä¹‹å‰æˆ‘ä»¬ä¸å¦¨å…ˆçœ‹çœ‹LinkedHashMapæ˜¯å¦æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>
<p>å…ˆæ¥çœ‹çœ‹æ„é€ å‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    accessOrder = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„ accessOrder é»˜è®¤æ˜¯ä¸ºfalseï¼Œå¦‚æœè¦æŒ‰è¯»å–é¡ºåºæ’åºéœ€è¦å°†å…¶è®¾ä¸º true</span></span><br><span class="line"><span class="comment">// initialCapacity ä»£è¡¨ map çš„ å®¹é‡ï¼ŒloadFactor ä»£è¡¨åŠ è½½å› å­ (é»˜è®¤å³å¯)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor, <span class="keyword">boolean</span> accessOrder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(initialCapacity, loadFactor);</span><br><span class="line">    <span class="keyword">this</span>.accessOrder = accessOrder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>accessOrderå†³å®šäº†é“¾è¡¨ä¸­ç»“ç‚¹çš„æ’åºæ–¹å¼</p>
<ul>
<li>false :  æŒ‰ç…§æ’å…¥é¡ºåºæ’åº</li>
<li>Trueï¼šæŒ‰ç…§è¯»å–é¡ºåºæ’åº</li>
</ul>
<p>æ˜¾ç„¶ï¼Œè¿™å¹¶ä¸æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚å•Šï¼Œåœ¨LRUä¸­æ’å…¥/è¯»å–éƒ½ç®—å…¥â€œè®¿é—®â€çš„ï¼ˆä»ä¸Šé¢çš„demoå°±å¯ä»¥çœ‹å‡ºï¼‰</p>
<p>è«æ–¹ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹çœ‹æºç ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½ç¨åŠ ä¿®æ”¹ä¸ºæˆ‘æ‰€ç”¨ã€‚ç„¶åæˆ‘ä»¬å°±æ‰¾åˆ°äº†ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•ï¼Œç”¨äºæ”¹å˜ç»“ç‚¹é¡ºåºçš„ã€‚</p>
<ul>
<li><strong>void afterNodeRemoval(Node p) { }</strong>  ç»“ç‚¹åˆ é™¤åï¼ŒæŠŠå¯¹åº”çš„æ•°æ®ä»é“¾è¡¨ä¸­åˆ é™¤</li>
<li><strong>void afterNodeAccess(Node p) { }</strong> å…¶ä½œç”¨å°±æ˜¯åœ¨è®¿é—®å…ƒç´ ä¹‹åï¼Œå°†è¯¥å…ƒç´ æ”¾åˆ°åŒå‘é“¾è¡¨çš„å°¾å·´å¤„(åªæœ‰è¯»æ“ä½œæ—¶æ‰ä¼šè°ƒç”¨ï¼‰å¹¶ä¸”åœ¨accessOrder = trueæ‰ç”Ÿæ•ˆ~~</li>
<li><strong>void afterNodeInsertion(boolean evict) { }</strong>  è¿™ä¸ªè²Œä¼¼æ˜¯æˆ‘ä»¬çš„é‡ç‚¹å•Šï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦çš„å°±æ˜¯æŠŠinsertä¹Ÿç®—å…¥â€œè®¿é—®â€æ“ä½œï¼Œé‚£çœ‹çœ‹å…¶æºç å§</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//evictä¸­æ–‡æ„æ€é©±é€ï¼Œåº”è¯¥æ˜¯ç”¨æ¥æ§åˆ¶æ˜¯å¦æ‰§è¡Œåˆ é™¤çš„ä¸€ä¸ªå› ç´ ï¼Œé€šè¿‡æºç è¿½è¸ªï¼Œå‘ç°åªæœ‰readObjectååºåˆ—åŒ–çš„æ—¶å€™æ‰ä¸ºfalse,å…¶ä»–æ—¶å€™éƒ½ä¸ºtrue,æ‰€ä»¥å¯ä»¥è®¤ä¸ºè¿™ä¸ªå€¼å§‹ç»ˆä¸ºtrue</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeInsertion</span><span class="params">(<span class="keyword">boolean</span> evict)</span> </span>&#123; <span class="comment">// possibly remove eldest</span></span><br><span class="line">        LinkedHashMap.Entry&lt;K,V&gt; first;</span><br><span class="line">        <span class="keyword">if</span> (evict &amp;&amp; (first = head) != <span class="keyword">null</span> &amp;&amp; removeEldestEntry(first)) &#123;</span><br><span class="line">            K key = first.key;</span><br><span class="line">            removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†æ¥çœ‹çœ‹<code>removeEldestEntry</code>è¿™ä¸ªæ–¹æ³•æ˜¯æœ‰ä»€ä¹ˆç”¨ï¼Œä¸Šæºç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> * &lt;p&gt;This method typically does not modify the map in any way,</span><br><span class="line"> * instead allowing the map to modify itself as directed by its</span><br><span class="line"> * return value.  It &lt;i&gt;is&lt;/i&gt; permitted for this method to modify</span><br><span class="line"> * the map directly, but if it does so, it &lt;i&gt;must&lt;/i&gt; return</span><br><span class="line"> * &#123;<span class="meta">@code</span> <span class="keyword">false</span>&#125; (indicating that the map should not attempt any</span><br><span class="line"> * further modification).  The effects of returning &#123;<span class="meta">@code</span> <span class="keyword">true</span>&#125;</span><br><span class="line"> * after modifying the map from within <span class="keyword">this</span> method are unspecified.</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;This implementation merely returns &#123;<span class="meta">@code</span> <span class="keyword">false</span>&#125; (so that <span class="keyword">this</span></span><br><span class="line"> * map acts like a normal map - the eldest element is never removed).</span><br><span class="line"> *</span><br><span class="line"> * <span class="meta">@param</span>    eldest The least recently inserted entry in the map, or <span class="keyword">if</span></span><br><span class="line"> *           <span class="keyword">this</span> is an access-ordered map, the least recently accessed</span><br><span class="line"> *           entry.  This is the entry that will be removed it <span class="keyword">this</span></span><br><span class="line"> *           method returns &#123;<span class="meta">@code</span> <span class="keyword">true</span>&#125;.  If the map was empty prior</span><br><span class="line"> *           to the &#123;<span class="meta">@code</span> put&#125; or &#123;<span class="meta">@code</span> putAll&#125; invocation resulting</span><br><span class="line"> *           in <span class="keyword">this</span> invocation, <span class="keyword">this</span> will be the entry that was just</span><br><span class="line"> *           inserted; in other words, <span class="keyword">if</span> the map contains a single</span><br><span class="line"> *           entry, the eldest entry is also the newest.</span><br><span class="line"> * <span class="meta">@return</span>   &#123;<span class="meta">@code</span> <span class="keyword">true</span>&#125; <span class="keyword">if</span> the eldest entry should be removed</span><br><span class="line"> *           from the map; &#123;<span class="meta">@code</span> <span class="keyword">false</span>&#125; <span class="keyword">if</span> it should be retained.</span><br><span class="line"> */</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K,V&gt; eldest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å‡½æ•°å¾ˆç®€å•ï¼Œä½†æ˜¯æˆ‘ç‰¹æ„å¤åˆ¶äº†å¾ˆé•¿è‹±æ–‡æ³¨é‡Šï¼ˆä¿ç•™åŸæ±åŸå‘³çš„å˜›ï¼‰ï¼Œæ„æ€æ˜¯è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªç­–ç•¥å‡½æ•°ï¼Œç”¨æ¥å†³å®šæ˜¯å¦ç§»é™¤â€œæœ€è€â€çš„å…ƒç´ ï¼Œé»˜è®¤æ˜¯<code>false</code>ã€‚è€Œæˆ‘ä»¬è¦å®ç°LRUï¼Œå½“ç¼“å­˜æ»¡çš„æ—¶å€™ï¼Œå¿…é¡»è¦ç§»é™¤æœ€è€çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯é˜Ÿå¤´çš„å…ƒç´ ã€‚æ‰€ä»¥ï¼ŒOverrideä¹‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç®€å•æ˜“æ‡‚</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Integer, Integer&gt; eldest)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> size() &gt; capacity; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å®Œæ•´çš„LRUæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span> <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>&lt;<span class="title">Integer</span>, <span class="title">Integer</span>&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//ç¼“å­˜çš„å®¹é‡å¤§å°</span></span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">int</span> capacity;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(capacity, <span class="number">0.75F</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œè¿”å›nullæˆ–è€…è‡ªå®šä¹‰ä¸€ä¸ªé»˜è®¤å€¼ï¼Œæ­¤å¤„ä¸º-1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getOrDefault(key, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// put æ“ä½œå¾ˆç®€å•ï¼Œç›´æ¥å«çˆ¸çˆ¸å°±å®Œäº‹å„¿äº†</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Integer, Integer&gt; eldest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> size() &gt; capacity; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å°±è¿™ï¼Ÿæ²¡é”™ï¼Œå°±è¿™ä¹ˆç®€å•ï¼Œå› ä¸ºä½ ç«™åœ¨äº†å·¨äººçš„è‚©è†€ä¸Š~~ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä»0å¼€å§‹å®ç°ã€‚è¿™é‡Œå°±æš‚æ—¶å·æ‡’ï¼Œæ’ä¸ªçœ¼ï¼Œæƒ³è¿›ä¸€æ­¥äº†è§£ï¼Œçœ‹è¿™é‡Œ <a href="https://leetcode-cn.com/problems/lru-cache/solution/">åŠ›æ‰£LRU</a></p>
<h3 id="LFU"><a href="#LFU" class="headerlink" title="LFU"></a>LFU</h3><ul>
<li>æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®è¿‡å»è¢«è®¿é—®æ•°æ¬¡è¶Šå¤šï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„é¢‘ç‡ä¹Ÿæ›´é«˜â€ã€‚</li>
</ul>
<h4 id="å¦‚ä½•å®ç°ï¼Ÿ"><a href="#å¦‚ä½•å®ç°ï¼Ÿ" class="headerlink" title="å¦‚ä½•å®ç°ï¼Ÿ"></a>å¦‚ä½•å®ç°ï¼Ÿ</h4><ul>
<li>æ¯ä¸ªå…ƒç´ éœ€è¦æŒ‰ç…§è®¿é—®æ¬¡æ•°ï¼ˆé¢‘ç‡ï¼‰æ’åºï¼Œå½“ç¼“å­˜æ»¡äº†ï¼Œç§»é™¤è®¿é—®æ¬¡æ•°æœ€å°‘çš„é‚£ä¸ªï¼›</li>
<li>å¦‚æœç¼“å­˜ä¸­çš„è®¿é—®é¢‘ç‡éƒ½ä¸€æ ·ï¼Œé‚£å°±ç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ï¼ˆæ²¡é”™ï¼Œå°±å˜æˆäº†LRUäº†ï¼‰</li>
<li>get æ–¹æ³•ï¼Œéœ€è¦æ”¯æŒO(1)çº§åˆ«çš„å¿«é€ŸæŸ¥æ‰¾ï¼Œè€ƒè™‘äº†ä¸€ä¸‹æœæ–­hashå•Š</li>
<li>putæ–¹æ³•ï¼Œæœ€å¥½ä¹Ÿæ”¯æŒO(1)çº§åˆ«çš„ï¼Œæœæ–­ç”¨é“¾è¡¨å•Š</li>
</ul>
<h4 id="ä¸¾ä¸ªä¾‹å­"><a href="#ä¸¾ä¸ªä¾‹å­" class="headerlink" title="ä¸¾ä¸ªä¾‹å­"></a>ä¸¾ä¸ªä¾‹å­</h4><p>LFUCache cache = new LFUCache( 2 );  //2ä¸ºcapacityï¼Œç¼“å­˜å®¹é‡</p>
<p>cache.put(1, 1);<br>cache.put(2, 2);<br>cache.get(1);       // è¿”å› 1<br>cache.put(3, 3);    // å»é™¤ key 2<br>cache.get(2);       // è¿”å› -1 (æœªæ‰¾åˆ°key 2)<br>cache.get(3);       // è¿”å› 3<br>cache.put(4, 4);    // å»é™¤ key 1ï¼Œæ­¤æ—¶3å’Œ1çš„è®¿é—®æ¬¡æ•°éƒ½æ˜¯2ï¼Œä½†1æ¯”3æ¥çš„æ—©ã€‚<br>cache.get(1);       // è¿”å› -1 (æœªæ‰¾åˆ° key 1)<br>cache.get(3);       // è¿”å› 3<br>cache.get(4);       // è¿”å› 4</p>
<h4 id="åŠ¨æ‰‹å®ç°"><a href="#åŠ¨æ‰‹å®ç°" class="headerlink" title="åŠ¨æ‰‹å®ç°"></a>åŠ¨æ‰‹å®ç°</h4><p>é‡‡ç”¨HashMapå’Œ LinkedHashSetå¼ºå¼ºè”åˆçš„æ–¹å¼å®ç°ã€‚åŸç†å¯ä»¥çœ‹ä¸‹å›¾(å¼•ç”¨è‡ª<a href="https://leetcode-cn.com/problems/lfu-cache/solution/ha-xi-biao-shuang-xiang-lian-biao-java-by-liweiwei/">LeetCodeé¢˜è§£)</a></p>
<p><img src="https://pic.leetcode-cn.com/909ea661e76e600e49763d06d2fa72b7897e36ebf47d966292636bce1b241734-image.png"></p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬éœ€è¦å•¥ï¼Ÿå‡è®¾æˆ‘ä»¬ç¼“å­˜çš„key,valueç±»å‹éƒ½æ˜¯Integer</p>
<ul>
<li>ä¸€ä¸ªHashMap&lt;Integer,Node&gt; cache;  Nodeæ˜¯åŒå‘é“¾è¡¨çš„ç»“ç‚¹ç±»å‹</li>
<li>ä¸€ä¸ªHashMap&lt;Integer,LinkedHashSet<Node>&gt; freqMapï¼›ä¸€ä¸ªè®°å½•è®¿é—®æ¬¡æ•°çš„ hashè¡¨+åŒå‘é“¾è¡¨ç»“æ„ï¼Œè¿™é‡Œå°±ä½¿ç”¨JAVAè‡ªå¸¦çš„  LinkedHashSetã€‚</li>
<li>æ–°æ¥çš„ç»“ç‚¹æ”¾åœ¨åŒå‘é“¾è¡¨å°¾éƒ¨ï¼Œæ‰€ä»¥é‡‡ç”¨<code>å°¾æ’æ³•</code>ï¼Œæ²¡åŠæ³•ï¼Œè°è®©LinkedHashSetå°¾æ’æ•ˆç‡é«˜å‘¢~~</li>
</ul>
<p>é¦–å…ˆï¼Œå®šä¹‰Nodeç»“ç‚¹ç»“æ„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">  	<span class="comment">//é»˜è®¤ä¸º1</span></span><br><span class="line">    <span class="keyword">int</span> freq = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯ï¼ŒLFUç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LFUCache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;Integer,Node&gt; cache;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;Integer,LinkedHashSet&lt;Node&gt;&gt; freqMap;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é¿å…æ¯æ¬¡éƒ½è¦éå†freqMapï¼Œé‡‡ç”¨å…¨å±€å˜é‡ç»´æŠ¤ä¸€ä¸ªå½“å‰çš„æœ€å°é¢‘æ¬¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> minFreq;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜æœ€å¤§å®¹é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capacity;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LFUCache</span><span class="params">(<span class="keyword">int</span> capacity)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">        <span class="keyword">this</span>.cache = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.freqMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> value)</span></span>&#123;</span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“çš„åŠŸèƒ½éœ€è¦æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥å®Œå–„å®ƒäº†ã€‚</p>
<p>é¦–å…ˆçœ‹çœ‹ <code>get</code>æ–¹æ³•ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯æœ€ç®€å•çš„ã€‚</p>
<ul>
<li>æ ¹æ®<code>key</code>ä» <code>cache</code>ä¸­å–å‡ºå¯¹åº”çš„ç»“ç‚¹Nodeï¼Œ<ul>
<li>å¦‚æœNodeå­˜åœ¨ï¼Œåˆ™è¿”å›å…¶å€¼ï¼Œå¹¶node.freq++;</li>
<li>ä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤å€¼ null ,æˆ–è€…-1(æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œä¸ºäº†ç®€å•è¿™é‡Œå°± -1å§ï¼Œå®é™…åº”è¯¥æ˜¯null,å¹¶ä¸”ç»“åˆæ³›å‹æ¥åš)ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">        Node node = <span class="keyword">this</span>.cache.get(key);</span><br><span class="line">        <span class="keyword">if</span>(node != <span class="keyword">null</span>)&#123;</span><br><span class="line">          <span class="comment">//å¢åŠ æ­¤ç»“ç‚¹çš„è®¿é—®æ¬¡æ•°</span></span><br><span class="line">            <span class="keyword">this</span>.freqIncrement(node);</span><br><span class="line">            <span class="keyword">return</span> node.value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¢åŠ ç»“ç‚¹çš„è®¿é—®æ¬¡æ•°ä¸ä»…ä»…æ˜¯  <code>node.freq++</code>è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬è¦åŒæ­¥æ›´æ–°<code>this.freqMap</code>æŠŠNodeç§»åŠ¨åˆ°å¯¹åº”é¢‘æ¬¡ï¼ˆè°ƒç”¨æ¬¡æ•°çš„ï¼‰æ¡¶é‡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¢åŠ ç»“ç‚¹è®¿é—®æ¬¡æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">freqIncrement</span><span class="params">(Node node)</span></span>&#123;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°æ—§çš„æ¡¶ä¸­çš„ç»“ç‚¹ï¼Œå¹¶ç§»é™¤</span></span><br><span class="line">        <span class="keyword">int</span> curFreq = node.freq;</span><br><span class="line">        LinkedHashSet&lt;Node&gt; oldSet = <span class="keyword">this</span>.freqMap.get(curFreq);</span><br><span class="line">        oldSet.remove(node);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœå½“å‰æ¡¶ç§»é™¤äº†nodeåï¼Œå·²ç»æ˜¯ä¸ªç©ºæ¡¶äº†ï¼Œé‚£ä¹ˆminFreqå°±è¦æŒ‡å‘å¤§ä¸€å·çš„æ¡¶</span></span><br><span class="line">        <span class="keyword">if</span>(curFreq == minFreq &amp;&amp; oldSet.size() == <span class="number">0</span>)&#123;</span><br><span class="line">            minFreq = curFreq + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¢åŠ è®¿é—®æ¬¡æ•°ï¼Œå¹¶åŠ å…¥æ–°æ¡¶çš„é“¾å°¾</span></span><br><span class="line">        node.freq++;</span><br><span class="line">        LinkedHashSet&lt;Node&gt; newSet = <span class="keyword">this</span>.freqMap.get(node.freq);</span><br><span class="line">        <span class="keyword">if</span>(newSet == <span class="keyword">null</span>)&#123;</span><br><span class="line">            newSet = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">            <span class="keyword">this</span>.freqMap.put(node.freq,newSet);</span><br><span class="line">        &#125;</span><br><span class="line">        newSet.add(node);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>ç„¶åæ˜¯<code>put</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±ç¨å¤æ‚ä¸€ç‚¹äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> value)</span></span>&#123;</span><br><span class="line">        <span class="comment">//å®¹é‡æ˜¯0ï¼Œé‚£å®ƒå¯èƒ½æ˜¯ä¸ªå‡ç¼“å­˜å§</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.capacity == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Node curNode = cache.get(key);</span><br><span class="line">        <span class="comment">//å¦‚æœç¼“å­˜å·²ç»å­˜åœ¨ï¼Œç›´æ¥è¦†ç›–</span></span><br><span class="line">        <span class="keyword">if</span> (curNode != <span class="keyword">null</span>)&#123;</span><br><span class="line">            curNode.value = value;</span><br><span class="line">            <span class="keyword">this</span>.freqIncrement(curNode);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//ç¼“å­˜å®¹é‡è¾¾åˆ°ä¸Šé™äº†ï¼Ÿéœ€è¦å…ˆåˆ é™¤</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.cache.size() == capacity)&#123;</span><br><span class="line">                <span class="comment">//åˆ é™¤ç¬¬ä¸€ä¸ª</span></span><br><span class="line">                LinkedHashSet&lt;Node&gt; set = <span class="keyword">this</span>.freqMap.get(minFreq);</span><br><span class="line">                Node needRemove = set.iterator().next();</span><br><span class="line">                set.remove(needRemove);</span><br><span class="line">                cache.remove(needRemove);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ–°å¢</span></span><br><span class="line">            Node newNode = <span class="keyword">new</span> Node(key, value);</span><br><span class="line">            cache.put(key,newNode);</span><br><span class="line">            LinkedHashSet&lt;Node&gt; floorDeq = <span class="keyword">this</span>.freqMap.get(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(floorDeq == <span class="keyword">null</span>)&#123;</span><br><span class="line">                floorDeq = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">                freqMap.put(<span class="number">1</span>,floorDeq);</span><br><span class="line">            &#125;</span><br><span class="line">            floorDeq.add(newNode);</span><br><span class="line">            <span class="comment">//æ›´æ–°minFreq</span></span><br><span class="line">            minFreq = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LFUCache cache = <span class="keyword">new</span> LFUCache(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        cache.put(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        cache.put(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(cache.getMap().keySet());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> res1 = cache.get(<span class="number">1</span>);</span><br><span class="line">        System.out.println(res1);</span><br><span class="line"></span><br><span class="line">        cache.put(<span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line">        System.out.println(cache.getMap().keySet());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> res2 = cache.get(<span class="number">2</span>);</span><br><span class="line">        System.out.println(res2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> res3 = cache.get(<span class="number">3</span>);</span><br><span class="line">        System.out.println(res3);</span><br><span class="line"></span><br><span class="line">        cache.put(<span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        System.out.println(cache.getMap().keySet());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> res4 = cache.get(<span class="number">1</span>);</span><br><span class="line">        System.out.println(res4);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> res5 = cache.get(<span class="number">3</span>);</span><br><span class="line">        System.out.println(res5);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> res6 = cache.get(<span class="number">4</span>);</span><br><span class="line">        System.out.println(res6);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ä¸ºäº†ä»£ç ç®€å•ï¼Œä¸Šé¢èƒ½ç”¨javaæä¾›çš„é›†åˆç±»éƒ½å°½é‡ä½¿ç”¨äº†ï¼Œä½†æ˜¯ä¸ºäº†æ•ˆç‡é«˜ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å®ç°ä¸€ä¸ªè‡ªå·±çš„åŒç«¯é“¾è¡¨æ¥å®ç°ï¼Œä½†æ˜¯ç”Ÿäº§ç¯å¢ƒä¸æ¨èè‡ªå·±å®ç°LRU,LFUè¿™ç§ï¼Œç›´æ¥ç”¨ç°æˆçš„ã€‚</p>
<h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><ul>
<li><a href="https://leetcode-cn.com/problems/lfu-cache/solution/java-13ms-shuang-100-shuang-xiang-lian-biao-duo-ji/">LeetCode-Sweetieeç”œå§¨</a></li>
<li><a href="https://leetcode-cn.com/problems/lfu-cache/solution/ha-xi-biao-shuang-xiang-lian-biao-java-by-liweiwei/">LeetCode-liweweiå¤§ä½¬</a></li>
</ul>
]]></content>
      <categories>
        <category>ç®—æ³•</category>
        <category>ç¼“å­˜</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
        <tag>FIFO</tag>
        <tag>LRU</tag>
        <tag>LFU</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaçˆ¶å­çº¿ç¨‹çš„ThreadLocalæ•°æ®ä¼ é€’é—®é¢˜</title>
    <url>/2020/05/26/InheritableThreadLocal/</url>
    <content><![CDATA[<h2 id="JAVAçˆ¶å­çº¿ç¨‹ä¹‹é—´å¦‚ä½•ä¼ é€’æ•°æ®"><a href="#JAVAçˆ¶å­çº¿ç¨‹ä¹‹é—´å¦‚ä½•ä¼ é€’æ•°æ®" class="headerlink" title="JAVAçˆ¶å­çº¿ç¨‹ä¹‹é—´å¦‚ä½•ä¼ é€’æ•°æ®"></a>JAVAçˆ¶å­çº¿ç¨‹ä¹‹é—´å¦‚ä½•ä¼ é€’æ•°æ®</h2><h3 id="çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹å¼"><a href="#çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹å¼" class="headerlink" title="çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹å¼"></a>çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹å¼</h3><p>å¸¸è§çš„æ–¹å¼ç”±ä»¥ä¸‹å‡ ç§</p>
<ul>
<li>åŒæ­¥é”</li>
<li>é€šçŸ¥ç­‰å¾…æœºåˆ¶ï¼šnotify/wait</li>
<li>ä¿¡å·é‡ CountdownLatch/CyclicBarrier/Semaphore</li>
<li>ç®¡é“PipedWriter/ PipedReader/ PipedOutputStream/ PipedInputStream</li>
</ul>
<p>å½“ç„¶ï¼Œä¸Šé¢è¿™äº›è·Ÿä»Šå¤©è¦è®¨è®ºçš„ä¸œè¥¿æ²¡å…³ç³»ã€‚</p>
<h3 id="çˆ¶å­çº¿ç¨‹ThreadLocalé—®é¢˜"><a href="#çˆ¶å­çº¿ç¨‹ThreadLocalé—®é¢˜" class="headerlink" title="çˆ¶å­çº¿ç¨‹ThreadLocalé—®é¢˜"></a>çˆ¶å­çº¿ç¨‹ThreadLocalé—®é¢˜</h3><p>é¦–å…ˆçœ‹ä¸€æ®µä»£ç ï¼Œæå‡ºé—®é¢˜:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ThreadLocal&lt;String&gt; threadLocal = ThreadLocal.withInitial(()-&gt;&#123;<span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;&#125;);</span><br><span class="line">        threadLocal.set(<span class="string">&quot;modify hello world&quot;</span>);</span><br><span class="line">        System.out.println(Thread.currentThread().getId()+<span class="string">&quot; get:&quot;</span>+threadLocal.get());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">10</span> ; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">&quot;Thread:&quot;</span>+ Thread.currentThread().getId()+<span class="string">&quot; get:&quot;</span>+ threadLocal.get())).start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;====end======&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç :çˆ¶çº¿ç¨‹ï¼ˆmainï¼‰çº¿ç¨‹å®šä¹‰äº†ä¸€ä¸ªThreadLocalå˜é‡ï¼Œå¹¶å®šä¹‰äº†åˆå§‹å€¼ã€‚ç„¶åï¼Œå¯åŠ¨å¤šä¸ªå­çº¿ç¨‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œ <code>threadLocal.get()</code>é‚£ä¹ˆæ ¹æ®threadLocalçš„ç‰¹æ€§ï¼Œä¼šæ‹¿åˆ°ä»€ä¹ˆå€¼å‘¢ï¼Ÿçœ‹è¾“å‡ºï¼š</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">13</span> get:hello world</span><br><span class="line">Thread:<span class="number">14</span> get:hello world</span><br><span class="line">Thread:<span class="number">15</span> get:hello world</span><br><span class="line">Thread:<span class="number">16</span> get:hello world</span><br><span class="line">Thread:<span class="number">17</span> get:hello world</span><br><span class="line">Thread:<span class="number">18</span> get:hello world</span><br><span class="line">Thread:<span class="number">19</span> get:hello world</span><br><span class="line">Thread:<span class="number">21</span> get:hello world</span><br><span class="line">Thread:<span class="number">20</span> get:hello world</span><br><span class="line">Thread:<span class="number">22</span> get:hello world</span><br><span class="line">====<span class="keyword">end</span>======</span><br></pre></td></tr></table></figure>

<p>è¿™è¾¹æˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸¤ä¸ªç»“è®º</p>
<ol>
<li>ThreadLocal.withInitialè®¾ç½®çš„åˆå§‹å€¼å…¶å®å°±æ˜¯é»˜è®¤å€¼ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½ä¼šå½±å“åˆ°ï¼ˆçœ‹æºç ï¼ŒSuppliedThreadLocalé‡å†™äº†initialValueæ–¹æ³• ï¼‰ã€‚</li>
<li>ThreadLocalå®ç°æ•°æ®çš„çº¿ç¨‹éš”ç¦»ã€‚</li>
</ol>
<p>é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•å¯ä»¥å®ç°å…„å¼Ÿçº¿ç¨‹ä¹‹é—´æ•°æ®éš”ç¦»ï¼Œä½†çˆ¶å­çº¿ç¨‹ä¹‹é—´æ•°æ®äº’é€šå‘¢ï¼Ÿ</p>
<h3 id="InheritableThreadLocal"><a href="#InheritableThreadLocal" class="headerlink" title="InheritableThreadLocal"></a>InheritableThreadLocal</h3><p>InheritableThreadLocalå¯ä»¥å®ç°æ•°æ®çš„ç»§æ‰¿ï¼Œä½†æ˜¯ç»§æ‰¿ä¹‹åï¼Œå­çº¿ç¨‹ä¿®æ”¹threadLocalä¸­çš„å€¼æ˜¯æ— æ³•ä¼ é€’åˆ°çˆ¶çº¿ç¨‹çš„ï¼Œå³è¿™ç§æ•°æ®ä¼ é€’æ˜¯å•å‘çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> InheritableThreadLocal();</span><br><span class="line">        threadLocal.set(<span class="string">&quot;modify hello world&quot;</span>);</span><br><span class="line">        System.out.println(Thread.currentThread().getId()+<span class="string">&quot; get:&quot;</span>+threadLocal.get());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">10</span> ; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread:&quot;</span>+ Thread.currentThread().getId()+<span class="string">&quot; get:&quot;</span>+ threadLocal.get());</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;====end======&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡º</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">13</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">14</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">15</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">16</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">17</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">18</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">19</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">20</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">21</span> get:modify hello world</span><br><span class="line">Thread:<span class="number">22</span> get:modify hello world</span><br><span class="line">====<span class="keyword">end</span>======</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>æŸ¥çœ‹æºç ï¼Œå‘ç°InheritableThreadLocalæºç å¾ˆç®€å•ï¼Œç»§æ‰¿äº†ThreadLocalï¼Œé‡å†™äº†ä¸‰ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableThreadLocal</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ThreadLocal</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Computes the child&#x27;s initial value for this inheritable thread-local</span></span><br><span class="line"><span class="comment">     * variable as a function of the parent&#x27;s value at the time the child</span></span><br><span class="line"><span class="comment">     * thread is created.  This method is called from within the parent</span></span><br><span class="line"><span class="comment">     * thread before the child is started.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * This method merely returns its input argument, and should be overridden</span></span><br><span class="line"><span class="comment">     * if a different behavior is desired.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parentValue the parent thread&#x27;s value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the child thread&#x27;s initial value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> T <span class="title">childValue</span><span class="params">(T parentValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parentValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the map associated with a ThreadLocal.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the current thread</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> t.inheritableThreadLocals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create the map associated with a ThreadLocal.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the current thread</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstValue value for the initial entry of the table.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</span><br><span class="line">        t.inheritableThreadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹å…³æ³¨ childValue è¿™ä¸ªæ–¹æ³•ï¼Œæ³¨é‡Šå¤§æ¦‚æ„æ€æ˜¯ï¼šè¿™ä¸ªæ–¹æ³•ä¼šåœ¨çˆ¶çº¿ç¨‹åˆ›å»ºå­çº¿ç¨‹çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå­çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ï¼ŒinheritableThreadLocalsè¿™ä¸ªmapè¦æŠŠçˆ¶çº¿ç¨‹çš„inheritableThreadLocals ä¸­çš„æ‰€æœ‰k,væ‹·è´è¿‡æ¥ï¼Œæ‹·è´çš„æ—¶å€™ï¼Œæ¯ä¸ªentryçš„valueæ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å‘¢ï¼ŸchildValueå°±æ˜¯è´Ÿè´£é‡æ–°è®¡ç®—çš„ï¼Œåªä¸è¿‡é»˜è®¤çš„å®ç°æ˜¯è¿”å›ä¼ å…¥å‚æ•°ï¼Œdo nothingã€‚</p>
<p>ç»§ç»­è¿½è¸ªä¸€ä¸‹è°ƒç”¨é“¾è·¯ï¼ŒéªŒè¯ä¸Šé¢çš„è¯´æ³•ï¼Œçœ‹çœ‹childValueè¢«è°è°ƒç”¨äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Construct a new map including all Inheritable ThreadLocals</span></span><br><span class="line"><span class="comment">         * from given parent map. Called only by createInheritedMap.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> parentMap the map associated with parent thread.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">ThreadLocalMap</span><span class="params">(ThreadLocalMap parentMap)</span> </span>&#123;</span><br><span class="line">            Entry[] parentTable = parentMap.table;</span><br><span class="line">            <span class="keyword">int</span> len = parentTable.length;</span><br><span class="line">            setThreshold(len);</span><br><span class="line">            table = <span class="keyword">new</span> Entry[len];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Entry e : parentTable) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    ThreadLocal&lt;Object&gt; key = (ThreadLocal&lt;Object&gt;) e.get();</span><br><span class="line">                    <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Object value = key.childValue(e.value);</span><br><span class="line">                        Entry c = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line">                        <span class="keyword">int</span> h = key.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">while</span> (table[h] != <span class="keyword">null</span>)</span><br><span class="line">                            h = nextIndex(h, len);</span><br><span class="line">                        table[h] = c;</span><br><span class="line">                        size++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ˜¯ThreadLocalç±»çš„ä¸€ä¸ªprivateæ„é€ æ–¹æ³•ï¼Œä»åŠŸèƒ½ä¸Šçœ‹ï¼Œå°±æ˜¯æ‹·è´ä¼ è¿›æ¥çš„threadLocalMapçš„å†…å®¹ï¼Œä»æ³¨é‡Šä¸Šçœ‹ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°çš„è°ƒç”¨æ˜¯ï¼š<code>Called only by createInheritedMap</code>,çœ‹ä¸€ä¸‹ä¸Šä¸€å±‚è°ƒç”¨çš„åœ°æ–¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ThreadLocalMap <span class="title">createInheritedMap</span><span class="params">(ThreadLocalMap parentMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadLocalMap(parentMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è¿½ä¸Šå±‚è°ƒç”¨ï¼Œå°±ä¼šè·³åˆ°Threadçš„æºç ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Thread</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">long</span> stackSize, AccessControlContext acc,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">boolean</span> inheritThreadLocals)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;name cannot be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line"></span><br><span class="line">        Thread parent = currentThread();</span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">/* Determine if it&#x27;s an applet or not */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* If there is a security manager, ask the security manager</span></span><br><span class="line"><span class="comment">               what to do. */</span></span><br><span class="line">            <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">                g = security.getThreadGroup();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* If the security manager doesn&#x27;t have a strong opinion</span></span><br><span class="line"><span class="comment">               on the matter, use the parent thread group. */</span></span><br><span class="line">            <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</span><br><span class="line">                g = parent.getThreadGroup();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* checkAccess regardless of whether or not threadgroup is</span></span><br><span class="line"><span class="comment">           explicitly passed in. */</span></span><br><span class="line">        g.checkAccess();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Do we have the required permissions?</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isCCLOverridden(getClass())) &#123;</span><br><span class="line">                security.checkPermission(</span><br><span class="line">                        SecurityConstants.SUBCLASS_IMPLEMENTATION_PERMISSION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        g.addUnstarted();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.group = g;</span><br><span class="line">        <span class="keyword">this</span>.daemon = parent.isDaemon();</span><br><span class="line">        <span class="keyword">this</span>.priority = parent.getPriority();</span><br><span class="line">        <span class="keyword">if</span> (security == <span class="keyword">null</span> || isCCLOverridden(parent.getClass()))</span><br><span class="line">            <span class="keyword">this</span>.contextClassLoader = parent.getContextClassLoader();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">this</span>.contextClassLoader = parent.contextClassLoader;</span><br><span class="line">        <span class="keyword">this</span>.inheritedAccessControlContext =</span><br><span class="line">                acc != <span class="keyword">null</span> ? acc : AccessController.getContext();</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        setPriority(priority);</span><br><span class="line">  			<span class="comment">//æ³¨æ„çœ‹è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">this</span>.inheritableThreadLocals =</span><br><span class="line">                ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line">        <span class="comment">/* Stash the specified stack size in case the VM cares */</span></span><br><span class="line">        <span class="keyword">this</span>.stackSize = stackSize;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Set thread ID */</span></span><br><span class="line">        <span class="keyword">this</span>.tid = nextThreadID();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹çš„æ„é€ å‡½æ•°ï¼Œä¹Ÿæ˜¯è¯æ˜äº†æˆ‘ä»¬ä¸Šé¢çš„è¯´æ³•ï¼Œå­çº¿ç¨‹è¢«åˆ›å»ºçš„æ—¶å€™ä¼šæ‹·è´ä¸€ä»½çˆ¶çº¿ç¨‹çš„inheritableThreadLocalå˜é‡åˆ°è‡ªå·±çš„InheritableThreadLocalå˜é‡ä¸­ã€‚</p>
<h3 id="InheritableThreadLocalå­˜åœ¨çš„é—®é¢˜"><a href="#InheritableThreadLocalå­˜åœ¨çš„é—®é¢˜" class="headerlink" title="InheritableThreadLocalå­˜åœ¨çš„é—®é¢˜"></a>InheritableThreadLocalå­˜åœ¨çš„é—®é¢˜</h3><p>æ‰€ä»¥è¿™æ ·å°±ç»“æŸäº†ï¼Ÿä¸ï¼Œä¸”çœ‹ä¸‹é¢ä¸€æ®µä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> InheritableThreadLocal();</span><br><span class="line">        threadLocal.set(<span class="string">&quot;default value set by main thread&quot;</span>);</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        executorService.submit(()-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Pool-Thread:&quot;</span> + Thread.currentThread().getId() + <span class="string">&quot; get 1:&quot;</span> + threadLocal.get());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//ä¸»çº¿ç¨‹ä¿®æ”¹ä¸€æ¬¡</span></span><br><span class="line">        threadLocal.set(<span class="string">&quot;updated value set by main thread&quot;</span>);</span><br><span class="line"></span><br><span class="line">        executorService.submit(()-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Pool-Thread:&quot;</span> + Thread.currentThread().getId() + <span class="string">&quot; get 2:&quot;</span> + threadLocal.get());</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br></pre></td></tr></table></figure>

<p>æ—¥å¿—è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Pool-Thread:13 get 1:default value set by main thread</span><br><span class="line">Pool-Thread:13 get 2:default value set by main thread</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ï¼Œå¦‚æœæ˜¯ä½¿ç”¨çº¿ç¨‹æ± ï¼Œçº¿ç¨‹è¢«å¤ç”¨ï¼Œé‚£ä¹ˆçˆ¶çº¿ç¨‹å°±æ— æ³•ä¿®æ”¹äº†ã€‚ç»è¿‡äº†ä¸Šé¢å¯¹InheritableThreadLocalæºç çš„åˆ†æï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æ‰¾åˆ°åŸå› ï¼šThreadçš„æ„é€ å‡½æ•°åªä¼šè°ƒç”¨ä¸€æ¬¡</p>
<p><strong>åœ¨çº¿ç¨‹æ± åŒ–çš„åœºæ™¯ä¸­ï¼ŒInheritableThreadLocalä¸å†æ»¡è¶³éœ€æ±‚</strong></p>
<p>å…¸å‹çš„ä½¿ç”¨åœºæ™¯</p>
<ul>
<li>åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ</li>
<li>æ—¥å¿—æ”¶é›†è®°å½•ç³»ç»Ÿä¸Šä¸‹æ–‡</li>
<li>Sessionçº§åˆ«çš„cache</li>
<li>åº”ç”¨å®¹å™¨æˆ–ä¸Šå±‚æ¡†æ¶è·¨åº”ç”¨ä»£ç ç»™ä¸‹å±‚<code>SDK</code>ä¼ é€’ä¿¡æ¯</li>
<li>â€¦</li>
</ul>
<h3 id="TransmittableThreadLocal"><a href="#TransmittableThreadLocal" class="headerlink" title="TransmittableThreadLocal"></a>TransmittableThreadLocal</h3><p>è¿™ä¸ªæ˜¯é˜¿é‡Œå¼€æºçš„ä¸€ç§æ–¹æ¡ˆï¼Œå®ƒç»§æ‰¿äº†InheritableThreadLocalï¼Œå…·ä½“çš„èµ„æ–™å¯ä»¥å‚è€ƒ  <a href="https://github.com/alibaba/transmittable-thread-local">Transmittable ThreadLocal(TTL)</a> ã€‚</p>
<p>å…ˆçœ‹å¦‚ä½•ä½¿ç”¨,é¦–å…ˆæ˜¯å¼•ç”¨jaråŒ…ï¼Œæœ‰å¤šç§æ–¹å¼ï¼Œæ­¤å¤„é‡‡ç”¨maven</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;transmittable-thread-local&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.11.4&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯åŒæ ·çš„é€»è¾‘ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TransmittableThreadLocal&lt;String&gt; context = <span class="keyword">new</span> TransmittableThreadLocal&lt;String&gt;();</span><br><span class="line">        context.set(<span class="string">&quot;value-set-in-parent&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// é¢å¤–çš„å¤„ç†ï¼Œç”Ÿæˆä¿®é¥°äº†çš„å¯¹è±¡executorService</span></span><br><span class="line">        executorService = TtlExecutors.getTtlExecutorService(executorService);</span><br><span class="line"></span><br><span class="line">        executorService.submit(()-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Pool-Thread:&quot;</span> + Thread.currentThread().getId() + <span class="string">&quot; get 1:&quot;</span> + context.get());</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        context.set(<span class="string">&quot;value-update-in-parent&quot;</span>);</span><br><span class="line"></span><br><span class="line">        executorService.submit(()-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Pool-Thread:&quot;</span> + Thread.currentThread().getId() + <span class="string">&quot; get 2:&quot;</span> + context.get());</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºè¾“å‡º:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Pool-Thread:14 get 1:value-set-in-parent</span><br><span class="line">Pool-Thread:14 get 2:value-update-in-parent</span><br></pre></td></tr></table></figure>

<p>å…³äºTransmittableThreadLocalåŸç†æ˜¯å•¥ï¼Œè¿˜éœ€è¦ä»”ç»†é˜…è¯»æºç ï¼Œè¿™è¾¹æš‚æ—¶<code>æ‰“ä¸ªæ¬ æ¡</code>ï¼Œç­‰æˆ‘å¤šæ¢³ç†å‡ éå†è¡¥ä¸Šã€‚å¯ä»¥å‚è€ƒ <a href="https://github.com/alibaba/transmittable-thread-local/blob/master/docs/developer-guide.md">å¼€å‘è€…æ–‡æ¡£</a> è¿˜æœ‰è¿™ä¸ª <a href="https://github.com/alibaba/transmittable-thread-local/issues/123">åº”ç”¨åœºæ™¯å’Œè®¾è®¡æ€è€ƒ</a></p>
]]></content>
      <categories>
        <category>JavaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>ThreadLocal</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-RabbitMQå®è·µè®°å½•</title>
    <url>/2020/05/17/SpringBoot-RabbitMQ-practice/</url>
    <content><![CDATA[<h3 id="RabbitMQ-SpringBootå®è·µ"><a href="#RabbitMQ-SpringBootå®è·µ" class="headerlink" title="RabbitMQ + SpringBootå®è·µ"></a>RabbitMQ + SpringBootå®è·µ</h3><h4 id="ä¸ºå•¥å†™è¿™ç¯‡"><a href="#ä¸ºå•¥å†™è¿™ç¯‡" class="headerlink" title="ä¸ºå•¥å†™è¿™ç¯‡"></a>ä¸ºå•¥å†™è¿™ç¯‡</h4><p>æ¥è§¦å¹¶ä½¿ç”¨RabbitMQå·²ç»æœ‰å¥½å‡ å¹´äº†ï¼Œæ¯æ¬¡é…ç½®MQçš„æ—¶å€™ï¼Œéƒ½è¦ç¡®ä¿æ¶ˆæ¯å¯é ä¸ä¸¢å¤±ã€å¹‚ç­‰æ€§ç­‰é—®é¢˜ã€‚æ—¶é—´ä¹…äº†ï¼Œæ›¾ç»åšè¿‡çš„æœ€ä½³æ—¶é—´é…ç½®éš¾å…ä¼šå¿˜è®°ï¼Œç”šè‡³é‡å¤è¸©å‘ï¼Œè¿™è¾¹ç›®çš„å°±æ˜¯æ•´åˆä¸€ä¸‹é è°±çš„èµ„æºå¹¶åšä¸ªç¬”è®°åˆ†äº«ã€‚</p>
<p>ä½¿ç”¨MQæ—¶åº”è¯¥æ³¨æ„ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>æ¶ˆæ¯ä¸¢å¤±<ul>
<li>æŒä¹…åŒ–</li>
<li>å‘é€ç«¯å‘é€å¤±è´¥ï¼šå‘é€ç¡®è®¤æœºåˆ¶ confirm</li>
<li>æ¶ˆè´¹ç«¯ä¸¢å¤±ï¼šæ¶ˆè´¹ç¡®è®¤æœºåˆ¶ ack</li>
</ul>
</li>
<li>é‡å¤æ¶ˆè´¹ã€å¹‚ç­‰æ€§é—®é¢˜</li>
</ul>
<h4 id="åŸºç¡€æ¦‚å¿µ"><a href="#åŸºç¡€æ¦‚å¿µ" class="headerlink" title="åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h4><p>å…³äºRabbitMQçš„ç›¸å…³åŸºç¡€æ¦‚å¿µã€æ¶ˆæ¯æŠ•é€’æ¨¡å¼å°±ä¸å†é‡å¤äº†ï¼Œå¯ä»¥å‚è€ƒæ­¤ç¯‡æ–‡ç« å¤ä¹  <a href="https://github.com/suxiongwei/springboot-rabbitmq">RabbitMQé«˜å¯ç”¨</a></p>
<h4 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h4><h5 id="ç¯å¢ƒåŠä¾èµ–"><a href="#ç¯å¢ƒåŠä¾èµ–" class="headerlink" title="ç¯å¢ƒåŠä¾èµ–"></a>ç¯å¢ƒåŠä¾èµ–</h5><ul>
<li>SpringBoot  2.2.7.RELEASE</li>
<li>JDK 1.8</li>
<li>MySQL</li>
<li>RabbitMQ</li>
</ul>
<h5 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h5><ol>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œå¹¶ä¿å­˜å‘é€è®°å½•-å‘é€æäº¤</li>
<li>æ¥æ”¶å‘é€ç»“æœå›è°ƒï¼Œæ›´æ–°å‘é€è®°å½•-å‘é€æˆåŠŸ/å¤±è´¥</li>
<li>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼ŒæŸ¥è¯¢æ¶ˆæ¯è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œæ˜¯å¦é‡å¤æ¶ˆè´¹</li>
<li>æ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯ï¼Œæ›´æ–°æ¶ˆæ¯è®°å½•ä¸º-å·²æ¶ˆè´¹/æ¶ˆè´¹å¼‚å¸¸  çŠ¶æ€</li>
<li>æ ¹æ®æ¶ˆè´¹ç»“æœæ‰§è¡Œæ‰‹åŠ¨ channel.basicAck</li>
</ol>
<h5 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h5><p><code>application.properties</code> å…³é”®éƒ¨åˆ†ä½œç”¨éƒ½æœ‰æ³¨é‡Šè¯´æ˜</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/mq_practice?charset=utf8mb4&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Hikariè¿æ¥æ± çš„è®¾ç½®</span></span><br><span class="line"><span class="comment">#æœ€å°è¿æ¥</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.minimum-idle</span>=<span class="string">5</span></span><br><span class="line"><span class="comment">#æœ€å¤§è¿æ¥</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.maximum-pool-size</span>=<span class="string">15</span></span><br><span class="line"><span class="comment">#è‡ªåŠ¨æäº¤</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.auto-commit</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#æœ€å¤§ç©ºé—²æ—¶å¸¸</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.idle-timeout</span>=<span class="string">30000</span></span><br><span class="line"><span class="comment">#è¿æ¥æ± å</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.pool-name</span>=<span class="string">DatebookHikariCP</span></span><br><span class="line"><span class="comment">#æœ€å¤§ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.max-lifetime</span>=<span class="string">900000</span></span><br><span class="line"><span class="comment">#è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.connection-timeout</span>=<span class="string">15000</span></span><br><span class="line"><span class="comment">#å¿ƒè·³æ£€æµ‹</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.connection-test-query</span>=<span class="string">SELECT 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## mybatisé…ç½®</span></span><br><span class="line"><span class="comment">#xmlè·¯å¾„</span></span><br><span class="line"><span class="meta">mybatis-plus.mapper-locations</span>=<span class="string">classpath*:mapper/*.xml</span></span><br><span class="line"><span class="comment">#modelè·¯å¾„</span></span><br><span class="line"><span class="meta">mybatis-plus.type-aliases-package</span>=<span class="string">com.microloan.entity</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rabbitmq config begin</span></span><br><span class="line"><span class="meta">spring.rabbitmq.addresses</span>=<span class="string">114.67.89.67:5672</span></span><br><span class="line"><span class="meta">spring.rabbitmq.username</span>=<span class="string">admin</span></span><br><span class="line"><span class="meta">spring.rabbitmq.password</span>=<span class="string">admin</span></span><br><span class="line"><span class="meta">spring.rabbitmq.virtual-host</span>=<span class="string">/</span></span><br><span class="line"><span class="comment">#å‘é€ç¡®è®¤å›è°ƒ(exchangeæ˜¯å¦æˆåŠŸå—ç†)</span></span><br><span class="line"><span class="meta">spring.rabbitmq.publisher-confirm-type</span>=<span class="string">correlated</span></span><br><span class="line"><span class="comment"># å‘é€å¤±è´¥é€€å›ï¼ˆexchangeåˆ°queueå¤±è´¥ï¼‰</span></span><br><span class="line"><span class="meta">spring.rabbitmq.publisher-returns</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤æœºåˆ¶ï¼šautoã€manualã€nodeï¼Œ</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.acknowledge-mode</span>=<span class="string">manual</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.concurrency</span>=<span class="string">5</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.max-concurrency</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.prefetch</span>=<span class="string">1</span></span><br><span class="line"><span class="comment">#é—´éš”äº‹ä»¶2ï¼ˆmultiplierï¼‰å€é€’å¢ï¼Œå¦‚1,2,4,8,16...ä½†æœ€å¤§ä¸è¶…è¿‡max-attemptsæ¬¡</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.max-attempts</span>=<span class="string">8</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.retry.initial-interval</span>=<span class="string">2000</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.multiplier</span>=<span class="string">2</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.max-interval</span>=<span class="string">16000</span></span><br><span class="line"><span class="comment">#rabbitmq config end</span></span><br></pre></td></tr></table></figure>

<h5 id="RabbitMqConfig-javaé…ç½®"><a href="#RabbitMqConfig-javaé…ç½®" class="headerlink" title="RabbitMqConfig.javaé…ç½®"></a>RabbitMqConfig.javaé…ç½®</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMqConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST_QUEUE = <span class="string">&quot;approveRequestQueue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST_TOPIC_EXCHANGE = <span class="string">&quot;approveRequestExchange_topic&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST_ROUTING_KEY = <span class="string">&quot;approveRequestRouting&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String addresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.virtual-host&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String virtualHost;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.publisher-confirm-type&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String publisherConfirmType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.publisher-returns&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean publisherConfirmReturns;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">connectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        CachingConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory();</span><br><span class="line">        connectionFactory.setAddresses(addresses);</span><br><span class="line">        connectionFactory.setUsername(username);</span><br><span class="line">        connectionFactory.setPassword(password);</span><br><span class="line">        connectionFactory.setVirtualHost(virtualHost);</span><br><span class="line">        <span class="comment">/** å¦‚æœè¦è¿›è¡Œæ¶ˆæ¯å›è°ƒï¼Œåˆ™è¿™é‡Œå¿…é¡»è¦è®¾ç½®*/</span></span><br><span class="line">        connectionFactory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.valueOf(publisherConfirmType.toUpperCase()));</span><br><span class="line">        connectionFactory.setPublisherReturns(publisherConfirmReturns);</span><br><span class="line">        <span class="keyword">return</span> connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//TODO æ­¤å¤„åº”æ”¹æˆéå•ä¾‹æ¨¡å¼,ä¸‹æ–‡æœ‰è§£é‡Šï¼Œå…ˆæ’çœ¼</span></span><br><span class="line">    <span class="meta">@Bean(&quot;rabbitTemplateCallback&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RabbitTemplate <span class="title">rabbitTemplateCallBack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RabbitTemplate template = <span class="keyword">new</span> RabbitTemplate(connectionFactory());</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">approveRequestQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(TEST_QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TopicExchange <span class="title">approveRequestExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TopicExchange(TEST_TOPIC_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">bindingApproveReqEx</span><span class="params">(Queue reqQueue, TopicExchange reqExchange)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(reqQueue).to(reqExchange).with(TEST_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ¶ˆæ¯ä¿å­˜"><a href="#æ¶ˆæ¯ä¿å­˜" class="headerlink" title="æ¶ˆæ¯ä¿å­˜"></a>æ¶ˆæ¯ä¿å­˜</h5><p>ä¸ºäº†é˜²æ­¢æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œéœ€è¦æŠŠæ¶ˆæ¯å…¥åº“ã€‚</p>
<p>åˆ›å»ºä¸€å¼ è¡¨ç”¨æ¥ä¿å­˜æ¶ˆæ¯å‘é€çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;mq_record&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;msg_type&#96; varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  &#96;msg_id&#96; varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  &#96;status&#96; int(2) NOT NULL COMMENT &#39;1æˆåŠŸï¼Œ0å¤±è´¥&#39;,</span><br><span class="line">  &#96;create_time&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  &#96;update_time&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;) USING BTREE,</span><br><span class="line">  KEY &#96;unique_index&#96; (&#96;msg_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;9 DEFAULT CHARSET&#x3D;utf8mb4;</span><br></pre></td></tr></table></figure>

<h5 id="æ¶ˆæ¯ç”Ÿäº§è€…"><a href="#æ¶ˆæ¯ç”Ÿäº§è€…" class="headerlink" title="æ¶ˆæ¯ç”Ÿäº§è€…"></a>æ¶ˆæ¯ç”Ÿäº§è€…</h5><p>rabbitTemplateæ”¯æŒè®¾ç½®ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œ<code>setConfirmCallback</code>å’Œ<code>setReturnCallback</code>ã€‚ä½œç”¨å¦‚ä¸‹ï¼š</p>
<ul>
<li>setConfirmCallback æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°è¾¾exchangeè§¦å‘ï¼Œæœ‰ä¸ªbooleanç±»å‹çš„ackå­—æ®µè¡¨ç¤ºæ˜¯å¦æˆåŠŸå‘é€åˆ°è·¯ç”±exchange</li>
<li>setReturnCallback æ¶ˆæ¯æˆåŠŸå‘é€åˆ°exchangeï¼Œä½†åˆ†é…ç»™å…·ä½“queueæ—¶å¤±è´¥ä¼šè§¦å‘ã€‚</li>
</ul>
<p>è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ rabbitTemplateä¸€æ—¦è®¾ç½®äº†è¿™ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œæ˜¯å…¨å±€ç”Ÿæ•ˆçš„ï¼Œä½†æ˜¯çœŸæ­£çš„é¡¹ç›®é‡Œæˆ‘ä»¬å¯èƒ½æœ‰å¤šä¸ªç”Ÿäº§è€…ï¼Œè€Œæ¯ä¸ªç”Ÿäº§è€…å‘é€æ¶ˆæ¯åçš„å›è°ƒå¤„ç†é€»è¾‘å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬<strong>åº”è¯¥åœ¨æ¯ä¸ªProducerä¸­æ³¨å…¥rabbitTemplateåæ‰è®¾ç½®å›è°ƒå‡½æ•°ï¼Œè€Œä¸”rabbitTemplateåº”è¯¥æ˜¯prototypeç±»å‹ï¼ˆéå•ä¾‹ï¼‰</strong></p>
<p>é¦–å…ˆéœ€è¦ä¿®æ”¹ä¸Šé¢RabbitMqconfigç±»ä¸­çš„TODOå¤„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ”¯æŒå›è°ƒçš„template</span></span><br><span class="line"><span class="meta">@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span>  </span><br><span class="line"><span class="meta">@Bean(&quot;rabbitTemplateCallback&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RabbitTemplate <span class="title">rabbitTemplateCallBack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RabbitTemplate template = <span class="keyword">new</span> RabbitTemplate(connectionFactory());</span><br><span class="line">    <span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åproducerä¸­çš„ä»£ç å¤§æ¦‚åº”è¯¥æ˜¯è¿™æ ·çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestProducer</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource(name = &quot;rabbitTemplateCallback&quot;)</span> <span class="comment">//åº”è¯¥å’ŒRabbitMqConfigç±»ä¸­é…ç½®çš„åç§°ä¸€è‡´</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRabbitTemplate</span><span class="params">(RabbitTemplate rabbitTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplate = rabbitTemplate;</span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplate.setConfirmCallback(...);</span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplate.setReturnCallback(...);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        <span class="comment">//xxxx</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…‰æœ‰å›è°ƒä¸è¡Œå•Šï¼Œå¾—æ‰¾ä¸ªåœ°æ–¹è®°å½•æ¯ä¸ªæ¶ˆæ¯çš„å‘é€è®°å½•ï¼šæ¶ˆæ¯id,å‘é€æ—¶é—´ï¼Œæ˜¯å¦æˆåŠŸå‘é€ç­‰ä¿¡æ¯ã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ•°æ®åº“ MySQLã€‚å®Œæ•´çš„Producerå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqRecordService mqRecordService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;rabbitTemplateCallback&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRabbitTemplate</span><span class="params">(RabbitTemplate rabbitTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplate = rabbitTemplate;</span><br><span class="line">        <span class="comment">//æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°è¾¾exchangeæ—¶è¿”å›ackï¼Œæ¶ˆæ¯æœªåˆ°è¾¾exchangeè¿”å›nackï¼›</span></span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> RabbitTemplate.ConfirmCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack, String cause)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(ack)&#123;</span><br><span class="line">                    <span class="comment">//æ›´æ–°æ¶ˆæ¯å‘é€è®°å½•è¡¨çš„çŠ¶æ€ï¼Œé‡‡ç”¨ä¹è§‚é”ï¼Œ</span></span><br><span class="line">                    mqRecordService.updateRecordStatus(correlationData.getId(),</span><br><span class="line">                            MqRecordStatusEnum.SEND.getCode(),MqRecordStatusEnum.SEND_SUCCESS.getCode());</span><br><span class="line">                    log.info(<span class="string">&quot;[MQ]æ¶ˆæ¯å‘é€ç»“æœç¡®è®¤ ack:&#123;&#125;,cause:&#123;&#125;,correlationData:&#123;&#125;&quot;</span>,ack,cause,correlationData);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    log.error(<span class="string">&quot;[MQ]æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œack:&#123;&#125;,cause:&#123;&#125;,correlationData:&#123;&#125;&quot;</span>,ack,cause,correlationData);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ¶ˆæ¯è¿›å…¥exchangeä½†æœªè¿›å…¥queueæ—¶ä¼šè¢«è°ƒç”¨ã€‚</span></span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplate.setReturnCallback(<span class="keyword">new</span> RabbitTemplate.ReturnCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnedMessage</span><span class="params">(Message message, <span class="keyword">int</span> replyCode, String replyText, String exchange, String routingKey)</span> </span>&#123;</span><br><span class="line">                log.error(<span class="string">&quot;[MQ]æ¶ˆæ¯æœªæˆåŠŸè¿›å…¥queue:exchange:&#123;&#125;,route:&#123;&#125;,replyCode:&#123;&#125;,replyText:&#123;&#125;,message:&#123;&#125;&quot;</span>,exchange,routingKey,replyCode,replyText,message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> approveReqId  approveInfoè‡ªå¢idå­—æ®µ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(<span class="keyword">long</span> approveReqId,String msg)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            String key = UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">            MessageProperties mp = <span class="keyword">new</span> MessageProperties();</span><br><span class="line">            mp.setMessageId(key);</span><br><span class="line">            Message msgObj = <span class="keyword">new</span> Message(msg.getBytes(),mp);</span><br><span class="line">            <span class="comment">//æ¶ˆæ¯å”¯ä¸€é”®</span></span><br><span class="line">            CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(key);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä¿å­˜æ¶ˆæ¯å‘é€è®°å½•</span></span><br><span class="line">            MqRecord mqRecord = <span class="keyword">new</span> MqRecord();</span><br><span class="line">            mqRecord.setMsgType(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">            mqRecord.setMsgId(key);</span><br><span class="line">            mqRecord.setStatus(MqRecordStatusEnum.SEND.getCode());</span><br><span class="line">            mqRecord.setDataId(approveReqId);</span><br><span class="line">            <span class="keyword">this</span>.mqRecordService.businessSave(mqRecord);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Topicæ¨¡å¼å‘é€</span></span><br><span class="line">            <span class="keyword">this</span>.rabbitTemplate.convertAndSend(RabbitMqConfig.TEST_TOPIC_EXCHANGE,</span><br><span class="line">                    RabbitMqConfig.TEST_ROUTING_KEY,msgObj,correlationData);</span><br><span class="line">            log.info(<span class="string">&quot;[MQ]æ¶ˆæ¯å‘é€æˆåŠŸ &#123;&#125;,&#123;&#125;&quot;</span>,key,msg);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;[MQ]æ¶ˆæ¯å‘é€å¤±è´¥ &#123;&#125;,&#123;&#125;&quot;</span>,approveReqId,msg,e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ¶ˆæ¯æ¶ˆè´¹è€…"><a href="#æ¶ˆæ¯æ¶ˆè´¹è€…" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹è€…"></a>æ¶ˆæ¯æ¶ˆè´¹è€…</h5><p>æ¶ˆè´¹æ¶ˆæ¯ï¼ŒæˆåŠŸä¹‹åæ‰‹åŠ¨è°ƒç”¨ackã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqRecordService mqRecordService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;RabbitMqConfig.TEST_QUEUE&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeApproveRequest</span><span class="params">(Channel channel, Message msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String msgId = msg.getMessageProperties().getMessageId();</span><br><span class="line">        String msgBody = <span class="keyword">new</span> String(msg.getBody());</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            MqRecord mqRecord = <span class="keyword">this</span>.mqRecordService.queryByUniqueKey(msgId);</span><br><span class="line">            <span class="comment">//å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»æ¶ˆè´¹è¿‡</span></span><br><span class="line">            <span class="keyword">if</span>(!checkRepetableMsg(mqRecord,msgBody))&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//msgBodyæ¶ˆæ¯å†…å®¹ï¼Œè°ƒç”¨å…·ä½“çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;[MQ]æ¶ˆè´¹æ¶ˆæ¯æˆåŠŸ:&#123;&#125;-&#123;&#125;&quot;</span>,msgId,msgBody);</span><br><span class="line">            <span class="keyword">this</span>.mqRecordService.updateRecordStatus(msgId, MqRecordStatusEnum.CONSUMED.getCode());</span><br><span class="line">            <span class="comment">//æ¯ä¸ªå‚æ•°çš„ä½œç”¨</span></span><br><span class="line">            channel.basicAck(msg.getMessageProperties().getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;[MQ]æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥:&#123;&#125;-&#123;&#125;&quot;</span>,msgId,msgBody);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ£€æŸ¥é‡å¤æ£€æŸ¥çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mqRecord</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkRepetableMsg</span><span class="params">(MqRecord mqRecord,String msgBody)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mqRecord != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(mqRecord.getStatus() == MqRecordStatusEnum.CONSUMED.getCode())&#123;</span><br><span class="line">                log.warn(<span class="string">&quot;é‡å¤çš„è¯·æ±‚ï¼Œå¿½ç•¥ &#123;&#125;&quot;</span>,mqRecord.getMsgId());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            log.warn(<span class="string">&quot;æœªçŸ¥çš„ç”³è¯· &#123;&#125;&quot;</span>,msgBody);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ–‡ç« åªæ˜¯è®°å½•äº†ä¸€ä¸‹å¸¸ç”¨çš„ä»£ç ï¼Œä»¥åŠMQä½¿ç”¨ä¸­éœ€è¦æ³¨æ„çš„ç»†èŠ‚ã€‚å®Œæ•´ä»£ç çœ‹<a href="https://github.com/eqshen/RabbitMQBestPractice">è¿™é‡Œ</a>ã€‚</p>
]]></content>
      <categories>
        <category>æ¶ˆæ¯é˜Ÿåˆ—</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>MQ</tag>
        <tag>RabbitMQ</tag>
        <tag>å®è·µ</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootå¯åŠ¨å¼•å¯¼ä¹‹è‡ªåŠ¨æ³¨å…¥</title>
    <url>/2020/06/27/SpringBoot%E5%90%AF%E5%8A%A8%E5%BC%95%E5%AF%BC%E4%B9%8B%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<h3 id="SpringBootç‰ˆæœ¬"><a href="#SpringBootç‰ˆæœ¬" class="headerlink" title="SpringBootç‰ˆæœ¬"></a>SpringBootç‰ˆæœ¬</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2.2.5.RELEASE</span><br></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨æ³¨è§£"><a href="#å¯åŠ¨æ³¨è§£" class="headerlink" title="å¯åŠ¨æ³¨è§£"></a>å¯åŠ¨æ³¨è§£</h3><h4 id="SpringBootApplication"><a href="#SpringBootApplication" class="headerlink" title="@SpringBootApplication"></a>@SpringBootApplication</h4><p>ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œç›¸å½“äºä¸‹é¢ä¸‰ä¸ª</p>
<ul>
<li>@SpringBootConfiguration ï¼ˆ@Configurationï¼‰</li>
<li>@EnableAutoConfiguration</li>
<li>@ComponentScan æŒ‡å®šåŒ…çš„æ‰«æè·¯å¾„</li>
</ul>
<h4 id="ComponentScan"><a href="#ComponentScan" class="headerlink" title="@ComponentScan"></a>@ComponentScan</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(</span></span><br><span class="line"><span class="meta">    excludeFilters = &#123;@Filter(</span></span><br><span class="line"><span class="meta">    type = FilterType.CUSTOM,</span></span><br><span class="line"><span class="meta">    classes = &#123;TypeExcludeFilter.class&#125;</span></span><br><span class="line"><span class="meta">), @Filter(</span></span><br><span class="line"><span class="meta">    type = FilterType.CUSTOM,</span></span><br><span class="line"><span class="meta">    classes = &#123;AutoConfigurationExcludeFilter.class&#125;</span></span><br><span class="line"><span class="meta">)&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ³¨è§£ç”¨äºæŒ‡å®šåŒ…çš„æ‰«æè·¯å¾„ã€‚</p>
<ul>
<li>TypeExcludeFilter ä½œç”¨æ˜¯åš<strong>æ‰©å±•çš„ç»„ä»¶è¿‡æ»¤</strong></li>
<li>AutoConfigurationExcludeFilter è·Ÿè‡ªåŠ¨é…ç½®æœ‰å…³</li>
</ul>
<h4 id="Springä¸­Beançš„è£…é…æ–¹å¼"><a href="#Springä¸­Beançš„è£…é…æ–¹å¼" class="headerlink" title="Springä¸­Beançš„è£…é…æ–¹å¼"></a>Springä¸­Beançš„è£…é…æ–¹å¼</h4><ul>
<li>ä½¿ç”¨æ¨¡å¼æ³¨è§£ <code>@Component</code> ç­‰ï¼ˆSpring2.5+ï¼‰</li>
<li>ä½¿ç”¨é…ç½®ç±» <code>@Configuration</code> ä¸ <code>@Bean</code> ï¼ˆSpring3.0+ï¼‰</li>
<li>ä½¿ç”¨æ¨¡å—è£…é… <code>@EnableXXX</code> ä¸ <code>@Import</code> ï¼ˆSpring3.1+ï¼‰</li>
</ul>
<h5 id="Importçš„å››ç§è£…é…æ–¹å¼"><a href="#Importçš„å››ç§è£…é…æ–¹å¼" class="headerlink" title="@Importçš„å››ç§è£…é…æ–¹å¼"></a>@Importçš„å››ç§è£…é…æ–¹å¼</h5><p>EnableXXXæ³¨è§£ä¸»è¦ä¸@Importé…åˆä½¿ç”¨ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬è¦æŠŠRed,Yellow,Blue,Greenè¿™å‡ ä¸ªç±»åˆ†åˆ«ç”¨ æ™®é€šç±»ã€@Configurationï¼ŒImportSelectorï¼ŒImportBeanDefinitionRegistrarè¿™å››ç§æ–¹å¼æ³¨å…¥åˆ°Springçš„å®¹å™¨ä¸­ã€‚</p>
<ul>
<li>é¦–å…ˆæˆ‘ä»¬å®šä¹‰å››ä¸ªé¢œè‰²ç±»</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Red</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getColor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I am red&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Yellow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getColor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I am yellow&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blue</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getColor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I am blue&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Green</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getColor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I am Green&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="ç¬¬ä¸€ç§ï¼šæ™®é€šç±»"><a href="#ç¬¬ä¸€ç§ï¼šæ™®é€šç±»" class="headerlink" title="ç¬¬ä¸€ç§ï¼šæ™®é€šç±»"></a>ç¬¬ä¸€ç§ï¼šæ™®é€šç±»</h6><p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Import(&#123;Red.class&#125;)</span> <span class="comment">//æ³¨æ„æ­¤å¤„</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableColor &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå®šä¹‰ä¸€ä¸ªé…ç½®ç±»ï¼Œè¿™ä¸ªç±»ä½œç”¨å°±æ˜¯ä½¿ç”¨EnableColoræ³¨è§£ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŠŠEnableColoræ·»åŠ åœ¨SpringBootçš„å¯åŠ¨ç±»ä¸Šï¼Œä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´æ³¨å…¥å¾ˆå¤šä¸åœ¨æˆ‘ä»¬ç›®å‰è§‚å¯ŸèŒƒå›´å†…çš„ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableColor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorRegistrarConfiguration</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå®šä¹‰ä¸€ä¸ªæµ‹è¯•ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext(ColorRegistrarConfiguration.class);</span><br><span class="line">        String[] beanDefinitionNames =  ctx.getBeanDefinitionNames();</span><br><span class="line">        <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;=======&gt; &quot;</span>+beanDefinitionName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºè¾“å‡º:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">=======&gt; org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">=======&gt; org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">=======&gt; colorRegistrarConfiguration</span><br><span class="line">=======&gt; com.eqshen.springprobe.bean.Red</span><br></pre></td></tr></table></figure>



<h6 id="ç¬¬äºŒç§ï¼šConfigurationæ–¹å¼"><a href="#ç¬¬äºŒç§ï¼šConfigurationæ–¹å¼" class="headerlink" title="ç¬¬äºŒç§ï¼šConfigurationæ–¹å¼"></a>ç¬¬äºŒç§ï¼šConfigurationæ–¹å¼</h6><p>ä½¿ç”¨configurationæ–¹å¼å®šä¹‰æ³¨å…¥Yellowç±»å®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Yellow <span class="title">yellow</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Yellow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¿®æ”¹EnableColoræ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Import(&#123;Red.class,ColorConfig.class&#125;)</span> <span class="comment">//æ³¨æ„æ­¤å¤„</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableColor &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ¬¡æ‰§è¡Œä¸Šé¢çš„<code>MainApp#main</code>æ–¹æ³•ï¼Œè¾“å‡ºå†…å®¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">=======&gt; org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">=======&gt; org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">=======&gt; colorRegistrarConfiguration</span><br><span class="line">=======&gt; com.eqshen.springprobe.bean.Red</span><br><span class="line">=======&gt; com.eqshen.springprobe.config.ColorConfig</span><br><span class="line">=======&gt; yellow</span><br></pre></td></tr></table></figure>



<h6 id="ç¬¬ä¸‰ç§ï¼š-ImportSelectoræ–¹å¼"><a href="#ç¬¬ä¸‰ç§ï¼š-ImportSelectoræ–¹å¼" class="headerlink" title="ç¬¬ä¸‰ç§ï¼š ImportSelectoræ–¹å¼"></a>ç¬¬ä¸‰ç§ï¼š ImportSelectoræ–¹å¼</h6><p>å®šä¹‰<code>ColorImportSelector</code>ç±»ï¼Œç»§æ‰¿è‡ª <code>ImportSelector</code>ï¼ŒImportSelectoræ¥å£åªå®šä¹‰äº†ä¸€ä¸ª<code>selectImports()</code>ï¼Œç”¨äºæŒ‡å®šéœ€è¦æ³¨å†Œä¸ºbeançš„Classåç§°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;Blue.class.getName()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¿®æ”¹EnableColoræ³¨è§£ä¸Šçš„Importæ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(&#123;Red.class,ColorConfig.class,ColorImportSelector.class&#125;)</span></span><br></pre></td></tr></table></figure>

<p>å†æ¬¡æ‰§è¡ŒMainApp#mainæ–¹æ³•ï¼Œå¾—åˆ°è¾“å‡º</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">=======&gt; org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">=======&gt; org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">=======&gt; colorRegistrarConfiguration</span><br><span class="line">=======&gt; com.eqshen.springprobe.bean.Red</span><br><span class="line">=======&gt; com.eqshen.springprobe.config.ColorConfig</span><br><span class="line">=======&gt; yellow</span><br><span class="line">=======&gt; com.eqshen.springprobe.bean.Blue</span><br></pre></td></tr></table></figure>



<h6 id="ç¬¬å››ç§-ImportBeanDefinitionRegistraræ–¹å¼"><a href="#ç¬¬å››ç§-ImportBeanDefinitionRegistraræ–¹å¼" class="headerlink" title="ç¬¬å››ç§ ImportBeanDefinitionRegistraræ–¹å¼"></a>ç¬¬å››ç§ ImportBeanDefinitionRegistraræ–¹å¼</h6><p>å®šä¹‰ä¸€ä¸ªç±»<code>ColorImportBeanDefinitionRegistrar</code>å¹¶ç»§æ‰¿ <code>ImportBeanDefinitionRegistrar</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æŒ‡å®šæ³¨å†Œbeanåç§°</span></span><br><span class="line">        registry.registerBeanDefinition(<span class="string">&quot;green&quot;</span>, <span class="keyword">new</span> RootBeanDefinition(Green.class));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¿®æ”¹EnableColoræ³¨è§£ä¸Šçš„Importæ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(&#123;Red.class,ColorConfig.class,ColorImportSelector.class,ColorImportBeanDefinitionRegistrar.class&#125;)</span></span><br></pre></td></tr></table></figure>

<p>å†æ¬¡æ‰§è¡ŒMainApp#mainæ–¹æ³•ï¼Œå¾—åˆ°è¾“å‡º</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">=======&gt; org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">=======&gt; org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">=======&gt; org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">=======&gt; colorRegistrarConfiguration</span><br><span class="line">=======&gt; com.eqshen.springprobe.bean.Red</span><br><span class="line">=======&gt; com.eqshen.springprobe.config.ColorConfig</span><br><span class="line">=======&gt; yellow</span><br><span class="line">=======&gt; com.eqshen.springprobe.bean.Blue</span><br><span class="line">=======&gt; green</span><br></pre></td></tr></table></figure>

<h6 id="å››ç§æ–¹å¼åŒºåˆ«åŠåº”ç”¨åœºæ™¯"><a href="#å››ç§æ–¹å¼åŒºåˆ«åŠåº”ç”¨åœºæ™¯" class="headerlink" title="å››ç§æ–¹å¼åŒºåˆ«åŠåº”ç”¨åœºæ™¯"></a>å››ç§æ–¹å¼åŒºåˆ«åŠåº”ç”¨åœºæ™¯</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(&#123;</span></span><br><span class="line"><span class="meta">  Red.class,</span></span><br><span class="line"><span class="meta">  ColorConfig.class,</span></span><br><span class="line"><span class="meta">  ColorImportSelector.class,</span></span><br><span class="line"><span class="meta">  ColorImportBeanDefinitionRegistrar.class&#125;)</span></span><br></pre></td></tr></table></figure>

<p>å¾…å®šï¼ˆç¨åè¡¥å……ï¼‰</p>
<h4 id="SpringBootçš„è‡ªåŠ¨è£…é…"><a href="#SpringBootçš„è‡ªåŠ¨è£…é…" class="headerlink" title="SpringBootçš„è‡ªåŠ¨è£…é…"></a>SpringBootçš„è‡ªåŠ¨è£…é…</h4><p>SpringBootçš„è‡ªåŠ¨é…ç½®å®Œå…¨ç”± <code>@EnableAutoConfiguration</code> å¼€å¯ã€‚<code>@EnableAutoConfiguration</code>æ˜¯<code>SpringBootApplication</code>ä¸Šçš„æ³¨è§£ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br><span class="line">    String ENABLED_OVERRIDE_PROPERTY = <span class="string">&quot;spring.boot.enableautoconfiguration&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="AutoConfigurationPackage"><a href="#AutoConfigurationPackage" class="headerlink" title="@AutoConfigurationPackage"></a>@AutoConfigurationPackage</h5><p>è‡ªåŠ¨æ‰«æå°†ä»æ ‡æ³¨æ­¤æ³¨è§£çš„ç±»æ‰€åœ¨çš„åŒ…å¼€å§‹ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(&#123;Registrar.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£è¿™ä¸ª<code>Registrar.class</code>ä½œç”¨æ˜¯å•¥å‘¢ï¼Ÿå®ƒæ˜¯<code>AutoConfigurationPackages.java</code>çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> ImportBeanDefinitionRegistrar&#125; to store the base package from the importing</span></span><br><span class="line"><span class="comment">	 * configuration.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Registrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">DeterminableImports</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">			register(registry, <span class="keyword">new</span> PackageImport(metadata).getPackageName());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">determineImports</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> PackageImport(metadata));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æ³¨é‡Šè¯´æ˜æ¥çœ‹ï¼Œè¿™ä¸ªRegistrarçš„åŠŸèƒ½ä¸»è¦å°±æ˜¯ç”¨æ¥ä¿å­˜ base packageçš„nameä»¥ä¾¿åç»­ä½¿ç”¨ã€‚<code>AnnotationMetadata metadata</code>å°±æ˜¯æ ¹ç›®å½•çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œè¿™é‡Œæš‚æ—¶ä¸æ·±å…¥ã€‚</p>
<p>basePackageçš„ä½œç”¨ï¼šé™¤äº†Springè‡ªå·±ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥æä¾›ç»™ä¸‰æ–¹æ’ä»¶ï¼Œå¦‚Mybatisç­‰ã€‚</p>
<h5 id="Import-AutoConfigurationImportSelector-class"><a href="#Import-AutoConfigurationImportSelector-class" class="headerlink" title="@Import(AutoConfigurationImportSelector.class)"></a>@Import(AutoConfigurationImportSelector.class)</h5><p>ImportSelectoræˆ‘ä»¬ä¹‹å‰æœ‰æåˆ°è¿‡ï¼Œå¦‚<code>ColorImportSelector</code>ï¼Œçœ‹ä¸€ä¸‹<code>AutoConfigurationImportSelector.class</code>å…³é”®æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">			<span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">		&#125;</span><br><span class="line">		AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">				.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">		AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(autoConfigurationMetadata,</span><br><span class="line">				annotationMetadata);</span><br><span class="line">		<span class="keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°çš„ä½œç”¨æ˜¯æ ¹æ®è¾“å…¥<code>annotationMetadata</code>ï¼Œè¾“å‡ºéœ€è¦è¢«importçš„ç±»åæ•°ç»„ã€‚å…¶ä¸­ï¼Œ<code>loadMetadata</code>æ–¹æ³•æ˜¯æŠŠ<code>META-INF/spring.factories</code>é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹åŠ è½½å°è£…æˆ AutoConfigurationMetadataã€‚</p>
<p>spring.factoriesä¸­é…ç½®å¦‚ä¸‹ï¼ˆæ ¼å¼ï¼‰ï¼škeyName=a,b,c</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Auto Configuration Import Filters</span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter&#x3D;\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnBeanCondition,\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnClassCondition,\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition</span><br><span class="line"></span><br><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration&#x3D;\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ Properties ä¸­å‘ç°ï¼Œæ‰€æœ‰é…ç½®çš„ EnableAutoConfiguration çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œéƒ½<strong>ä»¥ AutoConfiguration ç»“å°¾</strong>ï¼ç”±æ­¤è§„å¾‹ï¼Œä»¥åæˆ‘ä»¬è¦äº†è§£ä¸€ä¸ª SpringBoot çš„æ¨¡å—æˆ–è€…ç¬¬ä¸‰æ–¹é›†æˆçš„æ¨¡å—æ—¶ï¼Œå°±å¯ä»¥<strong>å¤§èƒ†çŒœæµ‹åŸºæœ¬ä¸Šä¸€å®šä¼šæœ‰ XXXAutoConfiguration ç±»å‡ºç°</strong>ï¼</p>
]]></content>
      <categories>
        <category>SpringBoot</category>
        <category>æºç </category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>å®ç°è‡ªå·±çš„SpringBoot Starter</title>
    <url>/2020/09/05/create-your-starter/</url>
    <content><![CDATA[<h3 id="é¢˜å¤–è¯"><a href="#é¢˜å¤–è¯" class="headerlink" title="é¢˜å¤–è¯"></a>é¢˜å¤–è¯</h3><p>å‰ä¸¤ä¸ªæœˆå› ä¸ºå·¥ä½œå˜åŠ¨ï¼Œæ°´åšå®¢çš„èŠ‚å¥æœ‰ç‚¹æ…¢ï¼Œå¹³æ—¶ä¸ºäº†ç†Ÿæ‚‰å…¬å¸ä¸šåŠ¡ï¼ŒåŠ ä¸Šæ–°å…¬å¸åŠ ç­è¾ƒå¤šï¼Œè½ä¸‹äº†â€¦.ç°åœ¨ç»§ç»­å¼€å§‹æ°´</p>
<h3 id="è¦åšå•¥ï¼Ÿ"><a href="#è¦åšå•¥ï¼Ÿ" class="headerlink" title="è¦åšå•¥ï¼Ÿ"></a>è¦åšå•¥ï¼Ÿ</h3><p>ä¹‹å‰æœ‰äº†è§£è¿‡SpringBootå¯åŠ¨æµç¨‹ï¼Œå…¶ä¸­ä¸€å—å°±æ¶‰åŠåˆ°SpringBoot Starterçš„å†…å®¹ï¼Œç°åœ¨å…¬å¸å°è£…çš„ä¸œè¥¿åŸºæœ¬ä¸Šéƒ½æ˜¯é…åˆSpringBootå¿«é€Ÿä½¿ç”¨çš„ï¼Œæ¯”å¦‚å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œç„¶ååŠ ä¸ª@EnableXXXXæ³¨è§£ï¼Œå°±å¯ä»¥äº†ã€‚ã€‚ã€‚ä»Šå¤©è¦å®ç°ä¸€ä¸ªè‡ªå·±çš„SpringBoot starter,ç”¨æ¥å®ç°æ‰“å°æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œæƒ­æ„§çš„æƒ³åˆ°äº†ä¹‹å‰è‡ªå·±çš„å®ç°æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public String getUserInfo()&#123;</span><br><span class="line">        long startTs &#x3D; System.currentTimeMillis();</span><br><span class="line">        &#x2F;&#x2F;ä¸šåŠ¡é€»è¾‘</span><br><span class="line"></span><br><span class="line">        long endTs &#x3D; System.currentTimeMillis();</span><br><span class="line">        &#x2F;&#x2F;è¾“å‡ºæ—¶é—´</span><br><span class="line">        log.info(&quot;getUserInfo ç”¨æ—¶ï¼š&#123;&#125; ms&quot;,endTs - startTs);</span><br><span class="line">        return &quot;xxx&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ— ç–‘æ˜¯æ„šè ¢çš„ï¼Œè®°å¾—æœ‰ä¸€æ¬¡ï¼Œé¢†å¯¼æ‰¾åˆ°æˆ‘ï¼šâ€˜xxx,ä½ æ‹‰ä¸€ä¸‹æ—¥å¿—ï¼Œç±»ä¼¼äºä¸Šé¢è¿™ç§æœ‰è®¡ç®—æ‰§è¡Œç”¨æ—¶çš„æ‰€æœ‰å½“å¤©æ—¥å¿—ï¼Œç„¶åè®¡ç®—ä¸€ä¸‹æ¯ä¸ªæ–¹æ³•çš„å¹³å‡è€—æ—¶ï¼Œ95çº¿ç­‰ï¼Œâ€™ï¼Œæˆ‘ï¼šï¼Ÿï¼Ÿï¼Ÿ<br>å½“åœºå°±æ‡µé€¼äº†ï¼Œå› ä¸ºæ¯ä¸ªæ–¹æ³•é‡Œæ‰“å°çš„æ—¥å¿—æ ¼å¼éƒ½ä¸ç»Ÿä¸€ï¼Œç»Ÿè®¡èµ·æ¥å°±å¾ˆè´¹åŠ›äº†ï¼Œå¦‚ï¼š</p>
<ul>
<li><code>log .info(&quot;xxx è€—æ—¶ï¼š&#123;&#125; ms&quot;,endTs - startTs);</code></li>
<li><code>log .info(&quot;xxx ç”¨æ—¶ï¼š&#123;&#125; æ¯«ç§’&quot;,endTs - startTs);</code></li>
<li><code>log .info(&quot;xxx ç”¨æ—¶ &#123;&#125; ç§’&quot;,ï¼ˆendTs - startTs)/1000);</code></li>
</ul>
<h3 id="æ€ä¹ˆåšæ›´å¥½ï¼Ÿ"><a href="#æ€ä¹ˆåšæ›´å¥½ï¼Ÿ" class="headerlink" title="æ€ä¹ˆåšæ›´å¥½ï¼Ÿ"></a>æ€ä¹ˆåšæ›´å¥½ï¼Ÿ</h3><ul>
<li>å½“ç„¶ï¼Œæˆ‘ç¬¬ä¸€æ—¶é—´æ˜¯æƒ³åˆ°äº† å°è£…ä¸€ä¸ªUtilï¼Œåœ¨æ‰€æœ‰éœ€è¦æ‰“å°æ—¶é—´çš„åœ°æ–¹ï¼Œéƒ½è°ƒç”¨å®ƒï¼Œè¿™æ ·ï¼Œè¾“å‡ºçš„æ ¼å¼å°±å¯ä»¥ç»Ÿä¸€äº†ã€‚ä½†æ˜¯ï¼Œä»£ç è¿˜æ˜¯ä¾µå…¥äº†ä¸šåŠ¡ä»£ç ï¼ŒæŸå¤©æƒ³åœç”¨ï¼Œå°±å¾ˆä¸æ–¹ä¾¿ã€‚</li>
<li>å¦ä¸€ç§æ¯”è¾ƒå¥½çš„åšæ³•å°±æ˜¯åˆ©ç”¨aopäº†ï¼Œä»Šå¤©å°±è¯•è¯•æ‰‹ã€‚å½“ç„¶è¿˜æœ‰æ›´å¥½çš„ï¼Œå¦‚ç‚¹è¯„å¼€æºçš„Catä¹‹ç±»çš„ï¼Œæ›´ä¸“ä¸šã€‚</li>
</ul>
<h3 id="åŠ¨æ‰‹å®è·µ"><a href="#åŠ¨æ‰‹å®è·µ" class="headerlink" title="åŠ¨æ‰‹å®è·µ"></a>åŠ¨æ‰‹å®è·µ</h3><ul>
<li>å¼€å§‹ä¹‹å‰è¦å¯¹SpringBootçš„å¯åŠ¨æµç¨‹æœ‰ç®€å•çš„äº†è§£ï¼Œç‰¹åˆ«æ˜¯ImportSelectorè¿™äº›</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼ŒAOPç›¸å…³çŸ¥è¯†ä¹Ÿå¿…ä¸å¯å°‘ï¼Œå¦‚@Aspectä½¿ç”¨ç­‰ã€‚</li>
</ul>
<h4 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h4><ul>
<li>é€šè¿‡AOPå®ç°æ— ä¾µå…¥çš„æ‰“å°ç‰¹å®šæ ¼å¼æ—¥å¿—çš„åŠŸèƒ½</li>
<li>å¯ä»¥å°è£…æˆæ¨¡å—ï¼Œæ–¹ä¾¿å¤ç”¨</li>
<li>åœ¨æŸæ–¹æ³•ä¸Šæ·»åŠ æŒ‡å®šæ³¨è§£å³å¯æ‰“å°è¯¥æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´</li>
<li>æ¨¡å—è¿›å…¥ä¹‹åé€šè¿‡æ€»å¼€å…³æ§åˆ¶ï¼š@EnableXXXX</li>
</ul>
<h4 id="é¡¹ç›®ä¾èµ–"><a href="#é¡¹ç›®ä¾èµ–" class="headerlink" title="é¡¹ç›®ä¾èµ–"></a>é¡¹ç›®ä¾èµ–</h4><p>è¿™é‡Œä»…ç»™å‡ºäº†å…³é”®éƒ¨åˆ†çš„ä¾èµ–ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-autoconfigure&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-configuration-processor&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-aop&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.slf4j&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;slf4j-api&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.7.30&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="å®šä¹‰åœ¨æ–¹æ³•ä¸Šä½¿ç”¨çš„æ³¨è§£"><a href="#å®šä¹‰åœ¨æ–¹æ³•ä¸Šä½¿ç”¨çš„æ³¨è§£" class="headerlink" title="å®šä¹‰åœ¨æ–¹æ³•ä¸Šä½¿ç”¨çš„æ³¨è§£"></a>å®šä¹‰åœ¨æ–¹æ³•ä¸Šä½¿ç”¨çš„æ³¨è§£</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface LogUsedTime &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * è‡ªå®šä¹‰è¾“å‡ºçš„æ–¹æ³•åå­—,ä¸æŒ‡å®šåˆ™å–æ–¹æ³•å</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    String aliasMethodName() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * æ—¥å¿—çº§åˆ«</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    LogLevel logLevel() default LogLevel.INFO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰aopåˆ‡é¢å¤„ç†ç±»"><a href="#å®šä¹‰aopåˆ‡é¢å¤„ç†ç±»" class="headerlink" title="å®šä¹‰aopåˆ‡é¢å¤„ç†ç±»"></a>å®šä¹‰aopåˆ‡é¢å¤„ç†ç±»</h4><p>æŒ‡å®šåˆ‡ç‚¹ä»¥åŠåˆ‡é¢é€»è¾‘</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Aspect</span><br><span class="line">@EnableAspectJAutoProxy(exposeProxy &#x3D; true,proxyTargetClass &#x3D; true)</span><br><span class="line">public class LogUsedTimeAspect implements PriorityOrdered &#123;</span><br><span class="line"></span><br><span class="line">    private Logger log &#x3D; LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * å®šä¹‰åˆ‡ç‚¹</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Pointcut(&quot;@annotation(com.eqshen.anno.LogUsedTime)&quot;)</span><br><span class="line">    private void logUsedTimeAnnotationCut()&#123;&#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„åˆ‡ç‚¹</span><br><span class="line">    @Around(value &#x3D; &quot;logUsedTimeAnnotationCut() &amp;&amp; @annotation(logUsedTime)&quot;)</span><br><span class="line">    public Object methodExecute(ProceedingJoinPoint point, LogUsedTime logUsedTime) throws Throwable &#123;</span><br><span class="line">        String aliasMethodName &#x3D; logUsedTime.aliasMethodName();</span><br><span class="line">        LogLevel logLevel &#x3D; logUsedTime.logLevel();</span><br><span class="line"></span><br><span class="line">        String methodName &#x3D; point.getSignature().getName();</span><br><span class="line">        if(!StringUtils.isEmpty(aliasMethodName))&#123;</span><br><span class="line">            methodName &#x3D; aliasMethodName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        long startTimestamp &#x3D; System.currentTimeMillis();</span><br><span class="line">        Object result &#x3D; point.proceed();</span><br><span class="line">        long endTimestamp &#x3D; System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;log</span><br><span class="line">        doLog(logLevel,methodName,endTimestamp - startTimestamp);</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void doLog(LogLevel logLevel,String methodName,long usedTimeMs)&#123;</span><br><span class="line">        String format &#x3D; String.format(&quot;[Time Use] Task %s used time: %d ms&quot;, methodName,usedTimeMs);</span><br><span class="line"></span><br><span class="line">        switch (logLevel)&#123;</span><br><span class="line">            case OFF:</span><br><span class="line">                &#x2F;&#x2F;do nothing</span><br><span class="line">                break;</span><br><span class="line">            case WARN:</span><br><span class="line">                log.warn(format);</span><br><span class="line">                break;</span><br><span class="line">            case DEBUG:</span><br><span class="line">                log.debug(format);</span><br><span class="line">                break;</span><br><span class="line">            case ERROR:</span><br><span class="line">                log.error(format);</span><br><span class="line">                break;</span><br><span class="line">            case FATAL:</span><br><span class="line">                log.error(format);</span><br><span class="line">                break;</span><br><span class="line">            case TRACE:</span><br><span class="line">                log.trace(format);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                log.info(format);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * aopä¼˜å…ˆçº§æ”¾ç½®åœ¨æœ€å</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        return Integer.MAX_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="å®šä¹‰è‡ªåŠ¨å¼•å…¥Selector"><a href="#å®šä¹‰è‡ªåŠ¨å¼•å…¥Selector" class="headerlink" title="å®šä¹‰è‡ªåŠ¨å¼•å…¥Selector"></a>å®šä¹‰è‡ªåŠ¨å¼•å…¥Selector</h4><p>è‡ªå®šä¹‰Selectorï¼Œåœ¨SpringBootå¯åŠ¨é˜¶æ®µå¯ä»¥è‡ªåŠ¨è£…è½½æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„aopåˆ‡é¢å¤„ç†ç±»ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class EnableEQTimeLogSelector implements ImportSelector &#123;</span><br><span class="line"></span><br><span class="line">    private Logger log &#x3D; LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        log.info(&quot;(*^â–½^*) EQTimeLogç»„ä»¶å¯ç”¨...OK&quot;);</span><br><span class="line">        return new String[]&#123;LogUsedTimeAspect.class.getName()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="å®šä¹‰æ€»å¼€å…³-EnableXXX"><a href="#å®šä¹‰æ€»å¼€å…³-EnableXXX" class="headerlink" title="å®šä¹‰æ€»å¼€å…³ @EnableXXX"></a>å®šä¹‰æ€»å¼€å…³ @EnableXXX</h4><p>è‡ªå®šä¹‰å¼€å…³æ³¨è§£ï¼ŒæŒ‚è½½Selectorï¼Œè®©ä¸€åˆ‡å˜å¾—ç®€å•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * å¼€å…³</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Import(EnableEQTimeLogSelector.class)</span><br><span class="line">public @interface EnableEQTimeLog &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="ä½¿ç”¨-amp-æµ‹è¯•"><a href="#ä½¿ç”¨-amp-æµ‹è¯•" class="headerlink" title="ä½¿ç”¨ &amp; æµ‹è¯•"></a>ä½¿ç”¨ &amp; æµ‹è¯•</h4><p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„SpringBooté¡¹ç›®ï¼Œä¾èµ–æˆ‘ä»¬ ä¸Šé¢çš„é¡¹ç›®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.eqshen&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;time-log-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºæµ‹è¯•ç±»</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class TestService &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;ä½¿ç”¨æ³¨è§£ï¼Œè¾“å‡ºæ–¹æ³•æ‰§è¡Œè€—æ—¶</span><br><span class="line">    @LogUsedTime(aliasMethodName &#x3D; &quot;æ‰“æ‹›å‘¼&quot;)</span><br><span class="line">    public String sayHello(String name)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;hello &quot;+ name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™Junitå•å…ƒæµ‹è¯•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@SpringBootTest</span><br><span class="line">&#x2F;&#x2F;æ³¨æ„è¿™é‡Œï¼Œå¼€å¯åŠŸèƒ½</span><br><span class="line">@EnableEQTimeLog</span><br><span class="line">class EqlogDemoApplicationTests &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private TestService testService;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    void contextLoads() &#123;</span><br><span class="line">        testService.sayHello(&quot;tom&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸€ä¸‹æ—¥å¿—è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">2020-09-09 23:56:48.572  INFO 10589 --- [           main] com.demo.EqlogDemoApplicationTests       : No active profile set, falling back to default profiles: default</span><br><span class="line">2020-09-09 23:56:48.655  INFO 10589 --- [           main] c.e.selector.EnableEQTimeLogSelector     : (*^â–½^*) EQTimeLogç»„ä»¶å¯ç”¨...OK</span><br><span class="line">2020-09-09 23:56:49.201  INFO 10589 --- [           main] com.demo.EqlogDemoApplicationTests       : Started EqlogDemoApplicationTests in 15.8 seconds (JVM running for 16.704)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">2020-09-09 23:56:50.342  INFO 10589 --- [           main] com.eqshen.aspect.LogUsedTimeAspect      : [Time Use] Task æ‰“æ‹›å‘¼ used time: 1015 ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>è‡³æ­¤ï¼Œæ•´ç¯‡æ–‡ç« æ°´å®Œäº†ã€‚æ²¡æœ‰ä»»ä½•éš¾åº¦çš„demoï¼Œä»…ä»…æ˜¯ç†Ÿæ‚‰å¦‚ä½•è‡ªå®šä¹‰starterï¼Œä»¥åŠä¹‹å‰å­¦ä¹ è¿‡@Importè¿™äº›çŸ¥è¯†çš„ç®€å•å®è·µã€‚<br>è™½ç„¶å¾ˆç®€å•ï¼Œä½†æ˜¯åœ¨å®æ“çš„æ—¶å€™è¿˜æ˜¯å¯èƒ½ä¼šé‡åˆ°æ„æƒ³ä¸åˆ°çš„é—®é¢˜ï¼Œå¦‚ mavenæ— æ³•å¼•ç”¨æœ¬åœ°ä»“åº“çš„jarï¼ˆç‰ˆæœ¬åŸå› ç­‰ï¼‰ã€‚å…±å‹‰ã€‚</p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>å†è°ˆäº‹åŠ¡</title>
    <url>/2020/10/02/%E5%86%8D%E8%B0%88%E4%BA%8B%E5%8A%A1/</url>
    <content><![CDATA[<h2 id="å†è°ˆäº‹åŠ¡"><a href="#å†è°ˆäº‹åŠ¡" class="headerlink" title="å†è°ˆäº‹åŠ¡"></a>å†è°ˆäº‹åŠ¡</h2><p>æœ€è¿‘åœ¨å¤ä¹ äº‹åŠ¡ç›¸å…³çš„çŸ¥è¯†ï¼Œç»“åˆå®é™…å·¥ä½œä¸­çš„æ–¹æ¡ˆï¼ŒåŠ æ·±å¯¹äº‹åŠ¡çš„ç†è§£</p>
<h3 id="ä¸€ã€åŸºç¡€æ¦‚å¿µå›é¡¾"><a href="#ä¸€ã€åŸºç¡€æ¦‚å¿µå›é¡¾" class="headerlink" title="ä¸€ã€åŸºç¡€æ¦‚å¿µå›é¡¾"></a>ä¸€ã€åŸºç¡€æ¦‚å¿µå›é¡¾</h3><h4 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h4><ul>
<li><p>Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šå¤šä¸ªå†™æ“ä½œï¼Œè¦å…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥/å›æ»š </p>
</li>
<li><p>Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼š</p>
<ul>
<li><p>äº‹åŠ¡å¯ä»¥ä¿éšœæ•°æ®åº“ä»ä¸€ä¸ªçŠ¶æ€è½¬ç§»åˆ°å¦ä¸€ä¸ªçŠ¶æ€ï¼Œæ²¡æœ‰ä¸­é—´çŠ¶æ€ã€‚ï¼ˆå¦‚Aå‘Bè½¬è´¦ï¼‰</p>
</li>
<li><p>ä¸­é—´çŠ¶æ€ä¸å¯ä»¥è¢«è§‚å¯Ÿåˆ°ã€‚</p>
<blockquote>
<p>é’ˆå¯¹â€œä¸­é—´çŠ¶æ€â€è¯´ä¸‹ä¸ªäººç†è§£ï¼Œåœ¨å¼ºä¸€è‡´æ€§çš„äº‹åŠ¡ä¸­ï¼Œè‚¯å®šæ˜¯è¦æ±‚æ— æ³•è¢«è§‚å¯Ÿåˆ°çš„ï¼›ä½†æ˜¯åœ¨å¼±ä¸€è‡´æ€§çš„æŸ”æ€§äº‹åŠ¡ä¸­ï¼Œä¸­é—´çŠ¶æ€æ˜¯å¯ä»¥è¢«è§‚å¯Ÿåˆ°çš„ï¼Œåªè¦æ»¡è¶³æœ€ç»ˆä¸€è‡´æ€§å³å¯ã€‚</p>
</blockquote>
</li>
</ul>
</li>
<li><p>Isolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šä¸¤ä¸ªå¹¶å‘çš„äº‹åŠ¡åœ¨æ‰§è¡Œæ—¶ï¼Œäº’ä¸å½±å“ã€‚äº‹åŠ¡1å¯¹æŸä¸ªæ•°å€¼çš„ä¿®æ”¹ä¸èƒ½å½±å“åˆ°äº‹åŠ¡2ï¼Œäº‹åŠ¡2ä¹Ÿä¸çŸ¥é“äº‹åŠ¡1å¹²äº†å•¥ï¼Œå®Œå…¨æ˜¯ä¸¤ä¸ªé»‘ç›’æ“ä½œã€‚å½“å¦‚æœä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å¯¹æŸä¸€èµ„æºè¿›è¡Œè®¿é—®æ—¶ï¼Œå°±è¦è¿›è¡ŒåŠ é”æ§åˆ¶ï¼Œå¹¶è¡Œå˜ä¸²è¡Œï¼Œä½†ä¾ç„¶æ»¡è¶³â€œå¹¶å‘â€çš„æ¦‚å¿µã€‚</p>
</li>
<li><p>Durablityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æˆåŠŸæäº¤åï¼Œæ›´æ”¹æ°¸ä¹…ä¿å­˜ï¼Œä¸èƒ½å›æ»šã€‚</p>
</li>
</ul>
<h4 id="éš”ç¦»çº§åˆ«"><a href="#éš”ç¦»çº§åˆ«" class="headerlink" title="éš”ç¦»çº§åˆ«"></a>éš”ç¦»çº§åˆ«</h4><table>
<thead>
<tr>
<th>äº‹åŠ¡éš”ç¦»çº§åˆ«</th>
<th>å‘ç”Ÿè„è¯»</th>
<th>ä¸å¯é‡å¤è¯»</th>
<th>å‘ç”Ÿå¹»è¯»</th>
</tr>
</thead>
<tbody><tr>
<td>Read Uncommitted è¯»æœªæäº¤</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>Read Committed è¯»å·²æäº¤ï¼ˆä¸å¯é‡å¤è¯»ï¼‰</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>Repeatable Read å¯é‡å¤è¯»</td>
<td>å¦</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>Serializable ä¸²è¡ŒåŒ–</td>
<td>å¦</td>
<td>å¦</td>
<td>å¦</td>
</tr>
</tbody></table>
<ul>
<li>è„è¯»ï¼šäº‹åŠ¡Aè¯»å–äº†äº‹åŠ¡Bæ›´æ–°çš„æ•°æ®ï¼Œç„¶åBå›æ»šæ“ä½œï¼Œé‚£ä¹ˆAè¯»å–åˆ°çš„æ•°æ®æ˜¯è„æ•°æ®</li>
<li>ä¸å¯é‡å¤è¯»ï¼šäº‹åŠ¡ A å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œäº‹åŠ¡ B åœ¨äº‹åŠ¡Aå¤šæ¬¡è¯»å–çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹æ•°æ®ä½œäº†æ›´æ–°å¹¶æäº¤ï¼Œå¯¼è‡´äº‹åŠ¡Aå¤šæ¬¡è¯»å–åŒä¸€æ•°æ®æ—¶ï¼Œç»“æœ ä¸ä¸€è‡´ã€‚å…³æ³¨ç‚¹æ˜¯å·²å­˜åœ¨æ•°æ®çš„ä¿®æ”¹ã€‚</li>
<li>å¹»è¯»ï¼šè·ŸRCå®¹æ˜“æ··ï¼Œä¸¾ä¾‹ï¼šäº‹åŠ¡Aè¯»å–æŸç­çº§æ‰€æœ‰å­¦ç”Ÿæ•°æ®å…±32äººï¼Œç„¶åäº‹åŠ¡Bæ’å…¥äº†2åæ–°å­¦ç”Ÿæ•°æ®åˆ°è¯¥ç­çº§ï¼Œäº‹åŠ¡Aå†æ¬¡è¯»å–æ‰€æœ‰å­¦ç”Ÿæ•°æ®ï¼Œå‘ç°æœ‰34äººã€‚äº‹åŠ¡A:â€æ€ä¹ˆå˜æˆ34äº†éš¾é“åˆšæ‰æˆ‘å‘ç”Ÿå¹»è§‰äº†ï¼Ÿâ€â€¦.è¿™å°±æ˜¯å¹»è¯»ï¼Œå…³æ³¨ç‚¹åœ¨è¡Œæ•°çš„å¢åŠ ã€‚<blockquote>
<p>å¦‚æœæ˜¯å‡å°‘2äººï¼Œè¿˜æ˜¯å¹»è¯»å—ï¼Ÿç­”æ¡ˆï¼šä¸æ˜¯äº†ã€‚<code>å¹»è¯»</code>å¼ºè°ƒçš„æ˜¯ä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§æŸä¸ªç›¸åŒæ¡ä»¶å¤šæ¬¡è¯»å–è®°å½•æ—¶ï¼Œåè¯»å–æ—¶è¯»åˆ°äº†ä¹‹å‰æ²¡æœ‰è¯»åˆ°çš„è®°å½•ã€‚æ‰€ä»¥<code>å‡å°‘ä¸¤äºº</code>è¿™ç§æƒ…å†µåº”è¯¥ç®—æ˜¯ <strong>ä¸å¯é‡å¤è¯»</strong>ã€‚</p>
</blockquote>
</li>
</ul>
<h3 id="äºŒã€åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#äºŒã€åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="äºŒã€åˆ†å¸ƒå¼äº‹åŠ¡"></a>äºŒã€åˆ†å¸ƒå¼äº‹åŠ¡</h3><h5 id="1-ä½•ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡"><a href="#1-ä½•ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="1.ä½•ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡"></a>1.ä½•ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡</h5><p>ç›¸å¯¹äºæœ¬åœ°äº‹åŠ¡è€Œè¨€ï¼Œåœ¨SOAç­‰æ¶æ„ä¸‹ï¼Œç”¨æˆ·ä¸€æ¬¡æ“ä½œï¼Œéœ€è¦ä¿®æ”¹<strong>å¤šä¸ªæ•°æ®åº“</strong>çš„æ•°æ®ä¸”è¦æ±‚è¯¥æ¬¡æ“ä½œè¦æ»¡è¶³äº‹åŠ¡ç‰¹æ€§ï¼ˆACIDï¼‰, è€Œè·¨è¶Šäº†å¤šä¸ªæ•°æ®åº“å®ä¾‹çš„æƒ…å†µä¸‹ï¼Œå•æœºäº‹åŠ¡å°±ä¸é€‚ç”¨äº†ã€‚</p>
<p><strong>ä¸¾ä¸ªæ —å­</strong>ï¼šç”¨æˆ·çš„èµ„äº§ä½™é¢æ•°æ®ä¿å­˜åœ¨ è®¢å•åº“Aï¼Œè€Œç”¨æˆ·çš„ç§¯åˆ†ä¿å­˜åœ¨ æ´»åŠ¨åº“Bï¼Œåº“å­˜æ•°æ®ä¿å­˜åœ¨ å•†å“åº“Cã€‚æŒ‰ç…§ä¸šåŠ¡è¦æ±‚ï¼Œç”¨æˆ·å®Œæˆä¸€ç¬”ä¸‹å•ï¼Œè¦èµ é€è®¢å•é‡‘é¢*100çš„æ´»åŠ¨ç§¯åˆ†ã€‚é‚£ä¹ˆç”¨æˆ·å•æ¬¡çš„ä¸‹å•è¡Œä¸ºå°±è‡³å°‘å­˜åœ¨ä»¥ä¸‹æ•°æ®åº“ä¿®æ”¹ï¼š</p>
<ul>
<li>è®¢å•åº“A é‡‘é¢å‡å°‘ xå…ƒ</li>
<li>è®¢å•åº“B ç”¨æˆ·ç§¯åˆ†å¢åŠ  x*100ç‚¹</li>
<li>å•†å“åº“C è¦è¿›è¡Œæ‰£åº“å­˜æ“ä½œ</li>
</ul>
<p>ä»¥ä¸Š å°±æ˜¯å…¸å‹éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯äº†ã€‚</p>
<h5 id="2-åˆ†å¸ƒå¼ç†è®º"><a href="#2-åˆ†å¸ƒå¼ç†è®º" class="headerlink" title="2. åˆ†å¸ƒå¼ç†è®º"></a>2. åˆ†å¸ƒå¼ç†è®º</h5><p>æ¯”è¾ƒå¸¸è§çš„ä¸»è¦æ˜¯<strong>CAPç†è®º</strong>å’Œ<strong>BASEç†è®º</strong>ï¼Œè¿™é‡Œä¸åšä»‹ç»å¯ä»¥è‡ªè¡Œç™¾åº¦å¤ä¹ ã€‚</p>
<h3 id="ä¸‰ã€å¸¸è§çš„åˆ†å¸ƒå¼æ–¹æ¡ˆ-XAä¸TCC"><a href="#ä¸‰ã€å¸¸è§çš„åˆ†å¸ƒå¼æ–¹æ¡ˆ-XAä¸TCC" class="headerlink" title="ä¸‰ã€å¸¸è§çš„åˆ†å¸ƒå¼æ–¹æ¡ˆ(XAä¸TCC)"></a>ä¸‰ã€å¸¸è§çš„åˆ†å¸ƒå¼æ–¹æ¡ˆ(XAä¸TCC)</h3><h4 id="1-DTPæ¨¡å‹-äºŒé˜¶æ®µæäº¤ï¼ˆ2PCï¼‰"><a href="#1-DTPæ¨¡å‹-äºŒé˜¶æ®µæäº¤ï¼ˆ2PCï¼‰" class="headerlink" title="1.DTPæ¨¡å‹-äºŒé˜¶æ®µæäº¤ï¼ˆ2PCï¼‰"></a>1.DTPæ¨¡å‹-äºŒé˜¶æ®µæäº¤ï¼ˆ2PCï¼‰</h4><blockquote>
<p>Distributed Transaction Processingï¼ˆDTPï¼‰é‡‡ç”¨çš„æ˜¯XAåè®®</p>
</blockquote>
<p>æ¨¡å‹ä¸­æ¶‰åŠåˆ°çš„è§’è‰²</p>
<ul>
<li>TM,Transaction Manager äº‹åŠ¡ç®¡ç†å™¨ï¼ˆä¹Ÿç§°åè°ƒè€…ï¼‰</li>
<li>RM, Resource Manager èµ„æºç®¡ç†å™¨ï¼ˆä¹Ÿç§°å‚ä¸è€…ï¼‰</li>
<li>AP,Application åº”ç”¨ï¼Œé€šå¸¸å’ŒRMçœ‹åšä¸€ä¸ªæ•´ä½“</li>
</ul>
<h5 id="ç¬¬ä¸€é˜¶æ®µ-æŠ•ç¥¨é˜¶æ®µ"><a href="#ç¬¬ä¸€é˜¶æ®µ-æŠ•ç¥¨é˜¶æ®µ" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µ æŠ•ç¥¨é˜¶æ®µ"></a>ç¬¬ä¸€é˜¶æ®µ æŠ•ç¥¨é˜¶æ®µ</h5><p>ç›®çš„ï¼šTMè¯¢é—®å„ä¸ªæ•°æ®åº“å®ä¾‹å‚ä¸è€…RM æ˜¯å¦å…·å¤‡æ­£å¸¸æ‰§è¡Œäº‹åŠ¡çš„æ¡ä»¶ã€‚</p>
<p>ä¸»è¦æ­¥éª¤</p>
<ol>
<li>åè°ƒè€…å‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€äº‹åŠ¡æ‰§è¡Œè¯·æ±‚ï¼Œå¹¶ç­‰å¾…å‚ä¸è€…åé¦ˆäº‹åŠ¡æ‰§è¡Œç»“æœ</li>
<li>äº‹åŠ¡å‚ä¸è€…æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œæ‰§è¡Œäº‹åŠ¡ï¼Œ<strong>ä½†ä¸æäº¤</strong>ï¼Œå¹¶è®°å½•äº‹åŠ¡æ—¥å¿—ã€‚</li>
<li>å‚ä¸è€…å°†è‡ªå·±äº‹åŠ¡æ‰§è¡Œæƒ…å†µåé¦ˆç»™åè°ƒè€…ï¼ŒåŒæ—¶<strong>é˜»å¡ç­‰å¾…</strong>åè°ƒè€…çš„åç»­æŒ‡ä»¤ã€‚</li>
</ol>
<h5 id="ç¬¬äºŒé˜¶æ®µ-äº‹åŠ¡æäº¤é˜¶æ®µ"><a href="#ç¬¬äºŒé˜¶æ®µ-äº‹åŠ¡æäº¤é˜¶æ®µ" class="headerlink" title="ç¬¬äºŒé˜¶æ®µ äº‹åŠ¡æäº¤é˜¶æ®µ"></a>ç¬¬äºŒé˜¶æ®µ äº‹åŠ¡æäº¤é˜¶æ®µ</h5><p>ç¬¬ä¸€é˜¶æ®µçš„è¯¢é—®å°†ä¼šå‡ºç°ä¸‰ç§æƒ…å†µ</p>
<ol>
<li>æ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›æˆåŠŸ</li>
<li>éƒ¨åˆ†å‚ä¸è€…æˆåŠŸï¼Œéƒ¨åˆ†è¿”å›å¤±è´¥</li>
<li>åè°ƒè€…ç­‰å¾…è¶…æ—¶</li>
</ol>
<h6 id="å¯¹äºç¬¬1ç§æƒ…å†µï¼Œåè°ƒè€…ä¼šé€šçŸ¥æ‰€æœ‰å‚ä¸è€…æäº¤äº‹åŠ¡"><a href="#å¯¹äºç¬¬1ç§æƒ…å†µï¼Œåè°ƒè€…ä¼šé€šçŸ¥æ‰€æœ‰å‚ä¸è€…æäº¤äº‹åŠ¡" class="headerlink" title="å¯¹äºç¬¬1ç§æƒ…å†µï¼Œåè°ƒè€…ä¼šé€šçŸ¥æ‰€æœ‰å‚ä¸è€…æäº¤äº‹åŠ¡"></a>å¯¹äºç¬¬1ç§æƒ…å†µï¼Œåè°ƒè€…ä¼šé€šçŸ¥æ‰€æœ‰å‚ä¸è€…æäº¤äº‹åŠ¡</h6><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjbb6cuxwwj30m20gnwfg.jpg" style="zoom:50%;" />

<h6 id="å¯¹äºç¬¬2ï¼Œ3ç§æƒ…å†µï¼Œåè°ƒè€…å°±ä¼šå‘é€å›æ»šé€šçŸ¥"><a href="#å¯¹äºç¬¬2ï¼Œ3ç§æƒ…å†µï¼Œåè°ƒè€…å°±ä¼šå‘é€å›æ»šé€šçŸ¥" class="headerlink" title="å¯¹äºç¬¬2ï¼Œ3ç§æƒ…å†µï¼Œåè°ƒè€…å°±ä¼šå‘é€å›æ»šé€šçŸ¥"></a>å¯¹äºç¬¬2ï¼Œ3ç§æƒ…å†µï¼Œåè°ƒè€…å°±ä¼šå‘é€å›æ»šé€šçŸ¥</h6><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjbb8fo47gj30m20gnjsc.jpg" style="zoom:50%;" />

<h5 id="ä¸¤é˜¶æ®µæ–¹æ¡ˆçš„ä¸è¶³ä¹‹å¤„"><a href="#ä¸¤é˜¶æ®µæ–¹æ¡ˆçš„ä¸è¶³ä¹‹å¤„" class="headerlink" title="ä¸¤é˜¶æ®µæ–¹æ¡ˆçš„ä¸è¶³ä¹‹å¤„"></a>ä¸¤é˜¶æ®µæ–¹æ¡ˆçš„ä¸è¶³ä¹‹å¤„</h5><ol>
<li>åè°ƒè€…çš„å•ç‚¹é—®é¢˜ï¼Œåè°ƒè€…æŒ‚äº†ï¼Œå‚ä¸è€…ä¼šæ— é™ç­‰å¾…ï¼ˆå¯å¼•å…¥è¶…æ—¶æœºåˆ¶è§£å†³ï¼‰ï¼›</li>
<li>åŒæ­¥é˜»å¡ï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½åŒæ­¥é˜»å¡ç­‰å¾…åè°ƒè€…â€œæŒ‡æŒ¥â€ä¸‹ä¸€æ­¥æ“ä½œï¼Œæ•ˆç‡å¤ªä½ï¼›</li>
<li>æ•°æ®ä¸ä¸€è‡´ï¼Œä¸¤é˜¶æ®µåè®®çš„æ•´ä¸ªæµç¨‹ä¸­ï¼Œè¿˜æ˜¯å­˜åœ¨å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„å¯èƒ½ï¼ˆéƒ¨åˆ†å‚ä¸è€…æäº¤å¤±è´¥ï¼Œåè°ƒè€…ä¸å‚ä¸è€…åŒæ—¶æŒ‚äº†ï¼‰</li>
</ol>
<h4 id="2-DTPæ¨¡å‹-ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰"><a href="#2-DTPæ¨¡å‹-ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰" class="headerlink" title="2.DTPæ¨¡å‹-ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰"></a>2.DTPæ¨¡å‹-ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰</h4><p>æ˜¯ä¸‰é˜¶æ®µåè®®ç‹è€…å½’æ¥å—ï¼Ÿä¸”å¾€ä¸‹çœ‹</p>
<p>ä¸‰é˜¶æ®µä¸»è¦æ¯”äºŒé˜¶æ®µå¢åŠ äº†ä¸€ä¸ªâ€œé¢„è¯¢â€é˜¶æ®µï¼Œä»¥åŠè¶…æ—¶ç­–ç•¥æ¥å‡å°‘é›†ç¾¤çš„é˜»å¡æ—¶é—´ã€‚</p>
<h5 id="ç¬¬ä¸€é˜¶æ®µ-Can-Commit"><a href="#ç¬¬ä¸€é˜¶æ®µ-Can-Commit" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µ Can_Commit"></a>ç¬¬ä¸€é˜¶æ®µ Can_Commit</h5><ol>
<li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€äº‹åŠ¡è¯¢é—®é€šçŸ¥ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶ç­‰å¾…å“åº”</li>
<li>å„ä¸ªå‚ä¸è€…ä¾æ®è‡ªèº«çŠ¶æ€ç»™å‡º é¢„ä¼°å€¼ç­”å¤ï¼Œå¦‚æœå¯ä»¥æ‰§è¡Œäº‹åŠ¡ï¼Œå°±è¿›å…¥é¢„å¤‡çŠ¶æ€</li>
</ol>
<h5 id="ç¬¬äºŒé˜¶æ®µ-Pre-Commit"><a href="#ç¬¬äºŒé˜¶æ®µ-Pre-Commit" class="headerlink" title="ç¬¬äºŒé˜¶æ®µ Pre_Commit"></a>ç¬¬äºŒé˜¶æ®µ Pre_Commit</h5><p>ç¬¬ä¸€é˜¶æ®µçš„â€œé¢„è¯¢â€ç»“æœä¹Ÿä¼šæœ‰ä¸‰ç§</p>
<ol>
<li>æ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›ç¡®å®šä¿¡æ¯</li>
<li>éƒ¨åˆ†å‚ä¸è€…å›å¤ å¦å®šä¿¡æ¯</li>
<li>åè°ƒè€…ç­‰å¾…è¶…æ—¶</li>
</ol>
<p>å¯¹äºç¬¬1ç§æƒ…å†µï¼Œåè°ƒè€…ä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€æ‰§è¡Œäº‹åŠ¡è¯·æ±‚ï¼ˆå’Œä¸¤é˜¶æ®µåè®®çš„ç¬¬ä¸€é˜¶æ®µå†…å®¹ä¸€æ ·ï¼‰ï¼š</p>
<ol>
<li>åè°ƒè€…å‘æ‰€æœ‰çš„äº‹åŠ¡å‚ä¸è€…å‘é€äº‹åŠ¡æ‰§è¡Œé€šçŸ¥</li>
<li>å‚ä¸è€…æ”¶åˆ°é€šçŸ¥åï¼Œæ‰§è¡Œäº‹åŠ¡ï¼Œ<strong>ä½†ä¸æäº¤</strong></li>
<li>å‚ä¸è€…å°†äº‹åŠ¡æ‰§è¡Œæƒ…å†µè¿”å›ç»™å®¢æˆ·ç«¯</li>
</ol>
<p>å¯¹äºç¬¬2ã€3ç§æƒ…å†µï¼Œåè°ƒè€…ä¼šå‘é€aborté€šçŸ¥ï¼Œæ‰€æœ‰å‚ä¸è€…é€€å‡ºâ€œé¢„å¤‡â€çŠ¶æ€</p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjbbadcbe0j30mc0gn754.jpg" style="zoom:50%;" />

<h5 id="ç¬¬ä¸‰é˜¶æ®µ-Do-Commit"><a href="#ç¬¬ä¸‰é˜¶æ®µ-Do-Commit" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µ Do_Commit"></a>ç¬¬ä¸‰é˜¶æ®µ Do_Commit</h5><p>ç¬¬äºŒé˜¶æ®µçš„æ‰§è¡Œç»“æœä¹Ÿä¼šæœ‰ ä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>æ‰€æœ‰å‚ä¸å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æˆåŠŸ</li>
<li>éƒ¨åˆ†å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡å¤±è´¥</li>
<li>åè°ƒè€…ç­‰å¾…è¶…æ—¶</li>
</ol>
<p>åŒæ ·çš„ï¼Œåè°ƒè€…ä¼šé’ˆå¯¹ä¸Šè¿°3ç§æƒ…å†µè¿›è¡Œä¸åŒçš„å¤„ç†</p>
<h6 id="å¯¹äºç¬¬1ç§ï¼Œåè°ƒè€…ä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€äº‹åŠ¡æäº¤è¯·æ±‚"><a href="#å¯¹äºç¬¬1ç§ï¼Œåè°ƒè€…ä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€äº‹åŠ¡æäº¤è¯·æ±‚" class="headerlink" title="å¯¹äºç¬¬1ç§ï¼Œåè°ƒè€…ä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€äº‹åŠ¡æäº¤è¯·æ±‚"></a>å¯¹äºç¬¬1ç§ï¼Œåè°ƒè€…ä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€äº‹åŠ¡æäº¤è¯·æ±‚</h6><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjbbbah8o8j30k20qagmz.jpg" style="zoom:50%;" />

<h6 id="å¯¹äºç¬¬2ï¼Œ3ç§ï¼Œåè°ƒè€…ä¼šå‘é€äº‹åŠ¡å›æ»šé€šçŸ¥ç»™æ‰€æœ‰å‚ä¸è€…ã€‚"><a href="#å¯¹äºç¬¬2ï¼Œ3ç§ï¼Œåè°ƒè€…ä¼šå‘é€äº‹åŠ¡å›æ»šé€šçŸ¥ç»™æ‰€æœ‰å‚ä¸è€…ã€‚" class="headerlink" title="å¯¹äºç¬¬2ï¼Œ3ç§ï¼Œåè°ƒè€…ä¼šå‘é€äº‹åŠ¡å›æ»šé€šçŸ¥ç»™æ‰€æœ‰å‚ä¸è€…ã€‚"></a>å¯¹äºç¬¬2ï¼Œ3ç§ï¼Œåè°ƒè€…ä¼šå‘é€äº‹åŠ¡å›æ»šé€šçŸ¥ç»™æ‰€æœ‰å‚ä¸è€…ã€‚</h6><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjbbca965kj30ks0qaq4b.jpg" style="zoom:50%;" />

<blockquote>
<p>è¡¥å……ï¼Œå¦‚æœåœ¨è¯¥é˜¶æ®µï¼Œå‚ä¸è€…ç­‰å¾…åè°ƒè€…å‘é€çš„æ¶ˆæ¯è¶…æ—¶ï¼Œé‚£ä¹ˆé»˜è®¤ä¼šæäº¤äº‹åŠ¡ã€‚è€Œå¦‚æœæ­¤æ—¶åè°ƒè€…å‘é€çš„æ˜¯å›æ»šé€šçŸ¥ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„å¯èƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‰é˜¶æ®µç›¸æ¯”ä¸¤é˜¶æ®µä¸»è¦æäº¤äº†ä¸¤ç‚¹ï¼š1.ç¬¬ä¸€é˜¶æ®µçš„é¢„è¯¢æ“ä½œæ›´åŠ è½»é‡çº§ï¼Œå¦‚æœæœ‰éƒ¨åˆ†å‚ä¸è€…æ— æ³•æ‰§è¡Œäº‹åŠ¡ï¼Œç›´æ¥Abortï¼Œè€Œä¸ç”¨æ‰€æœ‰å‚ä¸è€…é¢„æ‰§è¡Œäº‹åŠ¡ï¼›2.å¢åŠ äº†è¶…æ—¶è‡ªåŠ¨æäº¤æœºåˆ¶ï¼Œé¿å…äº†é•¿æ—¶é—´ç­‰å¾…é€ æˆèµ„æºæµªè´¹ã€‚</p>
</blockquote>
<blockquote>
<p>æ€è€ƒï¼šå¦‚æœç¬¬ä¸‰é˜¶æ®µï¼Œæœ€åæœ‰å‚ä¸è€…è¿”å›â€œæäº¤äº‹åŠ¡å¤±è´¥â€ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ</p>
</blockquote>
<h4 id="2PCå’Œ3PCçš„åŒºåˆ«"><a href="#2PCå’Œ3PCçš„åŒºåˆ«" class="headerlink" title="2PCå’Œ3PCçš„åŒºåˆ«"></a>2PCå’Œ3PCçš„åŒºåˆ«</h4><ul>
<li>2PC åªæœ‰åè°ƒè€…è¶…æ—¶æœºåˆ¶ï¼Œ3PCåè°ƒè€…å‚ä¸è€…éƒ½æœ‰è¶…æ—¶æœºåˆ¶</li>
<li>3PC å°†2PCçš„ç¬¬ä¸€é˜¶æ®µæ‹†ä¸º2æ­¥ï¼Œç²’åº¦æ›´ç»†ï¼Œèµ„æºé”å®šæ—¶é—´æ›´çŸ­</li>
</ul>
<h4 id="3-TCCæ–¹æ¡ˆ"><a href="#3-TCCæ–¹æ¡ˆ" class="headerlink" title="3.TCCæ–¹æ¡ˆ"></a>3.TCCæ–¹æ¡ˆ</h4><p>TCCæ˜¯try,confirm/cancelçš„ç®€ç§°ï¼Œå³TCCä¸»è¦æœ‰ä¸¤é˜¶æ®µç»„æˆï¼Œåˆ†åˆ«æ˜¯Tryé˜¶æ®µå’ŒConfirm/Cancelé˜¶æ®µã€‚</p>
<blockquote>
<p>é€šä¿—ç‚¹è®²ï¼Œä¸€ä¸ªå®Œæ•´çš„äº‹åŠ¡ = Try + Confirmæˆ–Cancel</p>
</blockquote>
<p>TCCæ–¹æ¡ˆæ˜¯ä¸€ç§æŸ”æ€§äº‹åŠ¡æ–¹æ¡ˆçš„å®ç°ï¼Œé‚£ä¹ˆä½•ä¸º<code>æŸ”æ€§äº‹åŠ¡</code>ï¼Ÿ</p>
<h5 id="ä¸€é˜¶æ®µ-Try"><a href="#ä¸€é˜¶æ®µ-Try" class="headerlink" title="ä¸€é˜¶æ®µ-Try"></a>ä¸€é˜¶æ®µ-Try</h5><p>Tryä¸­çš„é€»è¾‘ä¸ä¼ ç»Ÿäº‹åŠ¡æœºåˆ¶ä¸­çš„ä¸šåŠ¡é€»è¾‘ç›¸åŒã€‚è¯¥é˜¶æ®µä¸»è¦çš„å·¥ä½œæ˜¯ï¼šå®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ï¼Œé¢„ç•™å¿…é¡»çš„ä¸šåŠ¡èµ„æºã€‚</p>
<h5 id="äºŒé˜¶æ®µ-Confirm"><a href="#äºŒé˜¶æ®µ-Confirm" class="headerlink" title="äºŒé˜¶æ®µ-Confirm"></a>äºŒé˜¶æ®µ-Confirm</h5><p>çœŸæ­£æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸åšä»»ä½•ä¸šåŠ¡æ£€æŸ¥ï¼Œ<strong>ä½†åªèƒ½ä½¿ç”¨Tryé˜¶æ®µé¢„ç•™çš„èµ„æº</strong>ã€‚æ­¤å¤–ï¼Œconfirmæ“ä½œè¿˜æœ‰å‡ ç‚¹è¦æ±‚</p>
<ol>
<li>Tryæ“ä½œæˆåŠŸï¼ŒConfirmæ“ä½œä¸€å®šä¼šæˆåŠŸï¼Œä¸å­˜åœ¨å¤±è´¥çš„æƒ…å†µï¼›</li>
<li>Confirmæ“ä½œè¦æ»¡è¶³å¹‚ç­‰æ€§ï¼Œä¿è¯ä¸€ç¬”åˆ†å¸ƒå¼äº‹åŠ¡èƒ½ä¸”åªèƒ½æˆåŠŸä¸€æ¬¡ã€‚</li>
</ol>
<h5 id="äºŒé˜¶æ®µ-Cancel"><a href="#äºŒé˜¶æ®µ-Cancel" class="headerlink" title="äºŒé˜¶æ®µ-Cancel"></a>äºŒé˜¶æ®µ-Cancel</h5><p>é‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚åŒæ ·çš„ï¼ŒCancel æ“ä½œä¹Ÿéœ€è¦æ»¡è¶³å¹‚ç­‰æ€§ã€‚</p>
<h5 id="TCCæ–¹æ¡ˆå­˜åœ¨çš„ä¸‰ä¸ªé—®é¢˜"><a href="#TCCæ–¹æ¡ˆå­˜åœ¨çš„ä¸‰ä¸ªé—®é¢˜" class="headerlink" title="TCCæ–¹æ¡ˆå­˜åœ¨çš„ä¸‰ä¸ªé—®é¢˜"></a>TCCæ–¹æ¡ˆå­˜åœ¨çš„ä¸‰ä¸ªé—®é¢˜</h5><ol>
<li>ç©ºå›æ»š - æ²¡æœ‰è°ƒç”¨ tryï¼Œç›´æ¥è°ƒç”¨Cancelï¼Œè¦æ±‚åœ¨è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œèƒ½å¤Ÿæ˜¯è¢«ç©ºå›æ»šè¯·æ±‚ï¼Œå¹¶å¤„ç†ã€‚</li>
<li>å¹‚ç­‰ - ç”±äºç½‘ç»œåŸå› Contirmã€Cancelæ¥å£è¢«å¤šæ¬¡è°ƒç”¨ï¼Œè¦ä¿è¯é‡å¤æ‰§è¡Œä¸åªæ‰§è¡Œä¸€æ¬¡å…·æœ‰åŒæ ·æ•ˆæœï¼Œå¯ä»¥è®¾ç½®å½“æ—¶äº‹åŠ¡çŠ¶æ€æ¥é¿å…</li>
<li>æ‚¬æŒ‚ - Cancelæ¯”Tryå…ˆæ‰§è¡Œäº†ã€‚ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿï¼šç½‘ç»œåŸå› Tryæ“ä½œé˜»å¡ï¼Œè¶…æ—¶åï¼ŒTCCæ¡†æ¶åè°ƒå™¨è°ƒç”¨Cancelæ¥å£ï¼ŒCancelæ‰§è¡Œåï¼ŒTryæ“ä½œæ‰åˆ°è¾¾ã€‚è§£å†³æ–¹æ¡ˆï¼šæ‰§è¡Œtryæ“ä½œä¹‹å‰å…ˆæŸ¥è¯¢ä¸€ä¸‹äºŒé˜¶æ®µæ¥å£æ˜¯å¦è¢«æ‰§è¡Œ</li>
</ol>
<h5 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h5><ol>
<li>TCCç›¸å¯¹äº XA ç­‰ä¼ ç»Ÿæ¨¡å‹ï¼Œå…¶ç‰¹å¾åœ¨äºå®ƒä¸ä¾èµ– RM å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æ”¯æŒï¼Œè€Œæ˜¯é€šè¿‡å¯¹ä¸šåŠ¡é€»è¾‘çš„åˆ†è§£æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</li>
<li>TCCè¦æ ¹æ®è‡ªèº«ä¸šåŠ¡æ¨¡å‹ç‰¹ç‚¹æ¥æ§åˆ¶å¹¶å‘ã€‚</li>
</ol>
<h3 id="XAä¸TCCçš„å¼‚åŒ"><a href="#XAä¸TCCçš„å¼‚åŒ" class="headerlink" title="XAä¸TCCçš„å¼‚åŒ"></a>XAä¸TCCçš„å¼‚åŒ</h3><h5 id="éš”ç¦»æ€§"><a href="#éš”ç¦»æ€§" class="headerlink" title="éš”ç¦»æ€§"></a>éš”ç¦»æ€§</h5><ul>
<li><p>XAå¯¹éš”ç¦»æ€§çš„æ§åˆ¶ï¼Œæ˜¯é€šè¿‡å¯¹ä¾èµ–çš„èµ„æºè¿›è¡ŒåŠ é”çš„æ–¹å¼ï¼Œä¸”è¦æ±‚å¯¹é”çš„æŒæœ‰è¦åˆ°æœ€åä¸€é˜¶æ®µï¼Œè¿™ç§é•¿æ—¶é—´å¯¹èµ„æºè¿›è¡ŒåŠ é”çš„æ–¹å¼ï¼Œä¼šä½¿å¾—å¹¶å‘æ€§èƒ½éå¸¸ä½ä¸‹</p>
</li>
<li><p>TCCå¯¹éš”ç¦»æ€§çš„å¤„ç†æ€æƒ³æ˜¯é€šè¿‡ä¸šåŠ¡å±‚æ¥æ§åˆ¶ï¼ŒTryé˜¶æ®µç»“æŸåå°±é‡Šæ”¾åº•å±‚æ•°æ®åº“é”ï¼Œç”±ä¸šåŠ¡å±‚å¯¹æŒæœ‰çš„èµ„æºè¿›è¡ŒåŠ é”ï¼Œä»è€Œé™ä½é”çš„ç²’åº¦ï¼Œæé«˜å¹¶å‘æ€§ã€‚</p>
<blockquote>
<p>ä¸Šé¢è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼ŒAè´¦æˆ·æœ‰100å…ƒï¼ŒAå‘Bè´¦æˆ·è½¬è´¦30å…ƒï¼Œåœ¨tryé˜¶æ®µä¼šå¯¹Aè´¦æˆ·æ‰£é™¤30å…ƒï¼Œå¹¶å¢åŠ 30å…ƒå†»ç»“èµ„é‡‘ï¼ˆè¿™ä¾èµ–åº•å±‚æ•°æ®åº“é”ä¿è¯åŸå­æ€§ï¼‰ï¼Œè¿™æ ·å°±åœ¨ä¸šåŠ¡å±‚é¢æŠŠ30å—ç»™é”å®šäº†ï¼ˆè½¬ä¸ºä¸šåŠ¡å±‚åŠ é”ï¼‰ï¼Œç„¶åConfirmé˜¶æ®µå‘Bè´¦æˆ·å¢åŠ 30å…ƒï¼Œå¦‚æœå¢åŠ æˆåŠŸï¼Œåˆ™å°†Aè´¦æˆ·å†»ç»“èµ„é‡‘æ‰£é™¤ï¼›å¦‚æœå¤±è´¥åˆ™æ‰§è¡ŒCancelï¼Œå°†30å…ƒå†»ç»“èµ„é‡‘è¿”å›ç»™Aè´¦æˆ·ã€‚è¿™æ ·å³ä½¿Aè´¦æˆ·éœ€è¦åŒæ—¶ç»™å¤šä¸ªè´¦æˆ·è½¬è´¦30å…ƒï¼Œä¹Ÿä¸æ˜¯å‡ºç°â€åŒèŠ±â€œçš„æƒ…å†µã€‚</p>
</blockquote>
</li>
</ul>
<h5 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h5><ul>
<li>XAé€šè¿‡ä¸¤é˜¶æ®µæäº¤åè®®æ¥æ§åˆ¶åŸå­æ€§ï¼Œå³Prepare, Commit/Rollback</li>
<li>TCCä¹Ÿæ˜¯é€šè¿‡ä¸¤é˜¶æ®µæ¥æ§åˆ¶åŸå­æ€§ï¼Œåªä¸è¿‡æ›´åƒæ˜¯åº”ç”¨å±‚çš„åŸå­æ€§ï¼ŒTryç›¸å½“äº Prepareï¼ŒConfirmç›¸å½“äºCommitï¼ŒCancelç›¸å½“äºRollbackã€‚</li>
</ul>
<h5 id="ä¸€è‡´æ€§"><a href="#ä¸€è‡´æ€§" class="headerlink" title="ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h5><ul>
<li>XAäºTCCçš„ä¸€è‡´æ€§éƒ½æ˜¯ç”±å…¶åŸå­æ€§å’Œéš”ç¦»æ€§æ¥ä¿è¯</li>
<li>XAæ–¹æ¡ˆçš„ä¸€è‡´æ€§æ˜¯å¼ºä¸€è‡´æ€§ï¼Œæ•°æ®çš„ä¸­é—´è¿‡ç¨‹çŠ¶æ€æ˜¯æ— æ³•è¢«è§‚å¯Ÿåˆ°çš„ï¼›è€ŒTCCçš„ä¸­é—´çŠ¶æ€æ˜¯å¯ä»¥è¢«è§‚å¯Ÿåˆ°çš„ï¼Œæ˜¯ä¸€ç§å¼±ä¸€è‡´æ€§ï¼ˆè¿½æ±‚æœ€ç»ˆä¸€è‡´æ€§ï¼‰ã€‚</li>
</ul>
<h3 id="å››ã€å¸¸è§çš„å¼€æºè§£å†³æ–¹æ¡ˆ"><a href="#å››ã€å¸¸è§çš„å¼€æºè§£å†³æ–¹æ¡ˆ" class="headerlink" title="å››ã€å¸¸è§çš„å¼€æºè§£å†³æ–¹æ¡ˆ"></a>å››ã€å¸¸è§çš„å¼€æºè§£å†³æ–¹æ¡ˆ</h3><ol>
<li><p><a href="http://seata.io/zh-cn/docs/overview/what-is-seata.html">Seata</a></p>
</li>
<li><p><a href="https://github.com/changmingxie/tcc-transaction">Tcc-Transaction</a></p>
</li>
<li><p><a href="https://github.com/liuyangming/ByteTCC">ByteTCC</a></p>
</li>
</ol>
<h3 id="äº”ã€æœ€å"><a href="#äº”ã€æœ€å" class="headerlink" title="äº”ã€æœ€å"></a>äº”ã€æœ€å</h3><p>ä»¥ä¸Šå†…å®¹åªæ˜¯æ•´ç†ä½œä¸ºå­¦ä¹ ç¬”è®°ï¼Œä»…æŠ›ç –å¼•ç‰ä½œç”¨ï¼Œå¤§å®¶å…±åŒå­¦ä¹ è¿›æ­¥ï¼Œä½ å­¦åºŸäº†å˜›ï¼Ÿ</p>
<h3 id="å…­ã€å‚è€ƒ"><a href="#å…­ã€å‚è€ƒ" class="headerlink" title="å…­ã€å‚è€ƒ"></a>å…­ã€å‚è€ƒ</h3><ol>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzUzMzU5Mjc1Nw==&amp;mid=2247483681&amp;idx=1&amp;sn=05845495c5ef33683addd98fffc72106&amp;chksm=faa0eefbcdd767edbf46cea6f223b426e276dd4d9b19cce64f59387590818f5e4eb96c7d2533&amp;mpshare=1&amp;scene=2&amp;srcid=0118GSYShGZaOyCndUoAqsae&amp;from=timeline#rd">åˆ†å¸ƒå¼äº‹åŠ¡ç»¼è¿°</a></li>
<li><a href="https://blog.csdn.net/pyycsd/article/details/102803015">åˆ†å¸ƒå¼äº‹åŠ¡-ä¸¤é˜¶æ®µä¸ä¸‰é˜¶æ®µæ</a></li>
<li><a href="https://www.bytesoft.org/tcc-intro/">TCCäº‹åŠ¡æœºåˆ¶ç®€ä»‹</a></li>
<li><a href="https://www.zhihu.com/question/48627764">å¦‚ä½•ç†è§£TCCåˆ†å¸ƒå¼äº‹åŠ¡</a></li>
<li><a href="https://juejin.im/post/6844903829603876878">åˆ†å¸ƒå¼äº‹åŠ¡ Seata TCC æ¨¡å¼æ·±åº¦è§£æ</a></li>
</ol>
]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
        <category>äº‹åŠ¡</category>
      </categories>
      <tags>
        <tag>äº‹åŠ¡</tag>
        <tag>Transaction</tag>
      </tags>
  </entry>
  <entry>
    <title>ShardingSphereåˆ†åº“åˆ†è¡¨ä½“éªŒ</title>
    <url>/2020/11/02/ShardingSphere%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%BD%93%E9%AA%8C/</url>
    <content><![CDATA[<h3 id="ShardingSphereåˆ†åº“åˆ†è¡¨å®è·µ"><a href="#ShardingSphereåˆ†åº“åˆ†è¡¨å®è·µ" class="headerlink" title="ShardingSphereåˆ†åº“åˆ†è¡¨å®è·µ"></a>ShardingSphereåˆ†åº“åˆ†è¡¨å®è·µ</h3><h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><h5 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h5><p>å½“ç³»ç»Ÿä¸­æ•°æ®åº“æˆåŠŸæ€§èƒ½çš„ç“¶é¢ˆï¼Œç‰¹åˆ«æ˜¯ä¸€å¼ è¡¨ä¸­çš„æ•°æ®é‡è¿‡å¤§ï¼Œè¾¾åˆ°500wç”šè‡³1000wæ—¶ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡å»ºç«‹æœ‰æ•ˆç´¢å¼•ä¹Ÿéš¾ä»¥æ»¡è¶³æŸ¥è¯¢çš„æ•ˆç‡è¦æ±‚æ—¶ï¼Œå°±éœ€è¦è€ƒè™‘åˆ°åˆ†åº“åˆ†è¡¨ï¼Œåˆ†è¡¨ä¸€èˆ¬æ˜¯å°†è¡¨è¿›è¡Œæ°´å¹³æ‹†åˆ†ï¼Œå¦‚æ ¹æ®ç”¨æˆ·idï¼Œè®¢å•ç¼–å·ç­‰ç­–ç•¥ã€‚</p>
<p>ä¸¾ä¸ªæ —å­ï¼šå°†è®¢å•è¡¨t_orderæ‹†åˆ†æˆå››å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯t_order_0,t_order_1,t_order_2,t_order_3ï¼›åˆ†è¡¨çš„è·¯ç”±ç­–ç•¥ä¸º <code>order_no % 4</code>ï¼›</p>
<p>è¿™ç§æƒ…å†µä¸‹ï¼š</p>
<ul>
<li>è®¢å•å·ä¸º10000çš„è®¢å• å°†è¢«ä¿å­˜åœ¨ 10000%4 = 0 å³ t_order_0è¡¨ï¼›</li>
<li>è®¢å•å·ä¸º 10001çš„è®¢å• å°†è¢«ä¿å­˜åœ¨ 10001%4=1 å³ t_order_1è¡¨ï¼›</li>
<li>å…¶ä»–åŒç†ã€‚</li>
</ul>
<h5 id="å¸¸è§çš„åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ"><a href="#å¸¸è§çš„åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§çš„åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ"></a>å¸¸è§çš„åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ</h5><ul>
<li><p>ç¬¬ä¸€ç§æ˜¯å®¢æˆ·ç«¯å‹çš„ï¼Œå¦‚ ShardingSphere(Sharding-JDBC)ï¼Œåˆ†è¡¨è·¯ç”±ç­‰é€»è¾‘éœ€è¦ä¾µå…¥åˆ°å®¢æˆ·ç«¯çš„ä»£ç ä¸­ã€‚</p>
<img src="https://shardingsphere.apache.org/document/current/img/shardingsphere-jdbc-brief.png" alt="Sharding-JDBC" style="zoom:67%;" />
</li>
<li><p>ç¬¬äºŒç§æ˜¯åŸºäºä»£ç†å‹çš„ï¼Œå¦‚ MyCatã€‚è¿™ç§ä¸­é—´ä»¶å¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸çŸ¥é“è‡ªå·±çš„è¯·æ±‚è¢«ä»£ç†äº†çš„ã€‚</p>
<p><img src="http://www.mycat.org.cn/index_files/arc.png" alt="MyCatæ¶æ„å›¾"></p>
</li>
</ul>
<p>#####åŒºåˆ«&amp;ä¼˜ç¼ºç‚¹</p>
<ul>
<li>MyCatæ˜¯ä¸€ä¸ªä¸‰æ–¹ä¸­é—´ä»¶åº”ç”¨ï¼Œéœ€è¦ç‹¬ç«‹éƒ¨ç½²å¹¶è¿è¡Œï¼ŒShardingJDBCæ˜¯ä¸€ä¸ªjaråŒ…ï¼Œéœ€è¦å®¢æˆ·ç«¯é›†æˆï¼›</li>
<li>MyCatä»£ç†æ•°æ®åº“ï¼ŒShardingJDBCæ˜¯ç›´è¿æ•°æ®åº“ï¼Œç›¸æ¯”è€Œè¨€ï¼Œåè€…åœ¨æ€§èƒ½ä¸Šæ›´å ä¼˜åŠ¿ï¼›</li>
<li>äºŒè€…åœ¨å¤šè¡¨Joinç­‰ç‰¹æ€§åŠå†…éƒ¨å‡½æ•°ä¸Šå­˜åœ¨ä¸åŒçš„é™åˆ¶ï¼›</li>
<li>[ä¸ªäººç†è§£] ç›®å‰å·¥ä½œä¸­Sharding-JDBCç”¨çš„å¤šä¸€ç‚¹ï¼ˆäº†è§£åˆ°çš„åƒå½“å½“ã€å–œé©¬æ‹‰é›…ã€å¾®ç›Ÿï¼‰ï¼Œå› ä¸ºMyCatéœ€è¦ä¸“é—¨çš„äººå‘˜æˆ–å›¢é˜Ÿå»ç»´æŠ¤ä¿è¯ç¨³å®šæ€§ï¼Œè€Œä¸”å°±ç›®å‰ç¤¾åŒºæ–‡æ¡£è§„èŒƒåŠæ´»è·ƒæ€§æ¥çœ‹ï¼ŒShardingSphereä¹Ÿæ›´å¥½ä¸€ç‚¹ã€‚</li>
</ul>
<h5 id="åˆ†ç‰‡ç­–ç•¥åŠåˆ†ç‰‡ç®—æ³•"><a href="#åˆ†ç‰‡ç­–ç•¥åŠåˆ†ç‰‡ç®—æ³•" class="headerlink" title="åˆ†ç‰‡ç­–ç•¥åŠåˆ†ç‰‡ç®—æ³•"></a>åˆ†ç‰‡ç­–ç•¥åŠåˆ†ç‰‡ç®—æ³•</h5><ul>
<li><p>åˆ†ç‰‡ç­–ç•¥ä¸åˆ†ç‰‡ç®—æ³• äºŒè€…åŒºåˆ«ä¸å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç®—æ³•æ˜¯ç­–ç•¥ä¸­æŠ½è±¡å‡ºæ¥çš„é€»è¾‘ä¸ç²¾é«“ï¼Œç­–ç•¥æ˜¯ç®—æ³•ç»“åˆä¸šåŠ¡åœºæ™¯çš„å…·ä½“å®ç°ã€‚ï¼ˆä¸ªäººç†è§£ï¼Œä¸åŒè§è§£è¯·ç•™è¨€äº¤æµï¼‰</p>
</li>
<li><p>åˆ†ç‰‡ç­–ç•¥çš„ä¸¤ç§ç»´åº¦</p>
<ul>
<li>æ•°æ®æºåˆ†ç‰‡ç­–ç•¥ï¼ˆDatabaseShardingStrategyï¼‰ï¼šé€šä¿—ç‚¹è¯´ï¼Œå°±æ˜¯ä½œç”¨äºå¤šä¸ªæ•°æ®åº“å®ä¾‹ä¹‹é—´ã€‚</li>
<li>è¡¨åˆ†ç‰‡ç­–ç•¥ï¼ˆTableShardingStrategyï¼‰ï¼šæ•°æ®å¦‚ä½•è¢«åˆ†é…åˆ°å…·ä½“çš„è¡¨</li>
</ul>
</li>
<li><p>ç­–ç•¥åˆ†ç±»</p>
<ul>
<li>StandardShardingStrategy</li>
<li>ComplexShardingStrategy</li>
<li>InlineShardingStrategy</li>
<li>HintShardingStrategy</li>
<li>NoneShardingStrategy</li>
</ul>
<p>å…·ä½“çš„åˆ†ç‰‡ç­–ç•¥åŠå…¶åŒºåˆ«æ¨èè¿˜æ˜¯å»å®˜æ–¹é˜…è¯»æœ€æ–°æ–‡æ¡£ï¼Œ<a href="https://shardingsphere.apache.org/document/current/en/features/sharding/concept/sharding/">è¿™é‡Œ</a>ä»…ä¾›å‚è€ƒã€‚</p>
</li>
<li><p>ç®—æ³•åˆ†ç±»</p>
<ul>
<li>PreciseShardingAlgorithm</li>
<li>RangeShardingAlgorithm</li>
<li>HintShardingAlgorithm</li>
<li>ComplexKeysShardingAlgorithm</li>
</ul>
</li>
</ul>
<p>Apache ShardingSphere é€šè¿‡ SPI æ–¹å¼å…è®¸å¼€å‘è€…æ‰©å±•ç®—æ³•ï¼ŒåŒæ—¶ï¼Œå®ƒä¹Ÿå†…ç½®äº†å¾ˆå¤šç®—æ³•ï¼Œè¯¦ç»†å¯ä»¥é˜…è¯»<a href="https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-jdbc/configuration/built-in-algorithm/">å®˜æ–¹æ–‡æ¡£</a> and <a href="https://shardingsphere.apache.org/document/current/cn/dev-manual/sharding/">Here</a>ã€‚</p>
<h4 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h4><p>Apache ShardingSphere æ˜¯ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆç»„æˆçš„ç”Ÿæ€åœˆï¼Œå…¶å®˜ç½‘ <a href="http://shardingsphere.apache.org/index_zh.html">ShardingSphere</a>ï¼Œå®˜æ–¹çš„å…¥é—¨èµ„æ–™å¯ä»¥å…ˆå‚è€ƒï¼Œè¿™é‡Œä¸åšè¯¦ç»†ä»‹ç»ã€‚</p>
<h5 id="åˆ›å»ºé¡¹ç›®å¹¶æ·»åŠ ä¾èµ–"><a href="#åˆ›å»ºé¡¹ç›®å¹¶æ·»åŠ ä¾èµ–" class="headerlink" title="åˆ›å»ºé¡¹ç›®å¹¶æ·»åŠ ä¾èµ–"></a>åˆ›å»ºé¡¹ç›®å¹¶æ·»åŠ ä¾èµ–</h5><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªMavenç®¡ç†çš„SpringBooté¡¹ç›®ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--mysqlï¼Œæ ¹æ®è‡ªå·±æ•°æ®åº“ç‰ˆæœ¬è¿›è¡Œç›¸å…³è°ƒæ•´ï¼Œä¸ç„¶ä¼šæŠ¥é”™--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Mybatis-Plus--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- for spring boot --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- for spring namespace --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-namespace<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="åˆ›å»ºæ•°æ®åº“è¡¨"><a href="#åˆ›å»ºæ•°æ®åº“è¡¨" class="headerlink" title="åˆ›å»ºæ•°æ®åº“è¡¨"></a>åˆ›å»ºæ•°æ®åº“è¡¨</h5><p>ç„¶ååˆ›å»ºæ•°æ®åº“ï¼Œä¸ºäº†å®ç°<code>åˆ†åº“</code> åŠŸèƒ½ï¼Œè¿™é‡Œåˆ›å»ºä¸¤ä¸ªæ•°æ®åº“ï¼Œåˆ†åˆ«æ˜¯ï¼š<code>sharding_practice_0</code>å’Œ<code>sharding_practice_1</code>ã€‚</p>
<p>åˆ†åˆ«åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè¡¨ <code>t_user_0</code>ã€<code>t_user_1ã€</code>t_order_0<code>ã€</code>t_order_1ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;t_order_0&#96;  (</span><br><span class="line">  &#96;id&#96; bigint NOT NULL AUTO_INCREMENT COMMENT &#39;è‡ªå¢id&#39;,</span><br><span class="line">  &#96;order_no&#96; varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT &#39;è®¢å•å·&#39;,</span><br><span class="line">  &#96;order_name&#96; varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#39;è®¢å•åç§°&#39;,</span><br><span class="line">  &#96;order_status&#96; int NOT NULL COMMENT &#39;è®¢å•çŠ¶æ€&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint NOT NULL COMMENT &#39;ç”¨æˆ·id&#39;,</span><br><span class="line">  &#96;create_time&#96; datetime(0) NOT NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT &#39;åˆ›å»ºæ—¶é—´&#39;,</span><br><span class="line">  &#96;update_time&#96; datetime(0) NOT NULL DEFAULT CURRENT_TIMESTAMP(0) ON UPDATE CURRENT_TIMESTAMP(0) COMMENT &#39;æ›´æ–°æ—¶é—´&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;) USING BTREE</span><br><span class="line">) ENGINE &#x3D; InnoDB AUTO_INCREMENT &#x3D; 1 CHARACTER SET &#x3D; utf8mb4 COLLATE &#x3D; utf8mb4_general_ci ROW_FORMAT &#x3D; DYNAMIC;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;t_user_0&#96;  (</span><br><span class="line">  &#96;id&#96; bigint NOT NULL AUTO_INCREMENT COMMENT &#39;è‡ªå¢id&#39;,</span><br><span class="line">  &#96;name&#96; varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT &#39;ç”¨æˆ·å&#39;,</span><br><span class="line">  &#96;mobile&#96; varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#39;è®¢å•åç§°&#39;,</span><br><span class="line">  &#96;address&#96; varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT &#39;&#39; COMMENT &#39;åœ°å€&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint NOT NULL COMMENT &#39;ç”¨æˆ·id&#39;,</span><br><span class="line">  &#96;age&#96; int NOT NULL COMMENT &#39;å¹´é¾„&#39;,</span><br><span class="line">  &#96;create_time&#96; datetime(0) NOT NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT &#39;åˆ›å»ºæ—¶é—´&#39;,</span><br><span class="line">  &#96;update_time&#96; datetime(0) NOT NULL DEFAULT CURRENT_TIMESTAMP(0) ON UPDATE CURRENT_TIMESTAMP(0) COMMENT &#39;æ›´æ–°æ—¶é—´&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;) USING BTREE</span><br><span class="line">) ENGINE &#x3D; InnoDB AUTO_INCREMENT &#x3D; 1 CHARACTER SET &#x3D; utf8mb4 COLLATE &#x3D; utf8mb4_general_ci ROW_FORMAT &#x3D; DYNAMIC;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¡¨ç»“æ„éƒ½ä¸€æ ·ï¼Œå°±ä¸é‡å¤è´´äº†ã€‚</p>
<h5 id="åˆ›å»ºå®ä½“ç±»ç­‰"><a href="#åˆ›å»ºå®ä½“ç±»ç­‰" class="headerlink" title="åˆ›å»ºå®ä½“ç±»ç­‰"></a>åˆ›å»ºå®ä½“ç±»ç­‰</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName(&quot;t_order&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderInfo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;,type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;order_no&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String orderNo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String orderName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer orderStatus;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName(&quot;t_user&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;,type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MapperåŠServiceç›´æ¥çœç•¥ï¼Œé‡‡ç”¨ mybatis-plusè‡ªåŠ¨ç”Ÿæˆcrudæ–¹æ³•ï¼Œä¸å†è´´å‡ºæ¥ã€‚</p>
<h5 id="åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºé…ç½®æ–‡ä»¶"></a>åˆ›å»ºé…ç½®æ–‡ä»¶</h5><p>é…ç½®æ–‡ä»¶æ˜¯é‡ç‚¹ï¼Œæ³¨é‡Šéƒ½åœ¨å…¶ä¸­ï¼Œç®€å•æ˜“æ‡‚ã€‚</p>
<p>å…¶ä¸­ï¼Œt_orderè¡¨ä½¿ç”¨åˆ†ç‰‡ç­–ç•¥ï¼š<code>order_no % 2</code>;</p>
<p>t_userè¡¨é‡‡ç”¨å¼ºåˆ¶è·¯ç”±ï¼Œåœ¨é…ç½®ä¸­æŒ‡å®šè·¯ç”±ç®—æ³•ç±» <code>com.eqshen.shardingpractice.algorithm.UserHintAlgorithm</code>,åœ¨ä»£ç ä¸­æŒ‡å®šè·¯ç”±çš„é”®å€¼ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åº”ç”¨åç§°</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">sharding-practice</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8098</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®æº ds0,ds1</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.names</span>=<span class="string">ds0,ds1</span></span><br><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªæ•°æ®åº“</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds0.type</span>=<span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds0.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds0.jdbc-url</span>=<span class="string">jdbc:mysql://localhost:3306/sharding_practice_0?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8&amp;characterSetResults=utf8&amp;useSSL=false&amp;verifyServerCertificate=false&amp;autoReconnct=true&amp;autoReconnectForPools=true&amp;allowMultiQueries=true</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds0.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds0.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒä¸ªæ•°æ®åº“</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds1.type</span>=<span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds1.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds1.jdbc-url</span>=<span class="string">jdbc:mysql://localhost:3306/sharding_practice_1?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8&amp;characterSetResults=utf8&amp;useSSL=false&amp;verifyServerCertificate=false&amp;autoReconnct=true&amp;autoReconnectForPools=true&amp;allowMultiQueries=true</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds1.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.ds1.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ°´å¹³æ‹†åˆ†çš„æ•°æ®åº“ï¼ˆè¡¨ï¼‰ é…ç½®åˆ†åº“ + åˆ†è¡¨ç­–ç•¥ è¡Œè¡¨è¾¾å¼åˆ†ç‰‡ç­–ç•¥</span></span><br><span class="line"><span class="comment">## åˆ†åº“ç­–ç•¥</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column</span>=<span class="string">order_no</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression</span>=<span class="string">ds$-&gt;&#123;order_no % 2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## t_orderåˆ†è¡¨ç­–ç•¥</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_order.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.t_order_$-&gt;&#123;0..1&#125;</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_order.key-generator.column</span>=<span class="string">order_no</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_order.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.sharding-column</span>=<span class="string">order_no</span></span><br><span class="line"><span class="comment">###åˆ†ç‰‡ç®—æ³•è¡¨è¾¾å¼</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.algorithm-expression</span>=<span class="string">t_order_$-&gt;&#123;order_no % 2&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## t_user åˆ†è¡¨ç­–ç•¥</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.t_user_$-&gt;&#123;0..1&#125;</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.key-generator.column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"><span class="comment">### å¼ºåˆ¶è·¯ç”±</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.database-strategy.hint.algorithm-class-name</span>=<span class="string">com.eqshen.shardingpractice.algorithm.UserHintAlgorithm</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.table-strategy.hint.algorithm-class-name</span>=<span class="string">com.eqshen.shardingpractice.algorithm.UserHintAlgorithm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°æ‰§è¡Œçš„æ•°æ®åº“ä»¥åŠè¯­å¥</span></span><br><span class="line"><span class="meta">spring.shardingsphere.props.sql.show</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.main.allow-bean-definition-overriding</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis-plus</span></span><br><span class="line"><span class="meta">mybatis-plus.mapper-locations</span>=<span class="string">classpath:/mapper/*.xml</span></span><br><span class="line"><span class="meta">mybatis-plus.configuration.jdbc-type-for-null</span>=<span class="string">&#x27;null&#x27;</span></span><br></pre></td></tr></table></figure>

<p>å®Œæˆä»¥ä¸Šå†…å®¹å°±å¯ä»¥å¼€å§‹æµ‹è¯•äº†</p>
<h5 id="å¼ºåˆ¶è·¯ç”±"><a href="#å¼ºåˆ¶è·¯ç”±" class="headerlink" title="å¼ºåˆ¶è·¯ç”±"></a>å¼ºåˆ¶è·¯ç”±</h5><p>ä½•ä¸ºå¼ºåˆ¶è·¯ç”±ï¼Ÿ ä¸”çœ‹å®˜æ–¹åŸè¯ã€‚</p>
<ul>
<li>ä½¿ç”¨åŠ¨æœº</li>
</ul>
<blockquote>
<p>é€šè¿‡è§£æ SQL è¯­å¥æå–åˆ†ç‰‡é”®åˆ—ä¸å€¼å¹¶è¿›è¡Œåˆ†ç‰‡æ˜¯ Apache ShardingSphere å¯¹ SQL é›¶ä¾µå…¥çš„å®ç°æ–¹å¼ã€‚è‹¥ SQL è¯­å¥ä¸­æ²¡æœ‰åˆ†ç‰‡æ¡ä»¶ï¼Œåˆ™æ— æ³•è¿›è¡Œåˆ†ç‰‡ï¼Œéœ€è¦å…¨è·¯ç”±ã€‚</p>
<p>åœ¨ä¸€äº›åº”ç”¨åœºæ™¯ä¸­ï¼Œåˆ†ç‰‡æ¡ä»¶å¹¶ä¸å­˜åœ¨äº SQLï¼Œè€Œå­˜åœ¨äºå¤–éƒ¨ä¸šåŠ¡é€»è¾‘ã€‚å› æ­¤éœ€è¦æä¾›ä¸€ç§é€šè¿‡å¤–éƒ¨æŒ‡å®šåˆ†ç‰‡ç»“æœçš„æ–¹å¼ï¼Œåœ¨ Apache ShardingSphere ä¸­å«åš Hintã€‚</p>
</blockquote>
<ul>
<li>å®ç°æœºåˆ¶</li>
</ul>
<blockquote>
<p>Apache ShardingSphere ä½¿ç”¨ <code>ThreadLocal</code> ç®¡ç†åˆ†ç‰‡é”®å€¼ã€‚å¯ä»¥é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼å‘ <code>HintManager</code> ä¸­æ·»åŠ åˆ†ç‰‡æ¡ä»¶ï¼Œè¯¥åˆ†ç‰‡æ¡ä»¶ä»…åœ¨å½“å‰çº¿ç¨‹å†…ç”Ÿæ•ˆã€‚</p>
<p>é™¤äº†é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼ä½¿ç”¨å¼ºåˆ¶åˆ†ç‰‡è·¯ç”±ï¼ŒApache ShardingSphere è¿˜è®¡åˆ’é€šè¿‡ SQL ä¸­çš„ç‰¹æ®Šæ³¨é‡Šçš„æ–¹å¼å¼•ç”¨ Hintï¼Œä½¿å¼€å‘è€…å¯ä»¥é‡‡ç”¨æ›´åŠ é€æ˜çš„æ–¹å¼ä½¿ç”¨è¯¥åŠŸèƒ½ã€‚</p>
<p>æŒ‡å®šäº†å¼ºåˆ¶åˆ†ç‰‡è·¯ç”±çš„ SQL å°†ä¼šæ— è§†åŸæœ‰çš„åˆ†ç‰‡é€»è¾‘ï¼Œç›´æ¥è·¯ç”±è‡³æŒ‡å®šçš„çœŸå®æ•°æ®èŠ‚ç‚¹ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHintAlgorithm</span> <span class="keyword">implements</span> <span class="title">HintShardingAlgorithm</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(Collection collection, HintShardingValue hintShardingValue)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å¼ºåˆ¶è·¯ç”±å¼€å§‹ï¼Œè¡¨æ€»æ•°ï¼š&#123;&#125;ï¼Œè·¯ç”±å­—æ®µï¼š&#123;&#125;&quot;</span>,collection,hintShardingValue.getColumnName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Collection shardingValues = hintShardingValue.getValues();</span><br><span class="line">        List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object o : collection) &#123;</span><br><span class="line">            String targetName = (String) o;</span><br><span class="line">            String suffix = targetName.substring(targetName.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (Object value : shardingValues) &#123;</span><br><span class="line">                Integer v = <span class="keyword">new</span> Integer(value+<span class="string">&quot;&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span>(v % <span class="number">2</span> == Integer.parseInt(suffix))&#123;</span><br><span class="line">                    log.info(<span class="string">&quot;å€¼ï¼š&#123;&#125; è¢«è·¯ç”±åˆ°è¡¨ï¼š&#123;&#125;&quot;</span>,v,targetName);</span><br><span class="line">                    result.add(targetName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;å¼ºåˆ¶è·¯ç”±ç»“æŸï¼š&#123;&#125;&quot;</span>,result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h5><p>åˆ›å»ºæµ‹è¯•ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShardingPracticeApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æµ‹è¯•åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            OrderInfo orderInfo = <span class="keyword">new</span> OrderInfo();</span><br><span class="line">            orderInfo.setOrderStatus(<span class="number">1</span>);</span><br><span class="line">            orderInfo.setUserId(<span class="number">10001L</span> + i);</span><br><span class="line">            orderInfo.setOrderName(<span class="string">&quot;é»„ç„–é¸¡ç±³é¥­&quot;</span> + LocalDateTime.now().toString());</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> save = <span class="keyword">this</span>.orderService.save(orderInfo);</span><br><span class="line">            log.info(<span class="string">&quot;============done:&#123;&#125;&quot;</span>,save);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æµ‹è¯•å¼ºåˆ¶è·¯ç”±</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testHint</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span> ; i++) &#123;</span><br><span class="line">            HintManager hintManager = HintManager.getInstance();</span><br><span class="line">            hintManager.addDatabaseShardingValue(<span class="string">&quot;t_user&quot;</span>,i%<span class="number">2</span>);</span><br><span class="line">            hintManager.addTableShardingValue(<span class="string">&quot;t_user&quot;</span>,i%<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            UserInfo userInfo = <span class="keyword">new</span> UserInfo();</span><br><span class="line">            userInfo.setAddress(<span class="string">&quot;ä¸Šæµ·å¸‚é»„æµ¦åŒºå»¶å®‰ä¸œè·¯618å·&quot;</span>);</span><br><span class="line">            userInfo.setAge(<span class="number">18</span>);</span><br><span class="line">            userInfo.setName(<span class="string">&quot;å¼ é£&quot;</span>+ i);</span><br><span class="line">            userInfo.setMobile(<span class="string">&quot;1762134523&quot;</span>+i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> save = <span class="keyword">this</span>.userService.save(userInfo);</span><br><span class="line">            log.info(<span class="string">&quot;============done:&#123;&#125;&quot;</span>,save);</span><br><span class="line">            hintManager.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å®Œæ•´çš„ä»£ç å‚è§github  <a href="https://github.com/eqshen/sharding-practice">ShardingJDBCèœé¸Ÿå…¥é—¨ç»ƒä¹ </a></p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><p><a href="https://my.oschina.net/u/4318872/blog/4281049">MyCatå’ŒShardingJDBCå¯¹æ¯”</a></p>
</li>
<li><p><a href="http://www.mycat.org.cn/">MyCatå®˜ç½‘</a></p>
</li>
<li><p><a href="https://shardingsphere.apache.org/">ShardingSphereå®˜ç½‘</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>å®è·µ</category>
        <category>åˆ†åº“åˆ†è¡¨</category>
      </categories>
      <tags>
        <tag>å®è·µ</tag>
        <tag>åˆ†åº“åˆ†è¡¨</tag>
        <tag>ShardingSphere</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»å®¡è®¡æ—¥å¿—(æ“ä½œæ—¥å¿—)è¯´èµ·</title>
    <url>/2021/09/21/%E4%BB%8E%E5%AE%A1%E8%AE%A1%E6%97%A5%E5%BF%97-%E6%93%8D%E4%BD%9C-%E8%AF%B4%E8%B5%B7/</url>
    <content><![CDATA[<h3 id="ä»å®¡è®¡æ—¥å¿—-æ“ä½œæ—¥å¿—-è¯´èµ·"><a href="#ä»å®¡è®¡æ—¥å¿—-æ“ä½œæ—¥å¿—-è¯´èµ·" class="headerlink" title="ä»å®¡è®¡æ—¥å¿—(æ“ä½œæ—¥å¿—)è¯´èµ·"></a>ä»å®¡è®¡æ—¥å¿—(æ“ä½œæ—¥å¿—)è¯´èµ·</h3><p>æ—¶éš”ä¸€å¹´ï¼Œå·æ‡’äº†ä¸€å¹´ï¼Œå†æ¬¡å¼€å§‹å†™æ—¥å¿—ï¼Œè¡¥è¡¥æŠ€æœ¯å€º</p>
<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>åœ¨å…¬å¸æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°è®°å½•æ“ä½œï¼ˆå®¡è®¡ï¼‰æ—¥å¿—çš„æƒ…å†µï¼Œæ ¼å¼åƒè¿™æ ·ï¼š<code>æ³•å¤–ç‹‚äººå¼ ä¸‰ ä¿®æ”¹äº† xxxé…ç½®ï¼Œä» 123 ä¿®æ”¹ä¸º 456ï¼Œå½±å“ 1 è¡Œ</code>ã€‚å¦‚æœä¸€ä¸ªé¡¹ç›®ä¸­crudçš„æ¥å£æ¯”è¾ƒå°‘ï¼Œé‚£æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨ æ¥å£ä¸­ç¡¬ç¼–ç ï¼Œè¿™ä¸­æ–¹å¼ä¹Ÿæ˜¯æœ€ç›´æ¥æœ€å¿«çš„æ–¹å¼ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªè¿½æ±‚å®Œç¾çš„â€œæŠ€æœ¯ç™–â€æ¥è¯´ï¼Œè¿˜æ˜¯å­˜åœ¨ä»¥ä¸‹æ‹…å¿§çš„åœ°æ–¹</p>
<ul>
<li>æ¥å£å¯èƒ½ä¸æ˜¯åŒä¸€ä¸ªäººå¼€å‘ï¼Œæ—¥å¿—çš„æ ¼å¼å¦‚ä½•ç»Ÿä¸€ï¼Ÿæ¨¡æ¿æ–¹æ³•ï¼Ÿ</li>
<li>åç»­ä¿®æ”¹ï¼Œæ¯ä¸ªåœ°æ–¹éƒ½è¦ä¿®æ”¹ï¼Œå·¥ä½œé‡å°±æ¯”è¾ƒå¤§ï¼Œä¸å¥½ç»´æŠ¤</li>
<li>é€šç”¨é€»è¾‘æ¤å…¥ä¸šåŠ¡ä»£ç ï¼Œå¾ˆä¸çˆ½</li>
<li>æ¯ä¸ªæ¥å£å…¥å‚å’Œå‡ºå‚æ ¼å¼ä¸ä¸€æ ·ï¼Œå¦‚ä½•ä»ä¸­æå–å‚æ•°ä¿¡æ¯ï¼Ÿ</li>
</ul>
<h4 id="å…·ä½“éœ€æ±‚ä¸¾ä¾‹"><a href="#å…·ä½“éœ€æ±‚ä¸¾ä¾‹" class="headerlink" title="å…·ä½“éœ€æ±‚ä¸¾ä¾‹"></a>å…·ä½“éœ€æ±‚ä¸¾ä¾‹</h4><p>å„ä¸ªä¸šåŠ¡éœ€è¦ç»Ÿä¸€å°†æ“ä½œæ—¥å¿—è®°å½•å¹¶ç»Ÿä¸€ä¸ŠæŠ¥ï¼Œä¸ŠæŠ¥çš„æŠ¥æ–‡è¦åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>æ“ä½œäºº  : æ“ä½œäººçš„userId</li>
<li>æ“ä½œæ—¶é—´ï¼š2021å¹´09æœˆ21æ—¥14:31:34</li>
<li>æ“ä½œç±»å‹ï¼šC - å¢åŠ ï¼ŒR - è¯»ï¼ŒU - æ›´æ–°ï¼ŒD - åˆ é™¤</li>
<li>æ“ä½œå¯¹è±¡ï¼šå¦‚ orderNo , userId</li>
<li>å½±å“è¡Œæ•°ï¼š22</li>
</ul>
<p>å…¶ä¸­å½±å“è¡Œæ•°ï¼Œåœ¨è¯»å–çš„æƒ…å†µä¸‹æŒ‡è¯»å–çš„è¡Œæ•°ï¼Œå†™çš„æƒ…å†µä¸‹æŒ‡å½±å“çš„è¡Œæ•°ï¼Œè¿™äº›éƒ½æ˜¯è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡é€»è¾‘æ¥ç¡®å®šçš„ï¼Œæ— æ³•æŠ½è±¡å…±ç”¨</p>
<p>| ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªå…·ä½“çš„éœ€æ±‚å†…å®¹ç®€åŒ–ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ–¹æ¡ˆè®¾è®¡äº†ã€‚</p>
<h4 id="å¸¸è§çš„è§£å†³æ–¹æ¡ˆ"><a href="#å¸¸è§çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§çš„è§£å†³æ–¹æ¡ˆ"></a>å¸¸è§çš„è§£å†³æ–¹æ¡ˆ</h4><ol>
<li><p>ä»æ•°æ®å±‚é¢å…¥æ‰‹ï¼Œè®¢é˜…æ•°æ®åº“Binlog<br> ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡Canalè®¢é˜…MySQLçš„binlog, è¿™æ ·æ¯æ¬¡å°±èƒ½çŸ¥é“å“ªå¼ è¡¨ã€å“ªè¡Œè¢«ä¿®æ”¹äº†ã€‚</p>
<ul>
<li>å¥½å¤„ï¼šç›´æ¥å’Œä¸šåŠ¡é€»è¾‘è§£è€¦</li>
<li>ç¼ºç‚¹ï¼šå¤æ‚çš„ä¸šåŠ¡é€»è¾‘æ— æ³•è¡¨ç°å‡ºæ¥ï¼Œå¦‚æœä¸€ä¸ªæ¥å£ä¸­ä¿®æ”¹äº†å¾ˆå¤šæ¥å£ï¼Œç”šè‡³è¿˜æœ‰RPCè°ƒç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¸å¤ªå®ç”¨è¿™ç§æ–¹æ¡ˆäº†ã€‚</li>
</ul>
</li>
<li><p>å®šä¹‰ç±»ä¼¼LogUtilä¸€æ ·çš„å·¥å…·ç±»ï¼ŒæŠ½è±¡å…¥å‚ï¼Œåœ¨å·¥å…·ç±»ä¸­å®ç°æ¨¡æ¿åŒ–ï¼Œåœ¨éœ€è¦è®°å½•æ—¥å¿—çš„åœ°æ–¹è°ƒç”¨å·¥å…·ç±»</p>
<p> è¿™ç§æ–¹å¼ä¹Ÿæ˜¯æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°ï¼Œè€Œä¸”æ˜¯æ¯”è¾ƒç®€å•çš„å®ç°ã€‚</p>
</li>
<li><p>è‡ªå®šä¹‰æ³¨è§£ + Aop + SpELå®ç°è§£è€¦</p>
<p> è¿™ç§æ–¹æ³•å°±æ˜¯æˆ‘ä»¬è¦å®ç°çš„æ–¹å¼äº†ï¼Œè¦åšä¸€ä¸ªæœ‰è¿½æ±‚çš„<code>æ–°æ—¶ä»£å†œæ°‘å·¥</code>ã€‚</p>
</li>
</ol>
<h4 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h4><ol>
<li>é¦–å…ˆå®šä¹‰æ³¨è§£<br>ç”¨äºåœ¨controlleræ–¹æ³•ä¸Šè¿›è¡Œæ ‡è®°ï¼Œå¹¶æä¾›åˆ‡é¢æ ‡è®°</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">public @interface AuditLog &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * æ“ä½œç±»å‹</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    OperateType operateType();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * æ“ä½œå¯¹è±¡è¡¨è¾¾å¼</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    String opTargetEL();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * å½±å“è¡Œæ•°è¡¨è¾¾å¼</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    String effectRowsEL();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å®šä¹‰ä½¿ç”¨åˆ°çš„å®ä½“ç±»</li>
</ol>
<p>ç”¨äºå­˜å‚¨ AuditLog åœ¨aopè¿‡ç¨‹ä¸­æ‰€éœ€è¦çš„ä¸­é—´è¿‡ç¨‹æ•°æ®</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * å­˜å‚¨åˆ‡é¢è¿‡ç¨‹ä¸­ä¸€äº›å…ƒæ•°æ®</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AuditLogAopMetaDTO &#123;</span><br><span class="line">    private HttpServletRequest httpServletRequest;</span><br><span class="line"></span><br><span class="line">    private AuditLog auditLog;</span><br><span class="line"></span><br><span class="line">    private String httpMethodType;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Getè¯·æ±‚å‚æ•°</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private Map&lt;String,Object&gt; reqParam;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Postè¯·æ±‚å‚æ•°</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private Object postParam;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨äºå­˜å‚¨æœ€ç»ˆçš„æ“ä½œæ—¥å¿—ç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * æ“ä½œæ—¥å¿—å¯¹è±¡</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AuditLogDTO &#123;</span><br><span class="line"></span><br><span class="line">    private LocalDateTime opTime;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * @see com.eqshen.auditlogstarter.enums.OperateType</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private String operateType;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * æ“ä½œäººè´¦å·æˆ–id</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private String opAccount;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * æ“ä½œå¯¹è±¡ï¼Œå¦‚ è®¢å•å·ï¼Œç”¨æˆ·idç­‰</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private String opTarget;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * æ“ä½œç»“æœï¼Œå½±å“è¡Œæ•°ç­‰</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private String opResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å®šä¹‰åˆ‡é¢å¤„ç†ç±»</li>
</ol>
<p>è¿™é‡Œæ˜¯ä¸»è¦çš„é€»è¾‘, ä»£ç ä¸å¤æ‚ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class AuditLogInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    @Pointcut(&quot;@annotation(com.eqshen.auditlogstarter.annotation.AuditLog)&quot;)</span><br><span class="line">    public void pointcut()&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Around(&quot;pointcut()&quot;)</span><br><span class="line">    public Object around(ProceedingJoinPoint point) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">        Object result &#x3D; null;</span><br><span class="line">        final AuditLogDTO auditLogDTO;</span><br><span class="line">        final AuditLogAopMetaDTO auditLogAopMetaDTO &#x3D; this.beforeProcess(point);</span><br><span class="line"></span><br><span class="line">        try&#123;</span><br><span class="line">            result &#x3D; point.proceed();</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">            auditLogDTO &#x3D; this.afterProcess(auditLogAopMetaDTO, result);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;å¼‚æ­¥æ¨é€kafka</span><br><span class="line">            this.asyncSendToKafka(auditLogDTO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private AuditLogAopMetaDTO beforeProcess(ProceedingJoinPoint point)&#123;</span><br><span class="line">        AuditLogAopMetaDTO auditLogAopMetaDTO &#x3D; new AuditLogAopMetaDTO();</span><br><span class="line">        try&#123;</span><br><span class="line">            RequestAttributes ra &#x3D; RequestContextHolder.getRequestAttributes();</span><br><span class="line">            ServletRequestAttributes sra &#x3D; (ServletRequestAttributes) ra;</span><br><span class="line">            if (sra &#x3D;&#x3D; null) return null;</span><br><span class="line"></span><br><span class="line">            final HttpServletRequest request &#x3D; sra.getRequest();</span><br><span class="line"></span><br><span class="line">            String methodType &#x3D; request.getMethod();;</span><br><span class="line">            Method method &#x3D; AopUtil.getMethod(point);</span><br><span class="line">            AuditLog auditLog &#x3D; method.getAnnotation(AuditLog.class);</span><br><span class="line"></span><br><span class="line">            auditLogAopMetaDTO.setAuditLog(auditLog);</span><br><span class="line">            auditLogAopMetaDTO.setHttpMethodType(methodType);</span><br><span class="line">            auditLogAopMetaDTO.setHttpServletRequest(request);</span><br><span class="line">            auditLogAopMetaDTO.setReqParam(AopUtil.getParamsNameAndValue(point));</span><br><span class="line">            auditLogAopMetaDTO.setPostParam(AopUtil.getPostParam(point));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            log.error(&quot;é¢„å¤„ç†å¤±è´¥&quot;,e);</span><br><span class="line">        &#125;</span><br><span class="line">        return auditLogAopMetaDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private AuditLogDTO afterProcess(AuditLogAopMetaDTO aopMeta, Object result)&#123;</span><br><span class="line">        if(aopMeta &#x3D;&#x3D; null)&#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        final AuditLog auditLog &#x3D; aopMeta.getAuditLog();</span><br><span class="line"></span><br><span class="line">        Object opTarget &#x3D; SpELUtil.explainEl(aopMeta.getPostParam(),auditLog.opTargetEL());</span><br><span class="line"></span><br><span class="line">        if(opTarget &#x3D;&#x3D; null)&#123;</span><br><span class="line">            opTarget &#x3D; SpELUtil.explainEl(aopMeta.getReqParam(),auditLog.opTargetEL());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String effectRows &#x3D; String.valueOf(SpELUtil.explainEl(result,auditLog.effectRowsEL()));</span><br><span class="line"></span><br><span class="line">        AuditLogDTO auditLogDTO &#x3D; new AuditLogDTO();</span><br><span class="line">        auditLogDTO.setOpTime(LocalDateTime.now());</span><br><span class="line">        auditLogDTO.setOperateType(auditLogDTO.getOperateType());</span><br><span class="line">        auditLogDTO.setOpAccount(null);&#x2F;&#x2F;ä¸€èˆ¬ä»Contextä¸­è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">        auditLogDTO.setOpResult(effectRows);</span><br><span class="line">        auditLogDTO.setOpTarget(String.valueOf(opTarget&#x3D;&#x3D;null?&quot;&quot;:opTarget));</span><br><span class="line"></span><br><span class="line">        return auditLogDTO;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void asyncSendToKafka(AuditLogDTO auditLogDTO)&#123;</span><br><span class="line">        if(auditLogDTO &#x3D;&#x3D; null) return;</span><br><span class="line">        &#x2F;&#x2F;æ¨èä½¿ç”¨çº¿ç¨‹æ•°æ± æ“ä½œ,æ­¤å¤„ä»…è¾“å‡ºæ—¥å¿—</span><br><span class="line">        log.info(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; æ“ä½œæ—¥å¿—ï¼š&#123;&#125;&quot;, JSONObject.toJSONString(auditLogDTO));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„ä¸€ä¸ª SpELUtilå·¥å…·ç±»æ˜¯ç”¨æ¥è§£æspelè¡¨è¾¾å¼çš„ï¼Œä¹Ÿå¾ˆç®€å•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">public class SpELUtil &#123;</span><br><span class="line">    &#x2F;&#x2F;thread-safe</span><br><span class="line">    private static final SpelExpressionParser parser &#x3D; new SpelExpressionParser();</span><br><span class="line"></span><br><span class="line">    private static final TemplateParserContext parserContext &#x3D; new TemplateParserContext(&quot;#&#123;&quot;, &quot;&#125;&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static Object explainEl(Object obj, String spELExpression)&#123;</span><br><span class="line">        if (StringUtils.isEmpty(spELExpression) || obj &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; springçš„è¡¨è¾¾å¼ä¸Šä¸‹æ–‡å¯¹è±¡</span><br><span class="line">            StandardEvaluationContext context &#x3D; new StandardEvaluationContext();</span><br><span class="line">            context.addPropertyAccessor(new MapAccessor());&#x2F;&#x2F;å¢åŠ å¯¹mapçš„è®¿é—®æ”¯æŒ</span><br><span class="line">            context.setRootObject(obj);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            Expression expression &#x3D; parser.parseExpression(spELExpression, parserContext);</span><br><span class="line">            return expression.getValue(context);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;SpELè§£æå¤±è´¥, è¡¨è¾¾å¼: &#123;&#125;, è¾“å…¥: &#123;&#125;&quot;, spELExpression, JSONObject.toJSONString(obj), e);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æµ‹è¯•<br>å®šä¹‰TestControllerï¼Œç®€å•æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class TestController &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;listUsers&quot;)</span><br><span class="line">    @AuditLog(opTargetEL &#x3D; &quot;&quot;,operateType &#x3D; OperateType.READ,effectRowsEL &#x3D; &quot;#&#123;data.size()&#125;&quot;)</span><br><span class="line">    public JSONObject queryUserList()&#123;</span><br><span class="line">        JSONObject resp &#x3D; new JSONObject();</span><br><span class="line">        resp.put(&quot;code&quot;,200);</span><br><span class="line">        resp.put(&quot;msg&quot;,&quot;success&quot;);</span><br><span class="line"></span><br><span class="line">        List&lt;UserInfo&gt; userList &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        userList.add(new UserInfo(&quot;u-007&quot;,&quot;å¼ ä¸‰&quot;,2,&quot;17621345678&quot;));</span><br><span class="line">        userList.add(new UserInfo(&quot;u-001&quot;,&quot;æå››&quot;,3,&quot;17621345679&quot;));</span><br><span class="line"></span><br><span class="line">        resp.put(&quot;data&quot;,userList);</span><br><span class="line">        return resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;getUserInfo&quot;)</span><br><span class="line">    @AuditLog(operateType &#x3D; OperateType.READ,</span><br><span class="line">            opTargetEL &#x3D; &quot;æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼š#&#123;userId&#125;&quot;,</span><br><span class="line">            effectRowsEL &#x3D; &quot;#&#123;data &#x3D;&#x3D; null?0:1&#125;&quot;)</span><br><span class="line">    public JSONObject getUser(String userId)&#123;</span><br><span class="line">        JSONObject resp &#x3D; new JSONObject();</span><br><span class="line">        resp.put(&quot;code&quot;,200);</span><br><span class="line">        resp.put(&quot;msg&quot;,&quot;success&quot;);</span><br><span class="line">        resp.put(&quot;data&quot;,new UserInfo(&quot;u-007&quot;,&quot;å¼ ä¸‰&quot;,2,&quot;17621345678&quot;));</span><br><span class="line"></span><br><span class="line">        return resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @PostMapping(&quot;&#x2F;operateUser&quot;)</span><br><span class="line">    @AuditLog(operateType &#x3D; OperateType.UPDATE,</span><br><span class="line">            opTargetEL &#x3D; &quot;ç”¨æˆ·id: #&#123;userId&#125;&quot;, &#x2F;&#x2F;å¿…é¡»è·Ÿ userInfoå¯¹è±¡ä¸­çš„å±æ€§åç§°ä¸€è‡´</span><br><span class="line">            effectRowsEL &#x3D; &quot;#&#123;code &#x3D;&#x3D; 200?1:0&#125;&quot;)</span><br><span class="line">    public JSONObject operateUser(@RequestBody UserInfo userInfo)&#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;ç”¨äºæµ‹è¯•å¼‚å¸¸æƒ…å†µ</span><br><span class="line">        if(Objects.equals(userInfo.getUserId(), &quot;1234&quot;))&#123;</span><br><span class="line">            throw new RuntimeException(&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        JSONObject resp &#x3D; new JSONObject();</span><br><span class="line">        resp.put(&quot;code&quot;,200);</span><br><span class="line">        resp.put(&quot;msg&quot;,&quot;success&quot;);</span><br><span class="line">        return resp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>æµ‹è¯•1<br>è¯·æ±‚åŠè¿”å›ï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET http:&#x2F;&#x2F;localhost:8080&#x2F;listUsers</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Sat, 25 Sep 2021 09:10:57 GMT</span><br><span class="line">Keep-Alive: timeout&#x3D;60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;msg&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;code&quot;: 200,</span><br><span class="line">  &quot;data&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;userId&quot;: &quot;u-007&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;å¼ ä¸‰&quot;,</span><br><span class="line">      &quot;level&quot;: 2,</span><br><span class="line">      &quot;mobile&quot;: &quot;17621345678&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;userId&quot;: &quot;u-001&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;æå››&quot;,</span><br><span class="line">      &quot;level&quot;: 3,</span><br><span class="line">      &quot;mobile&quot;: &quot;17621345679&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>æ—¥å¿—è¾“å‡ºï¼š<br><code>======&gt; æ“ä½œæ—¥å¿—ï¼š&#123;&quot;opResult&quot;:&quot;2&quot;,&quot;opTarget&quot;:&quot;&quot;,&quot;opTime&quot;:&quot;2021-09-25T17:07:38.093127000&quot;&#125; </code></p>
<ul>
<li>æµ‹è¯•2<br>è¯·æ±‚åŠè¿”å›ï¼š <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET http:&#x2F;&#x2F;localhost:8080&#x2F;getUserInfo?userId&#x3D;1234</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Sat, 25 Sep 2021 09:09:11 GMT</span><br><span class="line">Keep-Alive: timeout&#x3D;60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;msg&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;code&quot;: 200,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;userId&quot;: &quot;u-007&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;å¼ ä¸‰&quot;,</span><br><span class="line">    &quot;level&quot;: 2,</span><br><span class="line">    &quot;mobile&quot;: &quot;17621345678&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>æ—¥å¿—è¾“å‡ºï¼š<br><code>======&gt; æ“ä½œæ—¥å¿—ï¼š&#123;&quot;opResult&quot;:&quot;1&quot;,&quot;opTarget&quot;:&quot;æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼š1234&quot;,&quot;opTime&quot;:&quot;2021-09-25T17:11:40.489187000&quot;&#125; </code></p>
<ul>
<li>æµ‹è¯•3<br>è¯·æ±‚åŠè¿”å›ï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST http:&#x2F;&#x2F;localhost:8080&#x2F;operateUser</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Sat, 25 Sep 2021 09:12:49 GMT</span><br><span class="line">Keep-Alive: timeout&#x3D;60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;msg&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;code&quot;: 200</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>æ—¥å¿—è¾“å‡ºï¼š<br><code>======&gt; æ“ä½œæ—¥å¿—ï¼š&#123;&quot;opResult&quot;:&quot;1&quot;,&quot;opTarget&quot;:&quot;ç”¨æˆ·id: 12345&quot;,&quot;opTime&quot;:&quot;2021-09-25T17:13:47.193806000&quot;&#125; </code></p>
<h4 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h4><ol>
<li>å…³äºSpELçš„è¯­æ³•å¯ä»¥å»çœ‹Springå®˜æ–¹æ–‡æ¡£<ul>
<li><a href="http://itmyhome.com/spring/expressions.html">http://itmyhome.com/spring/expressions.html</a></li>
<li><a href="https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/expressions.html">https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/expressions.html</a></li>
</ul>
</li>
</ol>
<ol start="2">
<li><p>å®Œæ•´ä»“åº“åœ°å€</p>
<ul>
<li><a href="https://github.com/eqshen/audit-log-starter">https://github.com/eqshen/audit-log-starter</a></li>
</ul>
</li>
</ol>
]]></content>
      <tags>
        <tag>AOP</tag>
      </tags>
  </entry>
  <entry>
    <title>æ’ä»¶é›†æˆ-ç±»åŠ è½½ç®€å•å®è·µåŠè¸©å‘</title>
    <url>/2022/01/09/%E6%8F%92%E4%BB%B6%E9%9B%86%E6%88%90-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5%E5%8F%8A%E8%B8%A9%E5%9D%91/</url>
    <content><![CDATA[<h3 id="æ’ä»¶é›†æˆ-ç±»åŠ è½½ç®€å•å®è·µåŠè¸©å‘"><a href="#æ’ä»¶é›†æˆ-ç±»åŠ è½½ç®€å•å®è·µåŠè¸©å‘" class="headerlink" title="æ’ä»¶é›†æˆ-ç±»åŠ è½½ç®€å•å®è·µåŠè¸©å‘"></a>æ’ä»¶é›†æˆ-ç±»åŠ è½½ç®€å•å®è·µåŠè¸©å‘</h3><h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a><strong>èƒŒæ™¯</strong></h4><p>åœ¨é¡¹ç›®ä¸­ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚åœºæ™¯ï¼Œç³»ç»Ÿwebç«¯è¦æ”¯æŒæ’ä»¶åŠŸèƒ½ï¼Œæ’ä»¶åŠŸèƒ½å…¶ä¸­ä¸€ç‚¹å°±æ˜¯è¦æ”¯æŒ jaråŒ…ä¸Šä¼ ï¼ˆjaråŒ…ä¸­åŒ…å«æ’ä»¶é€»è¾‘ï¼‰ï¼Œç„¶åæŠŠæ’ä»¶åº”ç”¨åœ¨æŸä¸ªæµç¨‹ä¸­ã€‚å¦‚ï¼šè¦æŠŠIPåœ°å€ 192.168.12.13 è½¬ä¸º 192.168.12ã€‚</p>
<p>æ”¯æŒæ’ä»¶çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯ï¼Œä¸€äº›å‰ç½®è½¬æ¢å°±æ¯”è¾ƒçµæ´»ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½æ”¹ä»£ç é‡æ–°éƒ¨ç½²ã€‚</p>
<h4 id="V1-Begin-to-explore"><a href="#V1-Begin-to-explore" class="headerlink" title="V1 Begin to explore"></a><strong>V1 Begin to explore</strong></h4><p>é¡¹ç›®ä¸­å®šä¹‰ä¸€ä¸ªæ¨¡æ¿æ¥å£ IPluginJarTemplateï¼Œæ‰€æœ‰jaræ’ä»¶éœ€è¦å®ç°è¯¥æ¨¡æ¿æ¥å£ IPluginJarTemplateã€‚ç„¶ååˆ©ç”¨JAVA SPIåŠ è½½ IPluginJarTemplateçš„æ‰€æœ‰å®ç°ç±»çš„å®ä¾‹å¹¶ç¼“å­˜å¤‡ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginJarClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JarFile jarFile;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginJarClassLoader</span><span class="params">(ClassLoader parent,JarFile jar)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="keyword">this</span>.jarFile = jar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String className) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        String filename = className.replace(<span class="string">&#x27;.&#x27;</span>, File.separatorChar) + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        JarEntry jarEntry = jarFile.getJarEntry(filename);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(jarEntry == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(filename);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>(InputStream inputStream = jarFile.getInputStream(jarEntry))&#123;</span><br><span class="line">            ByteArrayOutputStream byteStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">int</span> nextValue;</span><br><span class="line">            <span class="keyword">while</span> (-<span class="number">1</span> != (nextValue = inputStream.read())) &#123;</span><br><span class="line">                byteStream.write(nextValue);</span><br><span class="line">            &#125;</span><br><span class="line">            classBytes = byteStream.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;æ’ä»¶åŠ è½½ç±»å‡ºé”™ï¼š class : &#123;&#125;,error: &#123;&#125;&quot;</span>,filename,e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> defineClass(className, classBytes, <span class="number">0</span>, classBytes.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ç±»åŠ è½½</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PluginJarClassLoader pluginJarClassLoader = <span class="keyword">new</span> PluginJarClassLoader(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> JarFile(file));</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨JAVA SPIåŠ è½½IPluginJarTemplateæ‰€æœ‰å®ç°ç±»å®ä¾‹</span></span><br><span class="line">ServiceLoader&lt;IPluginJarTemplate&gt; allImplementations = ServiceLoader.load(IPluginJarTemplate.class, pluginJarClassLoader);</span><br><span class="line">Iterator&lt;IPluginJarTemplate&gt; iterator = allImplementations.iterator();</span><br><span class="line"><span class="keyword">if</span> (iterator.hasNext())&#123;</span><br><span class="line">    IPluginJarTemplate funcImplementation = iterator.next();</span><br><span class="line">    String cacheKey = PluginJarFileCache.genCacheKey(pluginDto);</span><br><span class="line">    PluginJarFileCache.put(cacheKey,funcImplementation);</span><br><span class="line">    log.info(<span class="string">&quot;åŠ è½½Jarç±»ï¼š&#123;&#125;&quot;</span>,funcImplementation.getClass().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä½†ä¸Šè¿°åŠ è½½æµç¨‹å­˜åœ¨é—®é¢˜ï¼Œæ— æ³•åŠ è½½åˆ°ç±»</p>
<p>Debugè·Ÿè¿›SPIæºç ï¼Œå‘ç°å…³é”®ç‚¹åœ¨äº loader.getResources(fullName) ï¼Œè§ä¸‹æ–¹ä»£ç ï¼ŒfullNameè¿™ä¸ªå˜é‡çš„å€¼å½¢å¦‚ï¼šMETA-INF/services/xxxxx , ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šé€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨å»åŠ è½½ SPIæ‰€éœ€çš„é…ç½®æ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">LazyIterator</span><span class="params">(Class&lt;S&gt; service, ClassLoader loader)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.service = service;</span><br><span class="line">            <span class="keyword">this</span>.loader = loader;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasNextService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (nextName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (configs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String fullName = PREFIX + service.getName();</span><br><span class="line">                    <span class="keyword">if</span> (loader == <span class="keyword">null</span>)</span><br><span class="line">                        configs = ClassLoader.getSystemResources(fullName);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        configs = loader.getResources(fullName);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">                    fail(service, <span class="string">&quot;Error locating configuration files&quot;</span>, x);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ((pending == <span class="keyword">null</span>) || !pending.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!configs.hasMoreElements()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                pending = parse(service, configs.nextElement());</span><br><span class="line">            &#125;</span><br><span class="line">            nextName = pending.next();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p>è€Œæˆ‘ä»¬è‡ªå®šä¹‰ç±»åŠ è½½çš„ç»§æ‰¿å…³ç³»æ˜¯ PluginJarClassLoader extends ClassLoader , è€ŒgetResourcesæ–¹æ³• ClassLoader çš„é»˜è®¤å®ç°æ˜¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Enumeration&lt;URL&gt; <span class="title">getResources</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    Enumeration&lt;URL&gt;[] tmp = (Enumeration&lt;URL&gt;[]) <span class="keyword">new</span> Enumeration&lt;?&gt;[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        tmp[<span class="number">0</span>] = parent.getResources(name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tmp[<span class="number">0</span>] = getBootstrapResources(name);</span><br><span class="line">    &#125;</span><br><span class="line">    tmp[<span class="number">1</span>] = findResources(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CompoundEnumeration&lt;&gt;(tmp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>é€šè¿‡ä¸Šè¿°ä»£ç ï¼Œä¸éš¾å‘ç°å…³é”®ç‚¹æ¥åˆ°äº† tmp[1] = findResources(name) è¿™ä¸ªåœ°æ–¹ï¼Œè€Œ findResourcesçš„é»˜è®¤å®ç°æ˜¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> java.util.Collections.emptyEnumeration();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>æ‰€ä»¥æ— æ³•åŠ è½½æ’ä»¶ä¸­çš„ç±»ï¼Œå°±è‡ªç„¶ä¸éš¾ç†è§£äº†ã€‚</p>
<h4 id="V2-How-to-reslove"><a href="#V2-How-to-reslove" class="headerlink" title="V2 How to reslove"></a><strong>V2 How to reslove</strong></h4><p>åˆ°è¿™ï¼Œå°±æœ‰ä¸¤ç§æ–¹æ³•äº†</p>
<ul>
<li>ç¬¬ä¸€ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸­é‡å†™ findResources</li>
<li>ç¬¬äºŒï¼Œæ‰¾ä¸€ä¸ª å·²ç»é‡å†™äº†findResourcesæ–¹æ³•çš„ç±»åŠ è½½å™¨ï¼Œé€šè¿‡ç±»ç»§æ‰¿å…³ç³»ï¼Œå‘ç°URLClassLoaderç¬¦åˆæ¡ä»¶</li>
</ul>
<p>ä¸¤ç§æ–¹æ³•æˆ‘ä»¬éƒ½è¯•ä¸€ä¸‹</p>
<h5 id="é‡å†™findResources"><a href="#é‡å†™findResources" class="headerlink" title="é‡å†™findResources"></a><strong>é‡å†™findResources</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        JarEntry jarEntry = jarFile.getJarEntry(name);</span><br><span class="line">        <span class="keyword">if</span>(jarEntry != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰¾åˆ°èµ„æº&quot;</span> + jarEntry.getName());</span><br><span class="line">            File file = <span class="keyword">new</span> File(<span class="string">&quot;/tmp/jarEntry_temp&quot;</span>);</span><br><span class="line">            FileUtil.writeFromStream(jarFile.getInputStream(jarEntry), file);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Collections.enumeration(Collections.singletonList(file.toURI().toURL()));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> java.util.Collections.emptyEnumeration();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>ç„¶åæµ‹è¯•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        JarFile jarFile = <span class="keyword">new</span> JarFile(<span class="string">&quot;/Users/eqshen/workspace/plugin-review/plugin-client/build/libs/plugin-client-1.0-SNAPSHOT.jar&quot;</span>);</span><br><span class="line">        PluginJarClassLoader classLoader = <span class="keyword">new</span> PluginJarClassLoader(<span class="keyword">this</span>.getClass().getClassLoader(), jarFile);</span><br><span class="line"></span><br><span class="line">        ServiceLoader&lt;IPluginJarTemplate&gt; allImplementations = ServiceLoader.load(IPluginJarTemplate.class, classLoader);</span><br><span class="line">        Iterator&lt;IPluginJarTemplate&gt; iterator = allImplementations.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">            IPluginJarTemplate funcImplementation = iterator.next();</span><br><span class="line">            log.info(<span class="string">&quot;åŠ è½½Jarç±»ï¼š&#123;&#125;&quot;</span>,funcImplementation.getClass().getName());</span><br><span class="line">            log.info(<span class="string">&quot;======= result: &#123;&#125;&quot;</span>,funcImplementation.execute(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>æµ‹è¯•å‘ç°ç±»æˆåŠŸåŠ è½½å¹¶æ‰§è¡Œ</p>
<h5 id="ä½¿ç”¨URLClassLoader"><a href="#ä½¿ç”¨URLClassLoader" class="headerlink" title="ä½¿ç”¨URLClassLoader"></a><strong>ä½¿ç”¨URLClassLoader</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">&quot;/Users/eqshen/workspace/plugin-review/plugin-client/build/libs/plugin-client-1.0-SNAPSHOT.jar&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ClassLoader ucl = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[] &#123;file.toURI().toURL()&#125;, <span class="keyword">this</span>.getClass().getClassLoader());</span><br><span class="line">        ServiceLoader&lt;IPluginJarTemplate&gt; allImplementations = ServiceLoader.load(IPluginJarTemplate.class, ucl);</span><br><span class="line">        Iterator&lt;IPluginJarTemplate&gt; iterator = allImplementations.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">            IPluginJarTemplate funcImplementation = iterator.next();</span><br><span class="line">            log.info(<span class="string">&quot;=======result: &#123;&#125;&quot;</span>,funcImplementation.execute(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>));</span><br><span class="line">            log.info(<span class="string">&quot;åŠ è½½Jarç±»ï¼š&#123;&#125;&quot;</span>,funcImplementation.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¹Ÿå¯ä»¥æˆåŠŸåŠ è½½ IPluginJarTemplateçš„æ‰€æœ‰å®ç°ç±»ã€‚</p>
<p>æ˜¾ç„¶ï¼Œé€šè¿‡ç¬¬äºŒç§æ–¹å¼æ›´ç®€æ´ã€ç¬¦åˆå®é™…åº”ç”¨</p>
<h4 id="è¸©å‘"><a href="#è¸©å‘" class="headerlink" title="è¸©å‘"></a><strong>è¸©å‘</strong></h4><p>å…¶å®ä¸Šé¢ é€šè¿‡ URLClassLoaderåŠ è½½çš„æ–¹å¼è¿˜æ˜¯æœ‰ä¸ªå‘çš„ï¼Œ URLClassLoaderæ„é€ å‡½æ•°ä¼ å…¥çš„çˆ¶ç±»æ˜¯ ClassLoader.getSystemClassLoader(), è¿™ä¸ªä»£ç åœ¨æœ¬åœ°IDEAä¸­å¯åŠ¨æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœå‘åˆ°æµ‹è¯•ç¯å¢ƒæˆ–è€…æœ¬åœ°é€šè¿‡ java -jarçš„æ–¹å¼å¯åŠ¨ï¼Œå°±ä¼šæŠ¥é”™ ServiceConfigurationError not subtype, é€šè¿‡googleæŸ¥æ‰¾èµ„æºï¼Œå¤§æ¦‚äº†è§£åˆ°åŸå› å¦‚ä¸‹ï¼š</p>
<ul>
<li>plugin-management-spi-1.0-SNAPSHOT.jar è¿™ä¸ªjaråŒ…ä¸­åŒ…å«äº† IPluginJarTemplate.classè¿™ä¸ªç±»ï¼Œç”±URLClassloaderåŠ è½½å™¨åŠ è½½</li>
<li>è€Œæˆ‘ä»¬æ’ä»¶ä½¿ç”¨çš„é¡¹ç›®ä¸­ä¹Ÿå­˜åœ¨ IPluginJarTemplate.classè¿™ä¸ªç±»ï¼Œç”± æœªçŸ¥ç±»åŠ è½½å™¨ï¼ˆæš‚æ—¶ç§°ä¸ºXï¼‰åŠ è½½ï¼Œ Xè‚¯å®šä¸ç­‰äº ClassLoader.getSystemClassLoader()</li>
<li>åœ¨ä½¿ç”¨ ServiceLoader.load(IPluginJarTemplate.class, ucl) è·å¾—ç±»çš„å®ä¾‹çš„æ—¶å€™ï¼Œä¼šæŠŠ URLClassloader åŠ è½½çš„ IPluginJarTemplate.classå­ç±» å®ä¾‹æ‰§è¡Œ Xç±»åŠ è½½å™¨åŠ è½½çš„ IPluginJarTemplate.class ï¼ˆå¤šæ€çš„è¡¨ç°ï¼‰</li>
<li>è™½ç„¶ äºŒè€…é€»è¾‘ä¸Šæ˜¯ çˆ¶å­å…³ç³»ï¼Œä½†åˆ†åˆ«ç”±ä¸¤ä¸ªç±»åŠ è½½å™¨åŠ è½½ï¼Œåˆ™æŠ¥é”™</li>
</ul>
<h5 id="è¯å®ä¸€ä¸‹çŒœæƒ³"><a href="#è¯å®ä¸€ä¸‹çŒœæƒ³" class="headerlink" title="è¯å®ä¸€ä¸‹çŒœæƒ³"></a><strong>è¯å®ä¸€ä¸‹çŒœæƒ³</strong></h5><p>â€‹      </p>
<p>â€‹     </p>
<p>â€‹      </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ClassLoader parent = <span class="keyword">this</span>.getClass().getClassLoader();</span><br><span class="line">log.info(<span class="string">&quot;parent classloader: &#123;&#125;,system:&#123;&#125;&quot;</span>,parent,ClassLoader.getSystemClassLoader());</span><br><span class="line">ClassLoader ucl = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[] &#123;file.toURI().toURL()&#125;, parent);</span><br></pre></td></tr></table></figure>



<p>åªéœ€è¦è¯æ˜ this.getClass().getClassLoader() å’Œ ClassLoader.getSystemClassLoader() ä¸æ˜¯åŒä¸€ä¸ªå°±èƒ½è¯´å¾—é€šäº†</p>
<p>æœ¬åœ°IDEAè·‘èµ·æ¥ï¼Œä¸Šé¢äºŒè€…ç¡®å®ç›¸åŒï¼Œéƒ½æ˜¯AppClassLoaderï¼Œä½†ä»¥java -jarçš„æ–¹å¼è¿è¡Œï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">parent classloader:org.springframework.boot.loader.LaunchedURLClassLoader@<span class="number">7</span>c51f34bï¼Œsystem:sun.misc.Launcher$AppClassLoader@<span class="number">18</span>b4aac2</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>å®è·µ</category>
        <category>ç±»åŠ è½½</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>ç±»åŠ è½½</tag>
      </tags>
  </entry>
</search>
